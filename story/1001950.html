<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>用普罗米修斯·维克多·亚当的博客监控Python烧瓶微服务</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1>用普罗米修斯·维克多·亚当的博客监控Python烧瓶微服务</h1><div class="row"><div class="col-lg-8 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time">2020-05-13 17:16:38</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/d9e68ebfe7718bafe7868ceda171d9f7.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><p>只需几行额外代码就可以很容易地洞察Python Web服务是如何工作的。</p><p>这就是真正的开始！通过添加一个导入和一行来初始化PrometheusMetrics，您将获得在其注册的Flask应用程序的/metrics端点上公开的请求持续时间度量和请求计数器，以及从底层Prometheus客户端库获得的所有默认度量。</p><p>您可以在GitHub存储库中找到一个易于运行的示例，该示例生成一个Prometheus和Grafana实例以及一个演示应用程序来生成一些指标，如下所示：</p><p>您还可以在示例的自述文件中找到仪表板上显示的指标列表，以及填充面板的Prometheus查询。</p><p>该库有很多配置选项，请查看项目自述文件中的示例并进行简要说明。</p><p>基本配置如顶部所示。只需创建一个PrometheusMetrics实例，让我们将其命名为Metrics，然后使用它来定义您希望通过以下方式装饰函数来收集的其他指标：</p><p>计数器对调用进行计数，而其余计数器根据这些调用的持续时间收集度量。您可以为其中的每一个定义标签，可能使用请求或响应的属性。例如：</p><p>从烧瓶导入烧瓶，从prometheus_flask_exporter导入prometheusMetricsapp=flask(__Name__)#按端点分组，而不是按路径度量=prometheusMetrics(app，group_by=&#39；endpoint&#39；)@app.route(&#39；/collection/:collection_id/item/:item_id&#39；)@metrics.counter(&#39；cnt_Collection&#39；，&#39；每个集合的调用次数&#39；，Labels={&#39；集合&#39；：lambda：request.view_args[&#39；Collection_id&#39；]，&#39；status&#39；：lambda resp：res.status_code})def get_item_from_Collection(Collection_id，item_id)：pass</p><p>在上面的示例中，点击端点/Collection/10002/Item/76将增加一个计数器，如cnt_Collection{Collect=&#34；10002&#34；}，另外您将从库中获取默认指标(在本例中为每个端点)，默认情况下：</p><p>flask_http_Request_Duration_Second-按方法、路径和状态列出的所有Flask请求的HTTP请求持续时间(以秒为单位。</p><p>可以选择跳过跟踪某些端点、注册更多默认指标、跳过上述指标或将相同的自定义指标应用于多个端点。请查看项目自述文件，了解可用的内容。</p><p>APP=Flask(__NAME__)指标=PrometheusMetrics(app)@app.route(&#39；/&#39；)def Main()：default@app.route(&#39；/skip&#39；)@metrics.do_not_track()def SKIP()跟踪的PASS#请求数：PASS#不收集默认指标#要应用于多个端点的自定义指标COMMON_COUNTER=metrics.count(&#39；BY_ENDPOINT_COUNTER&#39；，&#39；请求计数(&#39；按端点&#39；，标签={&#39；Endpoint&#39；：lambda：request.endpoint})@app.route(&#39；/common/one&#39；)@common_counterdef Endpoint_One()：自定义跟踪的路径#和默认的metrics@app.route(&#39；/common/two&#39；)@common_counterdef Endpoint_Two()：路径#也由自定义和默认度量跟踪#注册其他默认度量。register_Default(metrics.count(&#39；by_path_count&#39；，&#39；按请求路径的请求计数&#39；，标签={&#39；path&#39；：lambda：request.path})。</p><p>该库为流行的多处理库提供了一些方便的扩展，如uWSGI和Gunicorn。您还可以找到目标用例的小示例，包括这些多处理用例。</p><p>如上所述，默认情况下，库在Flask应用程序上公开一个/metrics端点，该端点可以作为普罗米修斯抓取的目标。</p><p>从上面仪表板的示例中，您可以将普罗米修斯指向具有默认设置的Flask应用程序，配置如下：</p><p>请参阅GitHub存储库中的完整示例。这里假设，Prometheus可以将您的Flask应用程序实例定位在http://app:5000/metrics，上，在那里，应用程序域名可以潜在地解析为多个IP地址，比如在Kubernetes或Docker Sarm中运行时。</p><p>如果这样公开Metrics端点不适合您，可能是因为您不想允许外部访问它，那么您可以在创建PrometheusMetrics实例时通过传递path=None轻松地禁用它。</p><p>然后，您可以使用start_http_server(Port)在不同的HTTP端口(在上例中为5099)上公开此端点。或者，如果您对端点位于相同的Flask应用程序感到满意，但需要更改其路径，而不是/metrics，则可以传入不同的URI作为path参数，或者使用register_end(..)。以后再安排。</p><p>如果你试试看，打开一个GitHub问题或者在这里留下你的反馈和建议的评论！谢谢!</p><div class="text-break sotry_link"><a target="_blank" href="https://blog.viktoradam.net/2020/05/11/prometheus-flask-exporter/">https://blog.viktoradam.net/2020/05/11/prometheus-flask-exporter/</a></div><div class="story_tags"><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/监控/">#监控</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/指标/">#指标</a></button></div></div></div><div class="col-lg-4 col-0"><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>