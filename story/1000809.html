<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>利用Postgres进行地理空间数据分析</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">利用Postgres进行地理空间数据分析</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-06 03:53:49</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/e526cb56ec381f7056c254c0946b7036.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>帕克纳夫的很大一部分业务包括收集停车信息，并验证我们在现实世界中的人工智能街道停车预测。我们的数据收集团队成员使用我们的数据收集应用程序武装自己，步行、骑自行车和开车进城。这款应用程序持续跟踪和记录他们的GPS位置，将其与他们所在的街道进行匹配，并允许输入与他们当前位置相关的不同类型的信息-从停车限制到街道上可用停车点的数量。</p><p>结果，我们在Postgres数据库中得到了大量的GPS位置，每个位置代表我们的收集器在城市中导航时所走的路径上的一个点。随着时间的推移，我们提出了许多查询，使我们能够快速验证和分析这些结果路径，我们认为它们对使用类似数据集的其他人将很有价值。同样的分析也适用于来自逐个转弯导航应用程序、FCD(浮动车数据)、您的跑步/自行车应用程序和许多其他应用程序的数据。</p><p>假设记录的收集器路径上的地理空间数据存储在如下所示的表中：</p><p>CREATE TABLE gpspoint(id uuid约束gpspoint_pkey主键，date_time bigint NOT NULL，GEOM GEOMETRY(point，3857)NOT NULL，path_id UUID NOT NULL，COLLECTER_ID UUID NOT NULL，.)；</p><p>其中date_time以毫秒为单位，表示记录点的日期和时间，geom是具有EPSG：3857投影的笛卡尔几何，path_id是同一收集器路径(TRIP)中所有点的相同ID。</p><p>我们通常使用几何而不是地理来存储地理空间坐标-笛卡尔数学对于我们的用例来说要快得多。这意味着纬度和经度最终被投影到一个平面上，这会导致一些变形，具体取决于所选的投影。对于我们在其中运营的每个城市，我们使用单独的数据库，这使得数据库中任意两点之间的失真非常小，特别是在使用绑定到特定城市或州的“本地”投影，而不是像ESPG：3857(Web墨卡托)这样的全球投影时。但是，这确实会使查询变得稍微复杂一些，如您将在下面看到的。</p><p>通过查看连续GPS点之间的时间和空间距离，我们可以了解哪些路径的GPS记录可能有问题-例如，GPS信号丢失、数据采集器正在通过隧道等。在一个完美的记录中，空间和时间差异都很小，时间越长，遇到的GPS问题就越多。我们的目标是找到任意两个连续GPS点之间的距离或时间差大于正常距离的路径。</p><p>Postgres中的窗口函数在这方面有很大帮助。它们允许我们对表行的分区进行操作(类似于GROUP BY)，但仍保留输出中的所有行，而不是返回一个聚合的输出行。同时，我们可以对分区中的元素进行排序，并获得分区中每一行的相邻行。对于我们来说，分区是自然的-按path_id，因此每个收集器路径最终都在一个单独的分区中。</p><p>我们可以分析整个表，并按连续点之间的最大空间或时间差对路径进行排序，如下所示：</p><p>SELECT MIN(OBS_TIME)：：TIMESTAMP(0)AS STARTED_ON，MAX(OBS_TIME)：：TIMESTAMP(0)AS Finish_ON，ROUND(max(Distance_Delta))AS max_Distance_Delta，max(Time_Delta)/1000 AS max_time_Delta，path_id from(SELECT path_id，to_Timestamp(Date_Time/1000)AS OBS_Time，ST_Distance(geom，lag(Geom)over w)AS Distance_Delta，来自gpspoint窗口的w上的date_time-lag(Date_Time)as time_Delta(as(Partition By Path_Id Order By Date_Time Asc)deltas，其中Distance_Delta&gt；0按路径id分组按最大距离增量描述排序；</p><p>INTERNAL SELECT语句创建相同path_id内的所有点的窗口w-本质上是以记录它们的相同顺序属于同一路径的所有点。这是通过(PARTITION BY PATH_ID ORDER BY DATE_TIME ASC)实现的。然后，我们使用lag()函数获取用于计算每对行之间的空间和时间差的前一行。最后，我们再次按path_id对结果进行分组，并输出路径记录开始的时间、结束的时间以及任意两个连续GPS点之间的最大空间和时间增量。这可以让我们的数据分析师立即查看是否有任何路径存在任何重大问题。</p><p>这里产生的max_Distance_Delta将以EPSG表示：3857“米”。很多时候，它对于内部分析已经足够好了，但是对于需要以实际米为单位报告距离的情况，我们必须计算出笛卡尔投影和ESPG之间的畸变率：4326(纬度/经度)。这可以通过从我们的GPS点表中随机抽取一个点(这是可行的，因为我们每个城市都有一个单独的数据库，这样点就不会散布到世界各地)，在EPSG：4326中将其移动一米，然后查看ESPG：3857中有什么不同。最后，我们将该比率应用于ESPG：3857查询报告的距离，以获得最终结果。</p><p>失真为(SELECT ST_DISTANCE(GEOM，st_Transform(st_project(st_Transform(geom，4326)，1，0)：：Geometry，3857))as m_Distance from gppoint Limit 1)select min(Obs_Time)：：timeamp(0)as start_on，max(Obs_Time)：：timeamp(0)as fined_on，round(max(Distance_Delta/m_Distance))as max_Distance_Delta，max(Time_Delta)/1000。path_id from(select path_id，to_timeamp(date_time/1000)as obs_time，st_Distance(geom，lag(Geom)over w)as Distance_Delta，date_time-lag(Date_Time)over w as time_Delta from gppoint window w as(Partition By Path_Id Order By Date_Time Asc))增量，失真WHERE Distance_Delta&gt；0按路径id分组按最大距离增量描述排序；</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/aiincube-engineering/geospatial-fun-with-trip-data-and-postgres-part-1-310a07b9c431">https://medium.com/aiincube-engineering/geospatial-fun-with-trip-data-and-postgres-part-1-310a07b9c431</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/postgres/">#postgres</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/data/">#data</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/路径/">#路径</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>