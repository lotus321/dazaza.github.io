<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>替换CPython的解析器</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">替换CPython的解析器</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-10 13:41:18</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/7fb638f9cf6507a7566ea857846f3e2a.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>从一开始，Python的语法就是LL(1)：它只需要一个从左到右的解析器，向前看一个标记来解决歧义。标准CPython解析器是由一个简单的自定义解析器生成器生成的。然而，这种简单性是有代价的。首先，官方的Python语法文件没有准确捕获语言。语法允许无效的构造，例如，这个赋值表达式(使用new walrus运算符)：这个表达式是非法的，因为walrus运算符的左侧必须是一个名称，而不是像[x for x in y]这样的任意子表达式。不过，Python的LL(1)解析器的功能不足以强制执行此规则，因此必须在通过特殊情况逻辑(在将解析树转换为抽象语法树(AST)时运行的特殊情况逻辑)进行解析后才能强制执行该规则。更糟糕的是，有一些Python代码是我们想要编写但无法编写的，因为它不能被解析。用-语句括起来看起来很合理，但目前是禁止的：阅读更多2020年Python语言峰会的报道。Guido van Rossum、Pablo Galindo和Lysandros Nikolaou编写了一个新的Python解析器来去除这些缺点，并建议PEP617在CPython中采用它。新的解析器是以更强大的风格编写的，称为解析表达式语法(PEG)，因此该项目被命名为“PEGEN”。当PEG解析器读取可能匹配多个语法规则的令牌序列的开头时，解析器会从左到右尝试每条规则，直到其中一条成功。例如，给定一组规则：解析器首先尝试将规则A应用于其输入序列。如果A成功，解析器将忽略B和C。否则，解析器继续并尝试应用规则B，依此类推。与LL(1)解析器不同，PEG解析器可以根据需要向前看，以消除序列的歧义。语法是确定性的：在多个规则匹配的情况下，最左边的规则获胜。有些序列需要指数级的时间才能找到匹配规则；为了避免这种情况，大多数PEG解析器(包括新的Python解析器)实现了“Packrat”方法来缓存中间结果。PackRAT解析器可以在线性时间内处理任何输入，但会在其缓存上花费一些内存。PEGEN的语法比旧的要清晰得多，并且语法与所有合法的Python程序完全匹配。CPython的旧解析器分阶段进行：记号赋值器向LL(1)解析器提供数据，该解析器生成具体的语法树(CST)，并将其转换为AST。cst阶段是必需的，因为解析器不支持左递归。考虑一下这个表达式：旧解析器的CST太扁平了，正如本幻灯片中的演示者所展示的那样：在现实生活中，表达式将在运行时通过首先将a加到b，然后添加c来计算。不幸的是，CST不对此嵌套计算进行编码，因此LL(1)解析器必须第二次转换程序以将CST转换为适当嵌套形式的AST，然后可以生成字节码。另一方面，PEGEN直接生成AST。根据程序的不同，PEGEN可能会使用更多或更少的内存：它在PackRat方法上花费的钱，可以通过跳过CST来节省。Emily Morehouse针对旧解析器测试了PEGEN，方法是验证它们为标准库中的每个模块和前3800个PyPI包生成相同的AST。(PEGEN解析标准库的速度略快于旧解析器，但使用的内存多10%。)。一旦Python有了非LL(1)解析器，其语法可能会变得更加复杂；Victor Stner询问第三方Python解析器(如linters和IDE)是否会有困难。van Rossum确信，如果有必要，他们自己可以采用更强大的解析器。作者计划谨慎地将CPython切换到新的解析器。在Python3.9alpha6中，新的解析器将选择加入；它将成为Beta1和官方3.9版本中的默认解析器，旧的解析器仍然可以通过命令行开关使用。一旦启用了新的解析器，将允许使用带括号的-语句！在Python3.10中，旧的解析器将被删除。然而，PEP617仍然必须得到批准，新的规范需要最后的审查。这项提议没有遭到反对；事实上，观众中的几个人询问它是否可以更早成为违约。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://pyfound.blogspot.com/2020/04/replacing-cpythons-parser-python.html">https://pyfound.blogspot.com/2020/04/replacing-cpythons-parser-python.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/python/">#python</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/cpython/">#cpython</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/解析器/">#解析器</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1000786.html"><img src="http://img.diglog.com/img/2020/5/thumb_ec4a7ac484cb7478d106dfebd01eb16a.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1000786.html">如何使用Python获取股票基本面数据</a></div><span class="my_story_list_date">2020-5-6 0:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1000731.html"><img src="http://img.diglog.com/img/2020/5/thumb_b5d0f1167a86fdbbb8945644fc4c54f6.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1000731.html">Python Goto实现系统跟踪功能(2017)</a></div><span class="my_story_list_date">2020-5-5 19:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1000566.html"><img src="http://img.diglog.com/img/2020/5/thumb_dfdc1e7d0f5e0048d98bd9a7f0a5dea9.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1000566.html">再见蟒蛇。你好，朱莉娅</a></div><span class="my_story_list_date">2020-5-4 16:8</span></div><div class="col-sm"><div><a target="_blank" href="/story/1000550.html"><img src="http://img.diglog.com/img/2020/5/thumb_b1e61c67eb6a9b28e9172e8ddf6994af.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1000550.html">Windows 10有重定向到Windows应用商店的假“Python”命令</a></div><span class="my_story_list_date">2020-5-4 8:35</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>