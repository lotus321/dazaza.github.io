<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>最大限度地减小锈蚀二进制大小</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">最大限度地减小锈蚀二进制大小</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-12 15:40:41</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/6/ac9f4c327b4c071690318813517ad97c.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>默认情况下，Rust针对执行速度而不是二进制大小进行优化，因为这对于绝大多数应用程序来说是理想的。但是对于开发人员想要针对二进制大小进行优化的情况，Rust提供了实现这一目标的机制。</p><p>默认情况下，Cargo Build在调试模式下构建Rust二进制文件。调试模式禁用许多优化，这有助于调试器(以及运行它们的IDE)提供更好的调试体验。调试二进制文件可以比发布二进制文件大30%或更多。</p><p>在Linux和MacOS上，默认情况下，元件信息包含在编译的.elf文件中。正确执行二进制文件不需要此信息。要删除此信息，请对.elf文件运行strip：</p><p>对于发布版本，Cargo将其优化级别默认为3，这将优化二进制文件的速度。要指示Cargo优化为最小二进制大小，请使用Cargo.toml中的z优化级别：</p><p>默认情况下，Cargo指示单独编译和优化编译单元。LTO指示链接器在链接阶段进行优化。例如，这可以删除死代码，并且通常会减小二进制大小。</p><p>从Rust 1.32开始，默认情况下会删除jemalloc。如果使用Rust 1.32或更高版本，则不需要执行任何操作来减小与此功能相关的二进制大小。</p><p>在Rust 1.32之前，为了提高某些平台上的性能，Rust捆绑了jemalloc，这是一个性能经常优于默认系统分配器的分配器。但是，捆绑jemalloc在生成的二进制文件中增加了大约200KB。</p><p>要删除Rust 1.28-Rust 1.31上的jemalloc，请将以下代码添加到main.rs的顶部：</p><p>默认情况下，Cargo为发布版本指定了16个并行编解码器单元，这缩短了编译时间，但阻止了某些优化。</p><p>注意：到目前为止，所讨论的减小二进制大小的特性对程序的行为没有影响(只影响它的执行速度)。此功能对行为没有影响。</p><p>默认情况下，当Rust代码遇到必须调用Panic！()的情况时，它会展开堆栈并生成有用的回溯。然而，展开代码确实需要额外的二进制大小。可以指示rustc立即中止，而不是展开，这样就不需要额外的展开代码了。</p><p>注意：Xargo目前处于维护状态，但最终下面使用的功能应该会应用到货物中。</p><p>Rust附带了标准库(Libstd)的预构建副本及其工具链。这意味着开发人员不需要在每次构建应用程序时都构建libstd。相反，libstd静态链接到二进制文件。</p><p>虽然这非常方便，但如果开发人员试图积极优化大小，也有几个缺点。</p><p>无法删除特定应用程序中未使用的部分libstd(例如LTO和死机行为)。</p><p>这就是萨尔戈的用武之地。Xargo能够从源代码用您的应用程序编译libstd。它通过rustup方便地提供的ruust-src组件来实现这一点。</p><p>将Xargo.toml文件添加到项目的根目录(这不会取代Cargo.toml，只是补充)：</p><p>$rustup工具链夜间安装$rustup覆盖设置夜间$rustup组件添加rust-src$Cargo安装xargo。</p><p>#查找您的主机的目标三重。$rustc-vv.主机：x86_64-apple-darwin#使用Xargo构建时使用目标三元组。$xargo build--target x86_64-apple-Darwin--release。</p><p>记住要去掉生成的可执行文件。在MacOS上，最终的二进制大小减少到51KB。</p><p>即使在Cargo.toml中指定了Panic=ABORT，默认情况下，rustc仍然会在最终二进制文件中包含恐慌字符串和格式化代码。已将不稳定的PARGIC_IMMEDIATE_ABORT功能合并到夜间rustc编译器中以解决此问题。</p><p>要使用此命令，请重复上述说明以使用Xargo，但请改用以下Xargo.toml：</p><p>记住要去掉生成的可执行文件。在MacOS上，最终的二进制大小减少到30KB。</p><p>到目前为止，我们还没有限制从libstd使用的实用程序。在本节中，我们将限制libstd的使用，以进一步减小二进制大小。</p><p>如果您想要小于20KB的可执行文件，则必须删除Rust的字符串格式化代码CORE：：FMT。PARGIC_IMMEDIATE_ABORT仅删除此代码的某些用法。在某些情况下，还有很多其他代码使用格式化。这包括libstd中的Rust&#39；s&34；Pre-Main代码。</p><p>通过使用C入口点(通过添加#！[NO_MAIN]属性)，手动管理stdio，并仔细分析您或您的依赖项包括哪些代码块，您有时可以利用libstd，同时避免臃肿的core：：fmt。</p><p>预计代码将是粗制滥造和不可移植的，具有比平常更多的不安全{}。感觉像是no_std，但是有libstd。</p><p>从一个空的可执行文件开始，确保xargo膨胀--发布--目标=.。不包含core：：fmt或有关填充的内容。添加(取消注释)一点。看到那个沙戈肿胀现在报道的更多了。查看您刚刚添加的源代码。可能使用了一些外部机箱或新的libstd函数。在您的审查过程中递归到这一点(它需要[替换]货物依赖项，可能还需要挖掘libstd)，找出为什么它比应有的重量更重。选择替代方式或补丁依赖，以避免不必要的功能。取消注释更多的代码，调试爆炸大小的xargo膨胀，等等。</p><p>在此之前，我们的应用程序使用的是Rust标准库libstd。libstd提供了许多方便的、经过良好测试的跨平台API和数据类型。但是，如果用户想要将二进制大小减少到等效的C程序大小，则可以只依赖libc。</p><p>了解这种方法有很多缺点是很重要的。首先，您可能需要编写很多不安全的代码，并且无法访问大多数依赖libstd的铁锈碎屑。不过，这是减小二进制大小的一种(尽管极端)选择。</p><p>#！[no_std]#！[no_main]extern crate libc；#[no_manger]pub extern&#34；C&#34；fn main(_argc：isize，_argv：*const*const U8)-&gt；isize{//因为我们传递的是C字符串，所以最后一个空字符是必需的。const Hello：&amp；&39；static str=&#34；Hello，world！\n\0&#34；；unsafe{libc：：printf(Hello。as_ptr()as*const_)；}0}#[PARGIC_HANDLER]FN MY_PARGIC(_INFO：&AMP；CORE：：PARGIC：：PanicInfo)-&gt；！{loop{}}</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/johnthagen/min-sized-rust">https://github.com/johnthagen/min-sized-rust</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/减小/">#减小</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/libstd/">#libstd</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1006196.html"><img src="http://img.diglog.com/img/2020/6/thumb_63a3a8aed338e06b11b8f195bda16aa5.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006196.html">针对谷歌的反垄断案</a></div><span class="my_story_list_date">2020-6-12 4:28</span></div><div class="col-sm"><div><a target="_blank" href="/story/1006191.html"><img src="http://img.diglog.com/img/2020/6/thumb_61d4623ee68da2c11cbf207d73a60371.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006191.html">亚马逊将因对待第三方卖家在欧盟面临反垄断指控</a></div><span class="my_story_list_date">2020-6-12 4:9</span></div><div class="col-sm"><div><a target="_blank" href="/story/1006145.html"><img src="http://img.diglog.com/img/2020/6/thumb_aa3947824b12e18bf53463c700514bf1.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006145.html">报道称，欧盟将就第三方卖家待遇对亚马逊提出反垄断指控</a></div><span class="my_story_list_date">2020-6-11 23:38</span></div><div class="col-sm"><div><a target="_blank" href="/story/1006133.html"><img src="http://img.diglog.com/img/2020/6/thumb_7c413cc9be708f7e1eb67aa436b6349d.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006133.html">亚马逊将因对待第三方卖家面临欧盟反垄断指控</a></div><span class="my_story_list_date">2020-6-11 21:50</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>