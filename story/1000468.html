<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>英特尔虚拟化：VT-X、KVM和QEMU如何协同工作</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1>英特尔虚拟化：VT-X、KVM和QEMU如何协同工作</h1><div class="row"><div class="col-lg-8 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time">2020-05-03 17:50:34</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/659e9daa7b785687fdfb264fccd82cbc.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><p>VT-x是英特尔CPU虚拟化技术的名称。KVM是使用VT-x的Linux内核的组成部分。QEMU是一个用户空间应用程序，允许用户创建虚拟机。QEMU利用KVM实现高效的虚拟化。在本文中，我们将讨论这三种技术如何协同工作。不要期望在这里对所有方面都进行深入的阐述，尽管在未来，我可能会在后面发布一些关于某些特定部分的更有针对性的帖子。</p><p>在进入主要讨论之前，让我们先谈谈一些理论。与虚拟化相关的是仿真概念-简单地说，就是伪造硬件。当您使用QEMU或VMWare创建具有ARM处理器的虚拟机，但您的主机具有x86处理器时，QEMU或VMWare将模拟或伪造ARM处理器。当我们谈论虚拟化时，我们指的是其中VM的处理器与主计算机的处理器相匹配的硬件辅助虚拟化。经常与……混为一谈。</p><p>最底层是支持虚拟化的硬件。其上方是虚拟机管理程序或虚拟机监视器(VMM)。对于KVM，这实际上是加载了KVM模块的Linux内核。换句话说，KVM是一组内核模块，当加载到Linux内核中时，它们会将内核转变为虚拟机管理程序。在虚拟机管理程序上方和用户空间中，位于最终用户直接交互的虚拟化应用程序-QEMU、VMWare等。这些应用程序然后创建虚拟机，这些虚拟机.。</p><p>最后，存在“完全”和“部分”虚拟化的二分法。完全虚拟化是指在虚拟机内运行的操作系统与在真实硬件上运行的操作系统完全相同。半虚拟化是指VM内的操作系统意识到它正在被虚拟化，因此运行方式比在真实硬件上稍有修改。</p><p>VT-x是针对Intel 64和IA-32体系结构的CPU虚拟化。英特尔的安腾有VT-I。对于I/O虚拟化，有VT-d。AMD还拥有名为AMD-V的虚拟化技术。我们只关心VT-x。</p><p>在VT-x下，CPU以两种模式之一运行：根模式和非根模式。这些模式与实数、保护、长整型等正交，也与特权环(0-3)正交。可以说，它们组成了一架新的“飞机”。虚拟机管理程序在根模式下运行，而虚拟机在非根模式下运行。在非根模式下，CPU受限代码的执行方式大多与在根模式下运行时相同，这意味着VM的CPU受限操作主要以本机速度运行。然而，它并不拥有完全的自由。</p><p>特权指令构成CPU上所有可用指令的子集。这些指令仅在CPU处于较高特权状态时才能执行，例如当前特权级别(CPL)0(其中CPL 3是最低特权)。这些特权指令的一个子集就是我们所说的“全局状态改变”指令--那些影响CPU整体状态的指令。例如，那些修改时钟或中断寄存器或写入控制寄存器的指令……。</p><p>虚拟机扩展(VMx)是为促进VT-x而添加的指令。让我们看看其中的一些，以便更好地理解VT-x是如何工作的。</p><p>VMXON：在执行此指令之前，没有根模式与非根模式的概念。CPU的运行方式就像没有虚拟化一样。必须执行VMXON才能进入虚拟化。紧接VMXON之后，CPU处于根模式。</p><p>VMLAuncH：创建VM的实例并进入非根模式。我们将在稍后介绍VMCS时解释我们所说的“VM实例”是什么意思。现在，可以将其视为在QEMU或VMWare中创建的特定VM。</p><p>当VM尝试执行在非根模式下被禁止的指令时，CPU会立即以类似陷阱的方式切换到根模式。这称为VM退出。</p><p>让我们把上面的信息综合起来。CPU在正常模式下启动，执行VMXON以根模式启动虚拟化，执行VMLAuncH以创建并进入VM实例的非根模式，VM实例运行其自己的代码，就像在本地运行一样，直到它尝试某些被禁止的操作，从而导致VM退出并切换到根模式。回想一下，在根模式下运行的软件是虚拟机管理程序。虚拟机管理程序采取行动处理VM退出的原因，然后执行VMRESUME.。</p><p>当然，上面的描述留下了一些空白。例如，虚拟机管理程序如何知道发生VM退出的原因？一个VM实例与另一个VM实例有什么不同之处？这就是VMCS的用武之地。VMCS代表虚拟机控制结构。它基本上是物理内存的4KiB部分，其中包含上述进程工作所需的信息。此信息包括VM退出的原因以及每个VM实例的唯一信息，以便在CPU处于非根模式时.。</p><p>正如您可能知道的，在QEMU或VMWare中，我们可以决定特定虚拟机将拥有多少个CPU。每个这样的CPU都称为虚拟CPU或VCP</p><div class="text-break sotry_link"><a target="_blank" href="https://binarydebt.wordpress.com/2018/10/14/intel-virtualisation-how-vt-x-kvm-and-qemu-work-together/">https://binarydebt.wordpress.com/2018/10/14/intel-virtualisation-how-vt-x-kvm-and-qemu-work-together/</a></div><div class="story_tags"><button type="button" class="btn btn-light my_tag"><a href="/tag/虚拟化/">#虚拟化</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/英特尔/">#英特尔</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/vm/">#vm</a></button></div></div></div><div class="col-lg-4 col-0"><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button></div></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>