<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>逗号运算符(C++)的微妙危险</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">逗号运算符(C++)的微妙危险</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-30 15:03:51</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/5987a0123b9c8e9a7fa6c0d639646f76.jpeg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>乔纳森·博卡拉(Jonathan Boccara)写的，但就像一位同时也是超级英雄叔叔的哲学家曾经说过的那样，权力越大，责任就越大。</p><p>翻译成C++，这意味着如果您不小心，一些让您编写富于表现力的代码的C++功能可能会掉头并产生错误代码，而这些代码并没有做它应该做的事情。</p><p>一个很好的例子(美丽的一些定义)是逗号操作符的重载。正如我们将要看到的，工作代码中一个非常细微的变化就会使它变得非常错误。</p><p>首先，逗号操作符是一个东西。它对所有类型的默认实现都是这样做的：a，b计算a，然后计算b，然后返回b。例如，1，2返回2。</p><p>通常不推荐这样做，但是C++允许重载逗号操作符。下面是一篇关于重载逗号操作符的详细文章，您可以阅读该文章以更好地了解该主题。</p><p>重载逗号操作符可以让我们做一些好事。例如，这是Boost Assign用来允许我们将数据追加到现有向量中的内容：</p><p>如果不重载逗号运算符，我们就不能用标准C++编写此表达式，即使在C++20中也是如此。一旦构造了向量，我们只能使用PUSH_BACK成员函数逐个添加元素。</p><p>前面的代码允许我们用非常有表现力的代码向现有向量添加元素。</p><p>下面是Boost Assign的一个非常简化的实现，它允许我们编写前一行代码(感谢此实现的Nope)：</p><p>Template&lt；TypeName Vector&gt；struct{Vector&amp；vec；Template&lt；TypeName T&gt；Appder&lt；Vector&gt；Operator，(const T&amp；e){vec.Push_back(E)；return*this；}}；Template&lt；TypeName T&gt；Appder&lt；std：：Vector&lt；T&gt；&gt；Operator+=(STT。e){v.push_back(E)；return{v}；}int(){auto data=std：：Vector&lt；int&gt；{}；data+=1，2，3，4，5；对于(auto&amp；&amp；e：data)std：：cout&lt；&lt；&#39；&lt；&lt；e；std：：cout&lt；&lt；&#39；\n。</p><p>附加器重载逗号运算符。当此附加器与2关联时，它会将其添加到向量中并返回自身。</p><p>然后，附加器与3相关联并将其添加，然后是4，然后是5。</p><p>现在，让我们对我们的代码做一点小小的修改。让我们将逗号操作符定义为自由函数，而不是将其定义为成员函数。例如，这可能是可取的，因为它允许隐式转换，如Efficient C++的第24项中所述。</p><p>Template&lt；TypeName Vector&gt；struct{Vector&amp；vec；}；Template&lt；TypeName Vector，TypeName T&gt；Appder&lt；Vector&gt；&amp；Operator，(Appder&lt；Vector&gt；&amp；v，Const T&amp；e){v.vec.Push_back(E)；return v；}Template&lt；TypeName T&gt；Appder&lt；ST.。v，const T&amp；e){v.ush_back(E)；return{v}；}int(){auto data=std：：Vector&lt；int&gt；{}；data+=1，2，3，4，5；对于(auto&amp；&amp；e：data)std：：cout&lt；&lt；&#39；&39；&lt；&lt；e；std：：cout&lt；&ld。</p><p>如果你和我一样，你会难以置信地盯着屏幕。如果你想亲眼看看，就运行能运行的程序和不能运行的程序。</p><p>也许最糟糕的是它会编译，而不是它没有我们自然期望的行为。你能明白为什么会发生这种事吗？</p><p>说真的，试着自己找出哪里出了问题。我稍后会告诉你，但你自己去找会更有趣、更有价值。</p><p>你在用手机，不方便吗？请不要担心，请将此页面加入书签或通过电子邮件发送给您自己，这样您可以稍后在计算机上返回该页面。</p><p>这个问题与左值和右值有关。如果我们再看一下自由函数运算符，它会将左值引用作为输入：</p><p>数据+=1是右值。左值引用不能绑定到它。因此，不会调用逗号运算符的此重载。</p><p>如果它是任何其他运算符，代码就不会编译。但是，正如我们在本文开头看到的，逗号操作符对所有类型都有一个默认实现。因此，执行默认实现-返回第二个元素，这里是2。然后返回3，然后是4，然后是5。而且它实际上没有做任何事情。</p><p>不正确地重载逗号运算符会导致静默失败。代码可以编译、运行，但不会执行您想要的操作。</p><p>要使此实现正常工作，我们需要提供可以接受r值的逗号操作符的重载：</p><p>Template&lt；TypeName Vector，TypeName T&gt；Appder&lt；Vector&gt；&amp；Operator，(Appder&lt；Vector&gt；&amp；v，const T&amp；e){v.Vector_back(E)；return v；}Template&lt；TypeName Vector，TypeName T&gt；Appder&lt；Vector&gt；&amp；Operator，(Appder&lt；Vector&gt(E)；return v；}Template&lt；TypeName Vector，TypeName T&gt；Appder&lt；Vector&gt；&amp；Operator，(Appder&lt；Vector&gt。返回v；}</p><p>要在我们的示例中使用它，我们需要返回附加器的副本，以便常量引用可以绑定到它。在我们的示例中，这仍然会附加到向量中，因为附加器的各种副本将包含对同一向量的引用(感谢Patrice Dalesme向我展示了这个解决方案)：</p><p>第一个是，如果我们重载逗号操作符，我们需要格外小心地涵盖所有情况，并考虑左值和右值。否则，我们最终会得到错误代码。</p><p>第二个独立于逗号运算符。我们看到，在C++中，成员函数比自由函数更容易定义。默认情况下，成员函数是为类型的左值和右值引用定义的，而接受引用的自由函数可能只适用于一种情况。</p><p>也存在相反的情况(为左值或右值显式定义的成员函数，以及通过复制或常量引用获取的自由函数)，但最常见的原型具有我们前面讨论过的属性。</p><p>Jonathan Boccara是C++软件工程负责人、博客作者和作家，专注于如何使代码具有表现力。他的博客是流畅的C++。</p><p>布尔玛是一位多才多艺的自由插画家，风格古怪，五颜六色。布尔玛热爱动画，主要为运动图形做插图，利用她的创造力帮助品牌讲述故事。布尔马来自立陶宛，曾在英国学习和工作，现在马耳他享受着岛屿生活。在那里，她学会了游泳，并更深入地从事插图工作。布尔玛一直在寻找新的挑战和机遇。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://humanreadablemag.com/issues/3/articles/the-subtle-dangers-of-the-comma-operator">https://humanreadablemag.com/issues/3/articles/the-subtle-dangers-of-the-comma-operator</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/c++/">#c++</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/运算符/">#运算符</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/dangers/">#dangers</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1003761.html"><img src="http://img.diglog.com/img/2020/5/thumb_5c90dbc8eaee9e115a72c261fa65530a.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003761.html">Plywood：一种新的跨平台开源C++框架</a></div><span class="my_story_list_date">2020-5-26 13:22</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003690.html"><img src="http://img.diglog.com/img/2020/5/thumb_ac90d32b417868cfe0d109c0677b8187.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003690.html">用C++实现的SmallTalk-80</a></div><span class="my_story_list_date">2020-5-25 23:15</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003682.html"><img src="http://img.diglog.com/img/2020/5/thumb_ac90d32b417868cfe0d109c0677b8187.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003682.html">Dbanay/Smalltalk-“by the Blue book”C++Implementation of Smalltalk-80</a></div><span class="my_story_list_date">2020-5-25 21:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003557.html"><img src="http://img.diglog.com/img/2020/5/thumb_4d16095418a953c639be9666b70f5aac.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003557.html">用C++实现简单的协作线程</a></div><span class="my_story_list_date">2020-5-25 3:21</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>