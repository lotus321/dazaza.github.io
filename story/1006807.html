<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>NETGEAR 79台设备的0天漏洞分析和利用</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">NETGEAR 79台设备的0天漏洞分析和利用</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-16 21:04:59</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/6/f6ca0df7d33dfed07f101223c77772b0.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>NETGEAR R7000经过一天的辛勤研究，放松、放松、轻松地做一些事情，这是一件很有趣的事情。虽然与10-15年前相比，现代软件开发流程极大地提高了商业软件的质量，但消费者网络设备在很大程度上被甩在了后面。因此，当需要一些快速乐趣和良好的信心提升时，我喜欢分析SOHO设备。本博客描述了一个这样的会话，即审核Netkit R7000路由器、分析由此产生的漏洞，以及随后的利用漏洞开发过程。在我们的NotQuite0Day星期五存储库中可以找到这篇博客文章中描述的漏洞的记录和代码。</p><p>分析SOHO设备的第一步是获取固件。值得庆幸的是，Netkit的支持网站提供了R7000的所有固件。本博客文章中使用的Netkit R7000版本1.0.9.88固件可从该网站下载。在解压缩固件之后，我们将使用binwalk从固件映像中提取根文件系统：虽然路由器可能有许多值得分析的服务，但Web服务器通常最有可能包含漏洞。在像R7000这样的SOHO设备中，Web服务器必须解析来自网络的用户输入，并运行使用该输入的复杂CGI功能。此外，Web服务器是用C语言编写的，几乎没有经过测试，因此它经常容易受到微不足道的内存损坏错误的攻击。因此，我决定从分析Web服务器httpd开始。由于我们对Web服务器(Mis)如何处理用户输入很感兴趣，因此开始分析Web服务器的逻辑位置是jrecv函数。该函数用于从连接中检索用户输入。因此，通过查看Web服务器中对Recv函数的引用，我们可以看到用户输入从哪里开始。Web服务器具有两个调用RECV的助手函数，一个在HTTP解析器中使用，另一个用于读取从动态DNS请求到oemdns.com的响应。我们将重点介绍前一种用法，如Hex-Rays反编译器中所示：在调用READ_CONTENT函数(crecv_helper函数)之后，解析器会执行一些错误检查，将接收到的内容与之前接收到的任何内容组合在一起，然后在用户输入中查找字符串：name=&#34；mtenFWUpload&#34；和&#34；\r\n\r\n&#34；，然后在用户输入中查找字符串：name=&#34；mtenFWUpload&#34；和&#34；\r\n\r\n&#34；。如果用户输入包含这些字符串，则这些字符串之后的用户输入的其余部分将传递给JabCheckBoardID函数。抓取固件的根文件系统，我们可以看到字符串“mtenFWUpload”是从文件www/upg_upgrade.htm和www/Modem_upgrade.htm中引用的，因此我们可以得出结论，这是路由器升级功能的一部分。</p><p>在用户输入之后，我们接下来来看一下AabCheckBoardID函数。此函数如下所示，预期用户输入为R7000的CHK固件文件。它解析用户输入以验证魔术值(字节0-3)，获得报头大小(字节4-7)和校验和(字节36-49)，然后将报头复制到堆栈缓冲区。此副本通过memcpy函数执行，使用用户输入中指定的大小。因此，堆栈缓冲区溢出是微不足道的。在大多数现代软件中，此漏洞是无法利用的。现代软件通常包含可防止攻击的堆栈cookie。但是，R7000不使用堆栈cookie。事实上，在所有共享公共代码库的Netkit产品中，只有D8500固件版本1.0.3.29和R6300v2固件版本1.0.4.12-1.0.4.20使用堆栈cookie。但是，更高版本的D8500和R6300v2停止使用堆栈Cookie，使得此漏洞再次被利用。与其他现代软件相比，这只是SOHO设备安全性落后的又一个例子。</p><p>除了缺少堆栈cookie之外，Web服务器也没有编译为位置无关的可执行文件(PIE)，因此不能充分利用ASLR。因此，在.httpd二进制文件中找到一个ROP小工具(如下面显示的那个)很容易，该小工具将使用从溢出堆栈获取的命令调用系统小工具。Grimm的NotQuite0Day星期五资料库中的漏洞利用此小工具以超级用户身份启动telnet守护程序，监听TCP端口8888，不需要密码即可登录。由于该漏洞发生在检查跨站点请求伪造(CSRF)令牌之前，因此也可以通过CSRF攻击来利用此漏洞。如果使用易受攻击的路由器的用户浏览到恶意网站，该网站可能会利用该用户的路由器进行攻击。开发的利用漏洞攻击通过向目标设备提供向目标设备发送包含利用漏洞攻击的AJAX请求的HTML页面来展示此功能。但是，由于CSRF网页无法从目标服务器读取任何响应，因此无法远程对设备进行指纹识别。相反，攻击者必须知道他们正在利用的型号和版本，</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.grimm-co.com/2020/06/soho-device-exploitation.html?m=1">https://blog.grimm-co.com/2020/06/soho-device-exploitation.html?m=1</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/漏洞/">#漏洞</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/day/">#day</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/函数/">#函数</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1006293.html"><img src="http://img.diglog.com/img/2020/6/thumb_e634e95f1e912d5f08613c60290f6d19.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006293.html">UPnP漏洞使数百万网络设备面临互联网攻击</a></div><span class="my_story_list_date">2020-6-12 23:43</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005730.html"><img src="http://img.diglog.com/img/2020/6/thumb_d9bf08a4d87fee196550f834553ea1da.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005730.html">思科警告：IOS路由器中的严重缺陷允许完全系统受损</a></div><span class="my_story_list_date">2020-6-9 2:1</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005698.html"><img src="http://img.diglog.com/img/2020/6/thumb_83e1ae36389b1bd9e8b0b4f4e7c2711b.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005698.html">广受欢迎的开源项目中的漏洞在2019年翻了一番</a></div><span class="my_story_list_date">2020-6-8 22:29</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005545.html"><img src="http://img.diglog.com/img/2020/6/thumb_d4cf1f07ebe9afa408575ae5e5e6dc7c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005545.html">Zoom中的两个漏洞可能导致代码执行</a></div><span class="my_story_list_date">2020-6-7 16:43</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>