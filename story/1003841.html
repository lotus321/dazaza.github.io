<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>面向C++·V8的高性能垃圾回收</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">面向C++·V8的高性能垃圾回收</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-27 05:02:38</div><div class="page_narrow text-break page_content"><p>在过去，我们已经写过关于JavaScript的垃圾收集、文档对象模型(DOM)，以及如何在V8中实现和优化所有这些内容。不过，Chromium中并不是所有的东西都是JavaScript，因为嵌入了V8的浏览器及其Blink渲染引擎的大部分都是用C++编写的。JavaScript可用于与DOM交互，然后由呈现管道处理该DOM。因为DOM周围的C++对象图与Javascript对象纠缠在一起，Chromium团队在几年前就转而使用称为OilPan的垃圾收集器来管理这种内存。OilPan是一个用C++编写的垃圾收集器，用于管理C++内存，它可以使用跨组件跟踪连接到V8，跨组件跟踪将纠结的C++/JavaScript对象图视为一个堆。这篇文章是Oilpan一系列博客文章中的第一篇，这些文章将概述Oilpan语言及其C++API的核心原理。在这篇文章中，我们将介绍一些受支持的特性，解释它们如何与垃圾收集器的各个子系统交互，并深入研究在清扫器中并发回收对象。最令人兴奋的是，OilPan目前在Blink中实现，但将以垃圾收集库的形式迁移到V8。我们的目标是让所有V8嵌入者和更多的C++开发人员都可以轻松地使用C++垃圾回收。OilPan实现了标记-清除垃圾收集器，其中垃圾收集分为两个阶段：标记在哪里扫描托管堆中的活动对象，以及在哪里清理托管堆上的死对象被回收。在V8中引入并发标记时，我们已经介绍了标记的基础知识。简单地说，扫描所有对象中的活动对象可以看作是图的遍历，其中对象是节点，对象之间的指针是边。遍历从寄存器、本机执行堆栈(从现在起我们将称之为堆栈)和其他全局变量的根开始，如下所述。在这方面，C++与JavaScript没有什么不同。不过，与JavaScript不同的是，C++对象是静态类型的，因此不能在运行时更改其表示形式。使用OilPan管理的C++对象利用这一事实，并通过访问者模式提供指向其他对象(图中的边)的指针的描述。描述油底壳对象的基本模式如下：class final：public GarbageCollect&lt；LinkedNode&gt；{public：LinkedNode(LinkedNode*Next，int value)：Next_(Next)，value_(Value){}void Trace(Visitor*Visitor)const{Visitor-&gt；Trace(Next_)；}Private：Member&lt；LinkedNode&gt；Next_；int value_；}；LinkedNode*CreateNodes(){LinkedNode*First_Node=MakeGarbageCollect&lt；LinkedNode&&gt;(nullptr，1)；LinkedNode*Second_Node=MakeGarbageCollect&lt；LinkedNode&gt；(First_Node，2)；return Second_Node；}。</p><p>在上面的示例中，LinkedNode由OilPan管理，如从GarbageCollect&lt；LinkedNode&gt；继承所示。当垃圾回收器处理对象时，它通过调用该对象的Trace方法来发现传出指针。类型成员是语法上类似于STD：：SHARED_PTR的智能指针，后者由Oilspan提供，用于在标记期间遍历图形时保持一致状态。所有这些都使OilPan能够精确地知道指针驻留在其托管对象中的什么位置。狂热的读者可能会注意到并且可能会害怕，在上面的示例中，first_node和Second_node被保留为堆栈上的原始C++指针。Oilspan不添加使用堆栈的抽象，仅依靠保守的堆栈扫描在处理根时查找指向其托管堆的指针。这是通过逐字迭代堆栈并将这些字解释为指向托管堆的指针来实现的。这意味着OilPan不会对访问堆栈分配的对象施加性能损失。相反，它将成本转移到垃圾收集时间，在那里它保守地扫描堆栈。集成在呈现器中的Oilpan会尝试延迟垃圾收集，直到它达到保证没有有趣堆栈的状态。由于Web是基于事件的，并且执行是由事件循环中的处理任务驱动的，因此这样的机会非常多。Blink是一个拥有大量成熟代码的大型C++代码库，因此也支持：通过混合和对此类混合(内部指针)的引用实现多重继承。在执行构造函数期间触发垃圾回收。通过被视为根的持久智能指针使非托管内存中的对象保持活动状态。覆盖顺序(例如，矢量)和关联(例如，集合和映射)容器的集合，具有集合背景的压缩。</p><p>请继续关注另一篇博客文章，详细介绍油底锅打标的工作原理。对于这篇文章，我们</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://v8.dev/blog/high-performance-cpp-gc">https://v8.dev/blog/high-performance-cpp-gc</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/c++/">#c++</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/性能/">#性能</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/对象/">#对象</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1003761.html"><img src="http://img.diglog.com/img/2020/5/thumb_5c90dbc8eaee9e115a72c261fa65530a.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003761.html">Plywood：一种新的跨平台开源C++框架</a></div><span class="my_story_list_date">2020-5-26 13:22</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003690.html"><img src="http://img.diglog.com/img/2020/5/thumb_ac90d32b417868cfe0d109c0677b8187.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003690.html">用C++实现的SmallTalk-80</a></div><span class="my_story_list_date">2020-5-25 23:15</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003682.html"><img src="http://img.diglog.com/img/2020/5/thumb_ac90d32b417868cfe0d109c0677b8187.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003682.html">Dbanay/Smalltalk-“by the Blue book”C++Implementation of Smalltalk-80</a></div><span class="my_story_list_date">2020-5-25 21:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003557.html"><img src="http://img.diglog.com/img/2020/5/thumb_4d16095418a953c639be9666b70f5aac.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003557.html">用C++实现简单的协作线程</a></div><span class="my_story_list_date">2020-5-25 3:21</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>