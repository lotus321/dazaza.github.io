<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>天气控件逆向工程和自动化</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">天气控件逆向工程和自动化</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-17 23:21:38</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/6/c0678717f3a086b77f51503c5326fb9e.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>这个条目是我上周一直在做的一个有趣的小项目。这本书没有什么特别或开创性的，但我希望你能从中获得一些乐趣。</p><p>我们想要添加到MadBoulder网站的功能之一(项目的简短描述在末尾)是，对于每个涉及登山区的页面，都有一个天气小部件，它提供该地区的天气状况和天气预报的信息。这些信息在计划户外活动时总是很有用的。</p><p>添加该功能的两种最明显的方法要么是查询天气API并开发一个很好的布局来显示所提供的信息，要么是在页面中包含一个即用即用的小部件。因为第二个看起来更直截了当，工作量更少，所以我决定走这条路。</p><p>在研究了不同的选项之后，我决定使用WeatherWidget.io提供的小部件。不需要注册，也不需要提供电子邮件，我喜欢它的样子，但-不是UI的人，但我认为-它符合网站的感觉，而且很容易设置。</p><p>在决定使用哪个小部件之后，就可以为所有受支持的区域生成小部件，并将它们添加到相应的页面。最常见的方法是导航到将从中获取小部件的页面，引入所需位置，生成小部件代码，然后将其复制并粘贴到网页中的所需位置。</p><p>这很简单，如果你只需要几个小部件，也不会有太大的麻烦，但是重复这个过程3次之后，就会变得相当乏味和乏味。我们目前有60个受支持的领域，而且名单还在不断增加。我不想手动生成每个小部件。理想情况下，我希望能够从当前区域列表中自动生成小部件，这是我们已经拥有的功能。</p><p>为了避免手动生成每个小部件，我决定开发一个能够执行以下操作的脚本：</p><p>为此，我们必须检查小部件的代码，并能够自己生成它。</p><p>下面，我复制了在将所需位置设置为巴塞罗那并按下获取代码按钮后获得的小部件代码：</p><p>可以看到，小部件有两个部分，一个链接(标签)和一个脚本(脚本标签)。</p><p>快速检查小部件代码后，很明显，任何位置的小部件代码大部分都是相同的。小部件代码的这部分可以在不做任何修改的情况下复制。</p><p>整个脚本部分可以按原样复制，因为它不包含有关我们要显示天气预报的位置的信息。除此之外，链接中的大多数属性也很容易生成。我们只需将该位置替换为小部件引用的当前位置。考虑到这一点，到目前为止，我们的“通用”小部件模板如下所示：</p><p>我们只需用适当的值替换标签LOCATION_NAME和LOCATION_FORECTORY_URL，然后，该位置的小部件就可以使用了。我们还可以通过用所需的主题名称替换Data-Theme属性的值来更改主题。</p><p>用我们想要的位置替换LOCATION_NAME很简单，但是LOCATION_FORESTORY_URL就不一样了。我们需要了解URL是如何为任何位置构建的，以便能够自己生成它。如果此操作不正确，我们将获得一个404页面，如下所示：</p><p>好处是，我们可以通过为不同位置生成小部件来获得任意多的示例URL。有了足够的数据，我们应该能够对URL构建过程进行反向工程。</p><p>首先要做的是检查URL的不同部分，然后快速浏览一下，看看我们能得到什么。显示巴塞罗那天气的小部件的URL是：</p><p>我们可以看到，URL有两个主要部分。首先，我们有领域和看似是小部件语言的东西：</p><p>我们可以预期此部件在任何位置都是相同的。在那之后，我们有一些看起来像是特定于位置的信息：</p><p>其中最后一部分是微不足道的，因为它只包含位置的名称。我们可以通过检查获得的另一个位置(西班牙巴伦西亚)的不同语言的url来确认我们当前的假设：</p><p>果然，结果不出所料。现在我们只需要弄清楚字母数字序列41d392d17和39d47n0d38是什么意思。我的猜测是，URL的这一部分被用来区分共享相同名称的位置。因此，无论它是如何生成的，我相当肯定它对于每个位置都必须是唯一的，即使它们共享名称。我又测试了几个地点，最后得到了以下列表：</p><p>似乎我们有某种模式。唯一出现的字母似乎是d和n，数字的数量似乎不超过3位。从这一点算起，距离较近的地点，如巴塞罗那和维拉萨德马尔，都有非常相似的序列。这让我想到，在每个序列中编码的都是位置的坐标。如果我们检查巴塞罗那的坐标，我们可以证实这个猜测：</p><p>对啰!。结果是，坐标四舍五入为两个小数，d用于替换小数点，n用于替换负号。我们已经有了生成有效URL所需的所有信息。通用格式如下所示：</p><p>我们已经知道了生成任何位置的小部件代码所需了解的一切。现在是编写小部件生成器的时候了。</p><p>现在我们已经获得了构建小部件所需的所有信息，现在可以对其进行编码了。我们计划的结构将是：</p><p>位置是从MadBoulder提供的区域数据集中获得的。要获得坐标，理想情况下，我们应该使用WeatherWidget.io正在使用的相同服务，因为如果不这样做，可能会有小的差异，从而导致无效的url。但是，我找不到他们是从哪里得到坐标的。</p><p>在测试了不同的服务之后，Open Cage的前向地理编码API提供了最接近的结果，并且可以免费使用。下面是一个样本响应的摘录。</p><p>{[.]&#34；结果&#34；：[{[.]&#34；几何&#34；：{&#34；纬度&#34；：51.9526599，&#34；lng&#34；：7.632473}}]，&#34；状态&#34；：{&#34；代码&#34；：200，&#34；消息&#34；：&#34；确定&#34；}，[.]&#34；TOTAL_RESULTS&#34；：1}。</p><p>然后，我们可以定义一个简单的函数来获取给定位置的坐标：</p><p>def get_coels(Location)：&#34；&#34；&#34；&#34；给定的位置，通过opencagedata API&#34；&#34；&#34；location=location.place(&#34；&#34；，&#34；+&#34；)API_KEY=NONE WITH OPEN(&#34；redentials.txt&#34；，&#34；r&#34；，coding=&#39；utf-8)检索其纬度和经度坐标。)as f：api_key=f.read()query_url=&#34；https://api.opencagedata.com/geocode/v1/json?q={}&amp；key={}&#34；.format(位置，api_key)inp=urllib.request.urlopen(Query_Url)coord=json.load(Inp)[&#39；Results&#39；][0][&#39；Geometry&#39；]返回坐标。</p><p>获得坐标后，我们将纬度和经度四舍五入为两位小数，并通过链接纬度和经度并替换圆点和负号来构建预期的序列：</p><p>给定格式为{&#39；lat&#39；：lat，&#39；lng&#39；：lng}格式的一组坐标，格式为weatherwidget.io预期的url坐标格式的定义格式_坐标(坐标)：&#34；&#34；&#34；&#34；&#34；&#34；&#34；。格式为：-四舍五入到第二个小数点的坐标-被d减号替换为n-LAT和LNG串联的坐标[&#39；lat&#39；]=round(坐标[&#39；lat&#39；]，2)坐标[&#39；lng&#39；]=round(坐标[&#39；lng&#39；]，2)lat=str(坐标[&#39；lng&#39；]，2)。])如果lat[：：-1].find(&#39；.&#39；)==1：lat+=&#34；0&#34；lat=lat=l.place(.#34；，&#34；d&#34；).place(&#34；-&#34；，&#34；n&#34；)lng=str(坐标[&#39；lng&#39；])如果lng[：：-1].find(&#39；.&#39；)==1：lng+=&#34；0&#34；lng=lng.place(&#34；.&#34；，&#34；d&#34；).place(&#34；-&#34；，&#34；n&#34；)返回LAT+LNG。</p><p>之后，我们准备构建小部件的完整url和链接标记：</p><p>A_TAG=&#34；&#34；&#34；类=&#34；天气小部件-io&#34；href=&#34；https://forecast7.com/_LANG_/_COORDS_/_LOCATION_/&#34；数据标签_1=&#34；_LOCATIONPRETTY_&#34；数据标签_2=&#34；天气&#34；数据主题=&#34；纯&#34；&gt；_LOCATIONPRETTY_天气&#34；&#34；&#34；def get_url_location_name(Location)：&#34；&#34；&#34；&#34；将用于搜索坐标的位置名称转换为weatherwidget.io小部件url&#34；&#34；&#34；&#34；Return Location.Split(&#34；，&#34；)[0].LOWER().place(&#34；&#34；，&#34；-&#34；)def get_widget_code(cocords，Pretty。从检索到的信息&#34；&#34；&#34；&#34；位置=get_url_location_name(Pretty_Location)tag=A_tag.place(&#34；_COORDS_&#34；，coods)tag=tag.place(&#34；_LOCATIONPRETTY_&#34；，Pretty_Location)tag=tag.place(&#34；_location_&#34；，COORDS_&#34；，COORDS_&#34；&#34；&#34；&#34；&#34；&#34；&#34；，lang)url=&#34；https://forecast7.com/_LANG_/_COORDS_/_LOCATION_/&#34；url=url.place(&#34；_coords.place(&#34；_location_&#34；，location).place(&#34；_lang_&#34；，lang)返回标签，url。</p><p>现在，由于从Open Cage的API获得的坐标可能与WeatherWidget.io使用的坐标有一些不同，所以我们必须确保我们获得的url是有效的。为此，我们可以定义一个简单的函数，该函数向URL发出请求，如果请求成功，则返回True，否则返回False。</p><p>def is_url_ok(Url)：&#34；&#34；&#34；&#34；&#34；测试weatherwidget.io生成的url是否有效&#34；&#34；&#34；try：req=urllib.request.Request(url，Headers={&#39；User-Agent&#39；：&#34；Magic Browser&#34；})urllib.request.urlopen(Req)除urllib外返回True。</p><p>当请求失败时，大多数情况下是由于坐标上的一些微小差异。因此，当url失败时，我们可以尝试用一个启发式过程来修复它，该过程测试以给定坐标为中心的给定范围内的所有可能的坐标。我们可以在每次迭代中将纬度或经度增加或减少0.01，并检查该更改是否修复了url：</p><p>def fix_url(COCORS，Pretty_Name，Lang)：IF TERTENCE：对于范围内的i(-公差，公差+1)：NC=COCORDS[&#39；LAT&#39；]+i/100，对于范围内的j(-TRANCE，TRANSION+1)：NCL=COCORDS[&#39；LNG&#39；]+j/100 Formated_COCORDS=FORMAT_COORDIES({&#39；LAT&#39；：NC，&#39；LNG&#。：ncl})tag_code，url=get_widget_code(Formatated_coods，Pretty_Name，lang)if is_url_ok(Url)：return tag_code，url return&#34；&#34；，&#34；&#34；</p><p>我发现容差值为5在大多数情况下足以找到正确的url。现在我们已经介绍了所有不同的步骤，我们的主要功能可能如下所示：</p><p>def main(PRETY_NAME)：COCORDS=GET_COORS(PRY_NAME)Formated_COCORDS=Format_COORS(COCORS)tag_code，url=get_widget_code(Formatated_COCORDS，Pretty_Name，&#34；es&#34；)如果不是_url_ok(Url)：tag_code，url=fix_url(COCORDS，Pretty_Name，&#34；es&34；)with open(&#34；template.。)作为f：f.write(Tag_code+script)。</p><p>其中，在本例中，template.html只是一个用于测试目的的空html文件。在几次执行之后，它看起来如下所示，当在浏览器中打开时，结果是：</p><p>和往常一样，您可以在GitHub找到为这个小项目开发的示例代码。</p><p>MadBoulder是一个合作项目，旨在成为Boulder Beta的参考库。我们的想法是收集尽可能多的测试版，从最容易的到最难的。</p><p>该网站使浏览可用信息和查找所需视频变得更容易。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://bitesofcode.wordpress.com/2020/06/17/automating-weather-widget-generation/">https://bitesofcode.wordpress.com/2020/06/17/automating-weather-widget-generation/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/逆向工程/">#逆向工程</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/控件/">#控件</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/widget/">#widget</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/url/">#url</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1005820.html"><img src="http://img.diglog.com/img/2020/6/thumb_c0daa6466c8fc56511aad0fc28dea291.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005820.html">如何对卫视智能卡进行逆向工程(2008)</a></div><span class="my_story_list_date">2020-6-9 15:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003065.html"><img src="http://img.diglog.com/img/2020/5/thumb_3335d7569ea15a677831fb162fd1eb78.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003065.html">逆向工程任天堂Switch App REST API</a></div><span class="my_story_list_date">2020-5-21 9:36</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002146.html"><img src="http://img.diglog.com/img/2020/5/thumb_f714f4a9c5f4f6f8b26864e2b8180931.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002146.html">从模具照片逆向工程76477个“太空入侵者”声音芯片(2017年)</a></div><span class="my_story_list_date">2020-5-15 4:57</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002116.html"><img src="http://img.diglog.com/img/2020/5/thumb_f714f4a9c5f4f6f8b26864e2b8180931.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002116.html">从模具照片逆向工程76477个“太空入侵者”声音芯片(2017年)</a></div><span class="my_story_list_date">2020-5-15 1:9</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>