<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>用Erlang匹配二进制模式</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random=2020-05-02-21:20"><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg navbar-light bg-light"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1>用Erlang匹配二进制模式</h1><div class="row"><div class="col-lg-8 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time">2020-05-02 18:01:46</div><p>在Erlang中，很容易构建二进制文件和位串并匹配二进制模式。我遇到了Mitchell Perilstein与Erlang在NTP方面的出色工作，我想我要用这个来解释一下位串和二进制在Erlang中是如何工作的。</p><p>位串是零个或多个位的序列，其中位数不需要被8整除。</p><p>每个元素指定位串的某一段。段是二进制的一组连续位(不一定在字节边界上)。</p><p>让我们来了解一下这里正在发生的事情。为此，有必要了解整个语法。</p><p>这意味着在实际示例中，我们使用0作为值，2作为大小(2位)，4作为值，3位作为大小，依此类推。我们没有指定任何类型说明符。</p><p>TypeSpecifierList是由连字符或破折号(-)分隔的任意顺序的类型说明符的列表。任何省略的类型说明符都使用默认值。</p><p>type=INTEGER|FLOAT|BINARY|BYTES|BITRING|BITS|UTF8|UTF16|UTF32。</p><p>默认值为整数。字节是二进制的速记，BITS是位串的速记。</p><p>它只在匹配和类型为整数时才重要。默认值为无符号。</p><p>Native-endian意味着在加载时将字符顺序解析为大端或小端，具体取决于运行Erlang机器的CPU的本机字符顺序。仅当类型为整型、utf16、utf32或浮点型时，字节序才重要。默认值为大。</p><p>目前最简单的协议之一是NTP。头文件如下所示：</p><p>它同时用于请求和响应。让我们先起草一下请求吧。</p><p>根据头结构，我们可以看到我们有2位整数(LI)、3位整数版本号、3位整数模式、8位层、8位轮询、8位精度等等。我们只需要设置前3个值，其余的(376位)可以设置为0。</p><p>我们可以使用Erlang的内置函数来实现这个，gen_udp有一个相当全面的低级UDP实现，可以做我们想做的一切。</p><p>%打开本地套接字，0表示它将选择随机本地端口%active=false表示我们需要接收自己的2&&gt;；{ok，socket}=gen_udp：open(0，[binary，{active，false}])，2&&gt;；gen_udp：send(socket，&#34；0.europe.pool.ntp.org&#34；，123，request)，2&&gt;。{OK，{_ADDRESS，_PORT，RESP}}=gen_udp：recv(套接字，0，500)。{OK，{{212，59，0，1}，123，&lt；&lt；；36，2，0，231，0，0，0，110，0，0，0，25，212，59，3，3，226，84，62，89，208，192，202，156，.&gt；&gt；}。</p><p>响应只是一个我们需要分割的二进制文件，类似于我们创建请求的方式。</p><p>4&gt；&lt；&lt；LI：2，版本：3，模式：3，_REST/BINARY&gt；&gt；=Resp。&lt；36，2，0，231，0，0，0，110，0，0，0，25，212，59，3，3，226，84，62，89，208，192，202，156，0，0，0，0，.&gt；&gt；5&gt；{li，li，version，version，mode，mode}。{li，0，版本，4，模式，4}。</p><p>头的其余部分有点棘手，但是使用位串语法，它很容易管理。</p><p>6&gt；&lt；&lt；LI：2，版本：3，模式：3，分层：8，轮询：8/有符号，精度：8/有符号，6&gT；根目录：32，根磁盘：32，R1：8，R2：8，R3：8，R4：8，RTSI：32，RtsF：32，6&gt；OTSI：32，OtsF：32，RcvI：32，RcvF。=响应。&lt；&lt；36，2，0，231，0，0，0，110，0，0，0，25，212，59，3，3，226，84，62，89，208，192，202，156，0，0，0，0，.&gt；&gt；&gt；</p><p>理解这些价值需要更多的跑腿工作。首先，我们需要一个二进制分数的效用函数。</p><p>b基础设施(Bin)-&gt；b基础设施(Bin，2，0)。b基础设施(0，_，Frac)-&gt；Frac；b基础设施(Bin，N，Frac)-&gt；b基础设施(Bin BSR 1，N*2，Frac+(Bin Band 1)/N)。</p><p>使用此函数，我们可以实现处理响应并返回感兴趣的值的函数。</p><p>%2208988800是偏移量(1900年到UNIX纪元)PROCESS_ntp_RESPONSE(Ntp_RESPONSE)-&gt；&lt；&lt；LI：2，版本：3，模式：3，分层：8，轮询：8/有符号，精度：8/有符号，RootDel：32，RootDisp：32，R1：8，R2：8，R3：8，R4：8，RTSI：32，RtsF：32，OTSI：32，OtsF：32，RcvI：32，RcvF：32，XmtI：32，XmtF：32&gt；=NTP_RESPONSE，{NowMS，NOWS，NowUS}=Erlang：Timestamp()，NowTimestamp=NowMS*1。0 e6+NOWS+NOWUS/1000，传输时间戳=XMTI-2208988800+BINFIC(XMTF)，{{li，li}，{vn.。</p><p>{{li，0}，{vn，4}，{模式，4}，{层，2}，{轮询，3}，{精度，-24}，{根延迟，9}，{根分散，140}，{引用ID，85，158，25，75}，{引用时间戳，1588186010。75</p><div class="sotry_link"><a target="_blank" href="https://dev.to/l1x/matching-binary-patterns-11kh">https://dev.to/l1x/matching-binary-patterns-11kh</a></div><div class="story_tags"><button type="button" class="btn btn-light my_tag"><a href="/tag/erlang/">#erlang</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/二进制/">#二进制</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/bit/">#bit</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/binary/">#binary</a></button></div></div></div><div class="col-lg-4 col-0"><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/百度/">#百度</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搜索/">#搜索</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/科学/">#科学</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/flash/">#flash</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/人像/">#人像</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/动物/">#动物</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/互联网/">#互联网</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/logo/">#logo</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/在线/">#在线</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/twitter/">#twitter</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/浏览器/">#浏览器</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/电影/">#电影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搜索引擎/">#搜索引擎</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/雷人/">#雷人</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/腾讯/">#腾讯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搞笑/">#搞笑</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/日本/">#日本</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/css/">#css</a></button></div></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com <div style="color:#ffffff;font-size:1px;">2020-05-02 21:20:11</div></div></div><script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script></body></html>