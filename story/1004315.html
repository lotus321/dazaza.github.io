<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>原生JavaScript的类型安全</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">原生JavaScript的类型安全</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-30 04:45:57</div><div class="page_narrow text-break page_content"><p>这是对原文章的更新，更短、更简单、更合乎逻辑、更正确。</p><p>许多开发人员工具，如IDE、框架、库和链接器，都试图为JavaScript提供某种级别的类型安全。本文解释了什么是类型安全，为什么需要类型安全，以及如何使用原生JavaScript实现类型安全。</p><p>类型安全是编程语言阻止或防止类型错误的程度。当向函数或表达式提供意外或不兼容的类型值(通常作为参数或上下文)时，会发生类型错误。将一个数字除以一个数组就是一个很好的例子，通常这是没有意义的，但是JavaScript支持这个操作，通常会得到令人惊讶和不想要的结果。</p><p>让我们看看在Javascript中使用一些边缘邪教中流行的简约风格来创建类型错误是多么容易。这是可怕的代码，所以请不要复制它。我们会边走边改进。</p><p>那没花太长时间！当我们向重复调用提供‘-3’参数时，发生第一个类型错误。该值应该是一个整数，但是我们提供了一个字符串。然后所有的地狱都挣脱了。</p><p>当调用Repeats时，它会创建一个“无穷无尽”的循环条件，很快就会消耗其执行环境中的所有可用资源。这会导致NodeJS进程、或浏览器选项卡、或整个浏览器进程或主机操作系统的强制终止。</p><p>如果我们观察While循环中计数值的变化，我们会看到以下一系列：&#39；-3&#39；，&#39；-31&#39；，&#39；-311&#39；，&#39；-3111&#39；，.。测试条件Counts&lt；0确实将Counts字符串转换为数字，但为时已晚：该值始终小于0，并且在每次迭代时都是负值。这是因为表达式COUNTS+=1总是将数字1转换成字符串&#39；1&#39；并将其附加到counts变量。</p><p>JavaScript几乎缺少所有的类型控件，因为它最初并不是用来运行大型应用程序的。没有类型声明，返回类型不可靠，没有静态类型检查，只有一个自己的动态检查。</p><p>JavaScript没有正式声明变量类型的方法。变量可以包含在执行过程中随时可以更改的任何类型。没有标识类型的符号，变量名不受约束。我们可能都见过一两个JavaScript应用程序，在不同的上下文中，单个类似于符号的手表被用作对象、地图、列表、布尔标志、字符串、整数和浮点数。然而，在实践中，JavaScript中使用的大多数变量并不打算更改上下文中的类型，因为这样做会造成不必要的混乱。</p><p>其他语言提供“通配符”变量来引用任何类型的值。它们通常很容易识别，因为它们有一个独特的语法。开发人员知道他们需要小心处理这些“通配符”。在JavaScript中，所有变量都是“通配符”。</p><p>JavaScript表达式的返回类型通常不可靠。许多JavaScript操作符都是多态的，将根据使用的变量类型返回不同类型的值。例如，JavaScript‘+’运算符可以连接字符串、添加数字或将字符串转换为数字。当混合变量类型时，返回值可能会令人吃惊，如下所示。</p><p>//已确认使用Google V8版本6.0.286.52控制台。日志(进程。版本。v8)；var x，y；//expression//|返回值|强制|运算x=3；//|3|-|x=3+1；//|4|-|+num x=3+&#39；1&#39；；//|&#39；31&#39；|3=&gt；&#39；3&#39；|+str x=3+[]；//||&#39；3&#39；|[]=。&#39；|+str x=3+[21]；//|&#39；321&#39；|[21]=&gt；&#39；21&#39；|+str x=3+{}；//|&#39；3[对象对象]&#39；|{}=&gt；str|+str x=&#39；3&#39；-2；//|1|&#39；3&#39；=&gt。3&#39；+2；//|#39；32&#39；|2=&gt；&#39；2&#39；|+str x=+&#39；3&#39；；//|3|&#39；3&#39；=&gt；3|cast_num x=0+&#39；3&#39；；//|&#39；03&#39；|0=&gt；&#39；0&#39；//|nan|-|nan x=y+&#39；3&#39；；//|&#39；unfined3&#39；|undef=&gt；str|+str。</p><p>此行为(使用GoogleV8版本6.0.286.52确认；请参见NodeJavaScript)在四个主要的-e&#39；console.log(process.versions.v8)；&#39；)引擎(V8、IonMonkey、Nitro、Chakra)和其他十几个引擎之间可能是一致的。然而，不太受欢迎的运营商可能在发动机之间存在某些差异，这可能会导致头痛。</p><p>其他语言的行为没有那么复杂，因为它们通常具有更严格的类型检查、更严格的强制规则、更少的多态运算符和更少的供应商。例如，Perl使用点(.)。用于连接字符串的运算符和用于添加数字的加号(+)运算符。Perl还使用$、@和%之类的信号(前缀)来指示类型，并使用特殊语法来标识“通配符”(type-glob)引用。</p><p>许多语言都提供了某种级别的静态类型检查。例如，Java在编译期间解析大多数变量类型。如果JavaScript有类似的机制，我们将无法运行我们的应用程序，直到我们解决了编译错误。在这个虚构世界中，我们的JavaScript编译输出可能如下所示：</p><p>00：OK|x=3；|01：OK|x=3+1；|02：COMPILE_ERROR：TYPE_MISMATCH|x=3+&#39；1&#39；|03：COMPILE_ERROR：TYPE_MISMATCH|x=3+[]；|04：COMPILE_ERROR：TYPE_MISMATCH|x=3+[21]；|06：COMPILE_ERROR：TYPE_MISMATCH|x=3+{}；|07：COMPILE_ERROR：TYPE_MISMATCH|x=&#39。|08：COMPILE_ERROR：TYPE_MISMATCH|x=&#39；3&#39；+2；|09：COMPILE_ERROR：TYPE_MISMATCH|x=+&#39；3&#39；|10：COMPILE_ERROR：TYPE_MISMATCH|x=0+&#39；3&#39；；|11：COMPILE_ERROR：TYPE_MISMATCH|x=y++3；|12：COMPILE_ERROR：TYPE_MISMATCH|x=y+&#39；3&#39；</p><p>静态(编译时)类型检查的最大优点可能是它可以提高性能：在编译过程中可以解析的每个类型检查都会删除每次调用函数或方法时需要调用的类型检查。这可以在应用程序运行时删除大量调用，从而提高性能。</p><p>静态类型检查并非在所有情况下都有效，尤其是在处理来自未知或不可信来源的数据时。在这些情况下，我们求助于运行时的动态类型检查。用于此目的的原生JavaScript工具是有限的。例如，typeof方法不区分对象和数组。</p><p>类型错误可能很难识别和调试。当一个例程未能检查类型时，错误的结果可能会向上传播到调用堆栈，从而导致一连串的错误。如果变量没有命名以指示其预期类型，则很难发现原始缺陷，如下所示：</p><p>//此赋值中的类型错误非常明显，let total_str=watch_list/use_bool；//明显的问题//-从除法运算返回的应该是数字，而不是字符串//-在大多数情况下除以列表将导致NaN//-布尔值将强制为0或1//这里是通过使用正确的类型let total_num=watch_list修复的问题。长度/USE_COUNT；</p><p>是的，预期的变量类型就是那么重要。我们不得不维护大量的第三方模块，在这些模块中，变量名没有提供类型或用途的提示，或者更糟糕的是，它们明显具有误导性。我们宁愿以可变的方式命名我们的变量，并利用节省下来的时间专注于新的挑战。</p><p>正如我们已经展示的，类型错误可能导致严重的应用程序故障和安全漏洞。设想一些NodeJS代码没有正确键入-检查其JSON API。只需在API请求中发送字符串而不是数字，就可以实现拒绝服务(DOS)攻击并关闭整个群集。这种事情时有发生。</p><p>有几种方法可以提高JavaScript类型安全性。一种方法涉及使用库或框架，例如需要转换代码或以其他方式预处理代码的流或打字脚本。在这里，我们提出一个更简单的解决方案，它可能特别适合较小的项目，并且只需要三个步骤。</p><p>就本文而言，类型转换是使用一组非常严格的规则将值转换为所需数据类型的过程。我们的类型转换函数要么返回请求的值类型，要么返回默认情况下未定义的故障值。</p><p>我们可以从hi_core项目中获得易于安装的类型转换方法(在终端中输入npm install hi_core)。如果编辑exampleapplication，则可以使用xhi.util.js中的所有强制转换方法。</p><p>npm install hi_Score CD hi_Score bin/xhi设置google-chrome./index.html#打开JavaScript控制台访问xhi._util_Functions。</p><p>您不必使用整个库；如果需要，只需从xhi.util.js复制方法即可。去吧，你不会伤害任何人的感情的。这些类型转换方法如下所示，并且在项目中都经过了彻底的测试和良好的文档编制。</p><p>所有类型转换方法都有一个或两个参数。只有当转换明确时，才会在类型之间转换数字、字符串和整数。示例如下所示。</p><p>//return_data=CastInt(&lt；Value-to-Cast&gt；[，&lt；Failure-Value&gt；])；return_data=CastInt(0)；//0 return_data=CastInt(&#39；0&#39；)；//0 return_data=CastInt(&#39；a&#39；)；//未定义的return_data=CastInt([])；//未定义的return_data=CastInt。，0)；//0 return_data=CastInt([]，0)；//0。</p><p>JavaScript试图强制类型，但结果往往不理想。空白单元格是通常会引发类型错误异常的情况。</p><p>强制转换方法是可预测的、显式的和自我记录的，只转换最明确的值。空白单元格是返回失败值(默认情况下未定义)的条件。这些方法不会抛出任何异常。</p><p>让我们调整我们的示例函数以使用CastInt和CastFn，以确保提供的参数是正确的类型。如果不是，该函数将返回，不进行任何进一步处理。</p><p>函数重复(arg_counts，arg_run){var counts=CastInt(Arg_Count)var run=CastFn(Arg_Run)if(！(counts&amp；&amp；run)){return}While(Counts&lt；){Run(Counts)Counts+=1}}函数报告(INFO){console。log(Info)}重复(&#39；-3&#39；，报告)。</p><p>类型转换处理运行时类型检查。静态检查的大多数好处可以通过命名变量来指示它们的预期类型来实现。如果我们遵循这个约定，大多数静态类型错误就会变得不言而喻。让我们使用JS代码标准快速参考中的命名约定重写代码。</p><p>函数repeatFn(Arg_Map){var map=CastMap(arg_map，{})，int=CastInt(map.。_int_，0)，fn=CastFn(贴图。_fn_)，idx；如果(！fn){return；}(idx=int；idx&lt；0；idx++){fn(Idx)；}}函数printToConsole(Idx){console。log(Idx)；}repeatFn({_int_：&#39；-3&#39；，_fn_：printToConsole})；</p><p>此代码现在将传递ESLint。多亏了命名约定，我们可以告诉我们fn应该是一个函数，idx应该立即是一个整数，而不需要阅读其他代码，添加标记注释，或者执行任何转换。</p><p>我们使用的完整JS代码标准讨论了为什么简单的命名约定可以极大地减少注释的需要。如果你对这类东西感兴趣，我们认为这是一本有趣而引人入胜的书。</p><p>现在我们有了一致的按类型命名的变量和更好的格式，我们可以轻松地阅读代码来创建内联API文档。使用代码标准中的指南，我们得到以下内容：</p><p>//BEGIN实用程序方法/REPEATFN/摘要：REPEATFn({_INT_：&lt；INTEGER&gt；，_FN_：&lt；function&gt；)//目的：只要//COUNTER&#39；INT&39；INT&lt；为&lt；0，就重复调用函数&#39；fn&#39；。每次调用后，&#39；int&#39；递增1。如果&#39；int&#39；//的初始值不是&lt；0，则不会调用函数&#39；fn&#39；。//示例：repeatFn({//_int_：-3，//_fn_：function(Idx){console.log(Idx)}//})；//参数：(已命名)//_fn_：要执行的函数。//索引(Idx)的当前值作为其唯一参数提供。//_int_：idx的初始值。idx在执行//_fn_之后递增。因此，值&#39；-1&#39；将导致_fn_(Idx)；//单次执行；//返回：未定义//抛出：无//函数repeFn(Arg_Map){var map=CastMap(arg_map，{})，int=CastInt(map.。_int_，0)，fn=CastFn(贴图。_fn_)，idx；如果(！fn){return；}for(idx=int；idx&lt；0；idx++){fn(Idx)；}}//结束实用程序方法/repeatFn/function printToConsole(Idx){console。log(Idx)；}repeatFn({_int_：&#39；-3&#39；，_fn_：printToConsole})；</p><p>还记得我们在哪里恳求您不要复制我们的第一个代码示例吗？改为复制此代码。它不受大多数类型错误的影响，可读、可测试、可维护、可压缩，并且有很好的文档记录。</p><p>我们可以使用内联API文档以及伊斯坦布尔和nodeunit等工具为类型安全的RepeatFn函数创建测试。查看hi_Score的测试套件，看看如何实现这一点。</p><p>这项简单的技术与流和打字相比如何？我们打算出版一部续集来回答这个问题。</p><p>请记住，只有在处理外部数据和公共方法的输入时才使用类型转换。依靠命名约定在私有方法和变量中传递预期类型的变量。</p><p>我们希望您会发现这一点很有用！请在下面的评论中分享您的想法和经验。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://mmikowski.github.io/typecast-02/">https://mmikowski.github.io/typecast-02/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/java/">#java</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/safety/">#safety</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/类型/">#类型</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1004224.html"><img src="http://img.diglog.com/img/2020/5/thumb_378170328701625b3cb383faba4b4f59.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004224.html">使用JavaScript和Twilio在9分钟内构建和部署视频应用</a></div><span class="my_story_list_date">2020-5-29 19:59</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004183.html"><img src="http://img.diglog.com/img/2020/5/thumb_1dbc7ea383c33145f870d8f243ce9421.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004183.html">谷歌推出Android Studio4.0，内置动画编辑器、Build Analyzer和Java8API</a></div><span class="my_story_list_date">2020-5-29 9:15</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004119.html"><img src="http://img.diglog.com/img/2020/5/thumb_7c74a2d5dec86839cef3caff6cf21073.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004119.html">Pico：用于高精度视口截图的客户端JavaScript库</a></div><span class="my_story_list_date">2020-5-29 2:35</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003460.html"><img src="http://img.diglog.com/img/2020/5/thumb_477ab4645a7305579ddf76a77377ad89.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003460.html">Java编程语言庆祝其25周年诞辰。下一个是什么？</a></div><span class="my_story_list_date">2020-5-24 7:36</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>