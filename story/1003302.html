<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>解开HP固件更新-本系列的第2部分已完成</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">解开HP固件更新-本系列的第2部分已完成</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-23 01:57:34</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/0ef998ad5b88c572caa584f47ce90e37.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>这篇文章是记录固件更新的不同结构和阶段的四部分博客系列的第二篇。该系列的下一部分将在我们撰写时逐周上传。</p><p>在上一篇文章中，我们详细介绍了如何解压HP固件光栅图形并提取其编码数据。此时，第二层编码数据应该是可见的。这篇文章详细介绍了如何破译下一个编码层。</p><p>第二固件编码层开始于一系列大约6,000条结构化的ASCII行，随后是大的二进制数据斑点。在我们的研究中，我们最初忽略了开头的ASCII行，主要关注二进制数据。然而，在这篇文章中，我们稍后将回到这个二进制数据。</p><p>第二阶段文件的ASCII行(位于文件开头)使用下面解释的“S-Record”格式，并加入了一些专有扩展名。</p><p>摩托罗拉开发了S-Record格式，这是一种用于编码二进制数据的ASCII格式。其常规用途是对EEPROM/闪存芯片进行编程。它通常由固件开发人员使用，并由不同类型的记录组成，主要有两类：*数据记录，由加载地址后跟数据组成*包含用于在编程结束时重定向执行的地址的开始地址记录。</p><p>每个S记录都是以“&lt；LF&gt；”(\n)结尾的单独行，由5个字段组成：</p><p>每个字段的使用取决于记录类型。除了第一个字符(这是S)之外，所有其他字符都是ASCII-十六进制。</p><p>在我们的例子中，第二阶段固件文件的ASCII部分以7个类型A的S记录开始，每个记录的长度为0x27(为方便起见增加了空格)：</p><p>S A 27 0202026F02EA000801008F8B97F7FFC72708D194D0F4181400BF28865C57BDEFADCDDE136EB6 21&lt；LF&&gt;；S A 27 5E116D98172B43812D1FA171C827EA524AC7A7699AA4AAA66D09C92F0FFE82FC8C611E6D2E90 F7&lt；LF&&gt;T；S A 27 9527FD68BC05365133E59A9C3F5C3E63819D64D7BBD839AF5B40ACCA7A4964ED97ECD21476B8 55&lt；LF&&gt;；S A 27 46E0ADF0F9BF0D9210B70EA7E6FB96C007CED8DF8F92FCA2F5A4ADDE730EF4565049F2523097 2D&lt；LF&gt；S A 27 1B1A3B9BD4ADB31654C1B7A94D98629BB52974BB362F18FCD7D2898B6D20AA872070EC0BC3FC E5&lt；LF&&gt;；S A 27 87737AEB4FDAA840BFC6355D3C6F405FFFB8F074141D1B59B302E4808944AC5CD4AE8FE3DEB8 CF&lt；LF&&gt;T；S A 27 AC2DD17268E76FBAD51F8B979994DD70760F2BE56356659086F46FD5B109762F84ACBBCE0E42 4B&lt；LF&gt；</p><p>这种类型的S-Record是专有的，没有文档记录。一些调查证实它很可能是身份验证头(可能是更新包的签名)。</p><p>在身份验证报头之后，有一个类型为0的S记录。类型为0的记录称为第一标头记录。其地址字段通常为零，并且其数据字段通常包含以人类可读格式描述下一块S记录的文本信息。此记录类型不影响记录解析。在我们的示例中，它包含字符串“flash”(空格是故意的)：</p><p>S 00F 0000 7265666C6173682020200000 AB&lt；LF&gt；R e f l a s h_[空格]。</p><p>接下来的5,908行是类型3的S-Records。类型3记录指示闪存编程器将记录数据存储到指定的4字节存储器地址。例如，下面的S记录行表示“在地址401D0000存储20字节数据”：</p><p>该记录没有数据字段，地址字段是控制(CPU执行)传递到的4字节地址。</p><p>使用开源工具SREC_INFO_INFO(有关链接，请参阅下面的参考部分)，我们可以获得有关该文件的一些信息(请务必手动删除前7行S-Records，以便SREC_INFO能够识别该文件)。输出应如下所示：</p><p>$SREC_INFO OUTER.srec格式：Motorola S-Record Header：&#34；Reflash&#34；执行开始地址：401D8D38 SREC_INFO：outer.srec：5911：警告：忽略垃圾行数据：401D0000-401E4D95 401E4D98-401EBE67 401EBE98-401EBF C01F02E0-C01F11BF C01F8</p><p>此输出显示加载的数据在内存中不是连续的。SREC_INFO命令引用的垃圾行是紧跟在S7记录之后的两行：</p><p>似乎这些是特殊的(专有)记录，以“F”或“P”开头，后跟一个四字节地址。它可以用来在分支之前设置一些寄存器或状态，作为版本号的指示符，或者任何其他真正的东西，但是我们没有进一步研究这一点。</p><p>在s记录之后是二进制数据。在我们的研究中，这是我们分析的第一部分。</p><p>二进制数据中的许多序列作为人类可读的字符串很容易被检测到，但是它们是“断裂的”，即它们是字符串的可读片段，而不是整个字符串。这表明我们正在接近最终的原始数据，并且该格式没有经过压缩、加密或大量编码。</p><p>通过盯着二进制数据看一位，就会出现一种模式。看一下从二进制文件中提取的证书：</p><p>您可以看到每40字节重复一次的二进制数据的明确模式。这7个字节显然不是真实数据的一部分(即，它们包含非ASCII字节)。初步观察表明，33个2D字节中的第二个和第三个字节是某种报头，而接下来的4个字节每次都保持某种递增0x28的计数器。第一个字节看起来像某种校验和。</p><p>在内部，我们将这种模式称为“神秘的7字节模式”。有几个问题引起了我们的兴趣：(此模式的目的是什么？*文件开头的ASCII命令的目的是什么？*校验和是如何计算的(它是校验和吗)？</p><p>让我们看一下第一个字节，它看起来像一个校验和。请注意，对于两个相同的序列，该值是不同的。考虑以下问题：</p><p>看起来，对于每0x28字节，校验和字节通常递减0x28(模0x100)，但偶尔会递减0x29。</p><p>要了解这一点，我们来看一下图像中的地址0x13AB3E以及其后的三个校验和字节。我们可以检查校验和值之间的绝对差异：</p><p>1A+28=42(地址0x13AB3E的第一个字节)F1+29=1A^+-(地址0x13AB9C的第一个字节)。</p><p>快进许多令人精疲力竭的小时，在这段时间里，我们盯着数据，它也在盯着我们。最后，它泄露了自己的秘密。可以推导出校验和计算和整个格式。</p><p>原来，第一个字节实际上是之前“7字节模式”的最后一个字节，而这个模式只不过是摩托罗拉S-Record的二进制版本--确实很神秘！</p><p>二进制S记录中的记录与其对应的ASCII记录具有相同的结构，不同之处在于ASCII版本中的SX值(其中，4X表示类型)被二进制版本中的0x3X值替换，其余数据是二进制数据，而不是ASCII编码的。此外，还省略了换行符(&lt；LF&gt；)。</p><p>33 2D 00 18 A08 A3 62 02 B2 38 CC DA 54 6F 9B 4A 02 FC 81 0D 32 0E BB B1 3C 37 D6 8F A8 3C E7 9D F2 38 8C 63 FC F6 EA FC 38 68 03 2B F2 AA。</p><p>33-记录类型(3)2D-记录长度(45)00 18 A00 08-记录地址A3 62 02 B2 38 CC DA 54 6F 9B 4A 02 FC 81 0D 32 0E BB B1 3C 37 D6 8F A8 3C E7 9D F2 38 8C 63 FC F6 EA FC 38 68 03 2B F2-数据AA-记录校验和</p><p>那么这一切意味着什么呢？为什么我们有ASCII S-Records后跟二进制版本的S-Records？为什么惠普要使用二进制S-Record格式而不是简单的ASCII版本？如果他们决定使用二进制S记录，那么为什么还要使用ASCII S记录呢？</p><p>我们查看了由(ASCII)S-Record层编码的数据，编写了一个简单的Python脚本来提取记录，并将它们加载到Ghidra的地址0x401D0000，这是S-Record指明要写入此节的地址。</p><p>一个有趣的函数位于地址0x401d84d4。以下是Ghidra反编译的摘录：</p><p>您看，最初的ASCII S-Record行包含解析二进制S-Records的代码(是的，您的理解是正确的。</p><p>为什么惠普要这么做？我们没有一个明确的答案，但空间可能是二进制S记录的一个原因。当以ASCII S-Record格式表示时，二进制数据的大小将扩大约2.4倍(参见SRecord参考手册第134页)。固件更新文件已经相当大了-接近40MB，没有理由将其大小翻倍。</p><p>为什么要进行双重编码？可能是为了使所有更新与具有解码ASCII S记录的代码的打印机版本向后兼容。我也可能与更新固件时执行的阶段性进程有关。</p><p>在下一篇博客文章中，我们将看到如何将此图像加载到内存中进行逆向工程(以及常规的打印机操作)。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://jsof-tech.com/unpacking-hp-firmware-updates-part-2/">https://jsof-tech.com/unpacking-hp-firmware-updates-part-2/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/hp/">#hp</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/记录/">#记录</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>