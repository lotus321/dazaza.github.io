<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>loginsrv：带有OAuth2、Google、GitHub等后端的JWT登录微服务</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">loginsrv：带有OAuth2、Google、GitHub等后端的JWT登录微服务</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-24 04:11:05</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/d3af58bce961ab6ad21807ab1c4303cd.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>GitHub是5000多万开发人员的家园，他们一起工作，共同托管和审查代码、管理项目和构建软件。</p><p>报名。</p><p>loginsrv是一个独立的简约登录服务器，为多个登录后端提供JWT登录。</p><p>谷歌将停止对Google+API的支持。因此，我们将loginsrv更改为使用标准OAuth端点进行Google登录。如果您使用的是Google登录，请将loginsrv更新到v1.3.0。</p><p>从v1.3.0开始，loginsrv为登录cookie设置安全标志。因此，如果您使用HTTP与浏览器连接，例如用于测试，您的浏览器将忽略cookie。在不使用HTTPS进行测试时，请使用标志-cookie-secure=false。</p><p>Loginsrv为身份验证提供最小端点。登录针对提供程序执行，并作为JSON Web令牌(JWT)返回。它可以用作：</p><p>球童用户请注意：并非所有参数在球童中都可用。有关详细信息，请参见表。对于Caddy，参数名称也可以与名称中的_一起使用，例如cookie_http_only。</p><p>在JWT cookie上设置安全标志。(若要支持纯HTTP，请将其设置为False)</p><p>包含允许重定向的域列表的文件，每行一个域。</p><p>包含令牌的用户特定数据的YAML文件。(请参见下面的示例)。</p><p>为令牌提供用户特定数据的端点的URL。(请参见下面的示例)。</p><p>通过使用以下命名的变量，所有上述配置选项也可以作为环境变量应用：LOGINSRV_OPTION_NAME。因此，例如，JWT-SECRET可以由环境变量LOGINSRV_JWT_SECRET设置。</p><p>使用loginsrv的最简单方式是使用提供的码头容器。使用简单提供程序配置：</p><p>$docker run-d-p8080：8080tarent/loginsrv-cookie-SECURE=FALSE-JWT-SECRET MY_SECRET-SIMPLE BOB=SECRET$CURL--DATA&34；用户名=BOB&A；PASSWORD=SECRET&34；127.0.0.1:8080/logineyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJib2IifQ.uWoJkSXTLA_RvfLKe12pb4CyxQNxe5_Ovw-N5wfQwkzXz2enbhA9JZf8MmTp9n-TTDcWdY3Fd1SA72_M20G9lQ。</p><p>默认情况下，对于未经身份验证的请求，它返回一个简单的Bootstrap样式的登录表单，对于经过身份验证的请求，它返回一个包含用户信息的页面。当调用接受JSON输出时，令牌的json内容将返回到经过身份验证的请求。</p><p>返回的超文本标记语言遵循(lib-compose)[https://github.com/tarent/lib-compose]，的UI合成约定，因此可以嵌入到现有布局中。</p><p>使用配置的提供程序启动OAuth Web流。例如，GET/LOGIN/GitHub重定向到GitHub登录表单。</p><p>执行登录并返回JWT。根据内容类型和参数，可以执行经典的JSON-REST或重定向。</p><p>如果登录成功并重定向到redirectSuccess或redirectError中提供的URL，则将JWT设置为Cookie。</p><p>提示：状态401 AUTHORIZED不用作不与HTTP基本身份验证冲突的返回代码。</p><p>如果缺少用户名和密码的POST参数，并且请求中包含有效的JWT-Cookie，则刷新JWT-Cookie。只有将JWT-Refresh配置选项设置为大于0的值时，才会发生这种情况。</p><p>cURL-I--DATA&34；USERNAME=BOB&AMP；PASSWORD=SECRET http://127.0.0.1:6789/loginHTTP/1.1 200OK内容类型：应用程序/作业日期：星期一，2016年11月14日21：35：42 GMT内容长度：100eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJib2IifQ.-51G5JQmpJleARHp8rIljBczPFanWT93d_N_7LQGUXU。</p><p>Curl-i-H&#39；内容类型：应用程序/json&#39；--数据&#39；{&#34；用户名&#34；：&#34；bob&#34；，&#34；密码&#34；：&#34；Secret&#34；}&#39；http://127.0.0.1:6789/loginHTTP/1.1 200OK内容类型：应用程序/作业日期：星期一，2016年11月14日21：35：42 GMT内容长度：100eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJib2IifQ.-51G5JQmpJleARHp8rIljBczPFanWT93d_N_7LQGUXU。</p><p>示例：使用JQuery调用Ajax以获取JWT令牌并从中创建Cookie</p><p>$.ajax({url：&#34；http://localhost:8080/login&#34；，类型：&#39；POST&#39；，数据类型：&#39；文本&#39；，内容类型：&#39；应用程序/json&#39；，数据：JSON.stringify({&#39；用户名&#39；：&#39；演示&#39；，&#39；密码&#39；：&#39；演示&#39；})，SUCCESS：Function(Data){Docent.cookie=&#34；JWT_TOKEN=&#34；+DATA+&#34；；path=/&#34；；}，错误：Function(xhr，ajaxOptions，thrownError){}})；</p><p>API支持重定向查询参数，例如？BACKTO=/DYNAMIC/RETURN/PATH。出于安全原因，默认行为非常严格：</p><p>检查Referer标头以确保对登录页面的调用来自同一页面。</p><p>这些限制是为了防止您未经检查的重定向攻击，例如网络钓鱼或登录攻击。如果您知道您在做什么，您可以使用--redirect-check-referer=false禁用引用检查，并使用--redirect-host-file=/ome/domains.txt为允许的外部域提供白名单文件。</p><p>根据htpasswd文件进行身份验证。支持MD5、SHA1和bcrypt。但我们建议仅出于安全原因使用bcrypt(例如htpasswd-B-C15)。</p><p>密码文件的路径(可以使用&#39；；&#39；分隔多个文件)。</p><p>通过执行HTTP基本身份验证请求并检查HTTP 200 OK状态代码的响应，针对上游HTTP服务器进行身份验证。除200 OK状态代码以外的任何代码都将导致身份验证失败。</p><p>OSIAM是一个安全的身份管理解决方案，提供基于REST的身份验证和授权服务，它实现了多个OAuth2流，以及用于管理用户数据的SCIM。</p><p>要针对同一台计算机上的默认OSIAM配置启动loginsrv，请使用以下示例。</p><p>Simple是一个演示提供程序，仅用于测试。它在内存中保存一个用户/密码表。</p><p>还支持OAuth Web流(也称为3条腿的OAuth流)。目前支持以下OAuth提供程序：</p><p>在外部OAuth提供程序配置OAuth参数时，必须提供重定向URI。此重定向URI必须指向路径/login/&lt；Provider&gt；。如果未提供，则根据当前URL计算OAuth重定向URI。如果正确设置了报头X-Forwarded-Host和X-Forwarded-Proto，这在大多数情况下都应该有效，甚至在loginsrv通过反向代理路由的情况下也应该有效。</p><p>自定义模板可以通过参数template提供，您可以在login/login_form.go中找到原始模板。</p><p>指定自定义模板时，仅替换原始模板的布局。原始文件的分音仍会加载到模板上下文中，并可由您的模板使用。因此，最小的未设置样式的登录模板可能如下所示：</p><p>&lt；！DOCTYPE html&gt；&lt；html&gt；&lt；Head&gt；&lt；！--您的样式--&gt；&lt；Head&gt；&lt；正文&lt；！--您的页眉--&gt；{{if.Error}}&lt；div class=&#34；alert-dangge&#34；角色=&#34；alert&#34；&。&lt；/strong&gt；请稍后重试。&lt；/div&gt；{{end}}{{if.Authenticated}}{{template&#34；userInfo&#34；。}}{{Else}}{{Template&#34；login&#34；。}}{{end}}&lt；！--您的页脚--&gt；&lt；/body&gt；&lt；/html&gt；</p><p>要定制JWT令牌的内容，可以提供包含用户数据的文件或提供声明的端点。</p><p>用户文件是包含在令牌中编码的附加信息的YAML文件。在Backend系统认证成功后，在文件中搜索用户，并使用Claims参数的内容来增强用户的JWT索赔参数。</p><p>要匹配条目，将以线性顺序搜索用户文件，并且所有属性都必须与身份验证后端的数据匹配。将使用第一个匹配条目，并且声明属性以下的所有参数都将写入令牌。以下属性可用于匹配：</p><p>组-数组中包含的用户组的完整路径字符串(仅限GitLab)。</p><p>用户admin@example.org在使用Google OAuth进行身份验证时将变为&#34；角色&#34；：&#34；admin&#34；和&#34；项目&#34；：[&#34；示例&#34；]。</p><p>具有域示例的所有其他Google用户将成为&#34；角色&#34；：&#34；用户&#34；和&#34；项目&#34；：[&#34；示例&#34；]。</p><p>-SUB：Bob Origin：htpasswd Claims：Role：superAdmin-Email：admin@example.org Origin：Google Claims：Role：Admin Projects：-Example-domain：example.org Origin：Google Claims：Role：User Projects：-Example-Groups：-Example/Subgroup-thergroup Origin：GitLab Claims：Role：Admin-Claims：Role：UNKNOWN。</p><p>用户端点是提供关于认证用户的附加信息的HTTP端点。在针对后端系统成功进行身份验证后，将调用端点，并使用提供的信息来增强用户JWT声明参数。</p><p>组-数组中包含的用户组的完整路径字符串(仅限GitLab)</p><p>获取/claims?origin=google&amp；sub=test@example.com&amp；email=test@example.com HTTP/1.1主机：本地主机：8080接受：*/*授权：持有者令牌HTTP/1.1200OK内容类型：应用程序/json{&#34；sub&#34；：&#34；test@example.com&#34；，&#34；uid&#34；：&#34；113&#34；，&#34；原始&#34；：&#34；google&#34；，&#34；权限&#34；：[&#34；读取&#34；，&#34；写入&#34；]}</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/tarent/loginsrv">https://github.com/tarent/loginsrv</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/github/">#github</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/登录/">#登录</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/jwt/">#jwt</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1003200.html"><img src="http://img.diglog.com/img/2020/5/thumb_c0362738aabaae0dd047d0da564ce5ae.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003200.html">GitHub ProTips-来自Sarah Vehicles的提示、技巧、黑客和秘密</a></div><span class="my_story_list_date">2020-5-22 6:51</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003070.html"><img src="http://img.diglog.com/img/2020/5/thumb_50b167e95326ddd1d22749c631dcdc2a.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003070.html">Go MySQL驱动程序中的三个错误</a></div><span class="my_story_list_date">2020-5-21 10:44</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002701.html"><img src="http://img.diglog.com/img/2020/5/thumb_df8a7d72615ac94a0f2fe38db295bf50.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002701.html">德国冠状病毒应用在GitHub上的架构</a></div><span class="my_story_list_date">2020-5-19 5:50</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002281.html"><img src="http://img.diglog.com/img/2020/5/thumb_5c1b51bd4cef10099b7cf35b0dd67325.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002281.html">信号：由于Facebook的参与而删除GIPHY支持[GitHub问题]</a></div><span class="my_story_list_date">2020-5-16 3:34</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>