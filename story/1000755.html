<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Hasura授权系统实例分析</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Hasura授权系统实例分析</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-05 21:56:03</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/bf22b5e135c5c1927c0a0f1faf71e8ad.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>授权系统是关于能够指定允许系统回答的规则，“用户U可以[在资源R上]执行操作A吗？”在这篇文章中，我们将使用Hasura的基于JSON的DSL来实现一些现实世界的授权规则。但首先，快速回顾一下Hasura的授权系统。</p><p>对Hasura的每个请求都针对一组会话变量执行。这些变量应由身份验证系统设置。虽然可以在定义授权规则时设置和使用任意变量，但在授权上下文中有两个变量特别重要：</p><p>X-Hasura-Role：该变量表示用户执行当前请求所使用的角色。Hasura有一个内置的角色概念，并将显式地查找此变量来推断角色。</p><p>我们可以从Hasura控制台创建新角色-这些角色只是任意名称。一旦创建了角色，我们就可以为架构中的每个表设置SELECT、INSERT、UPDATE和DELETE权限。权限规则是如下所示的JSON对象：</p><p>上面的规则相当于这样说：如果user_id列的值等于会话变量X-Hasura-User-ID的值，则允许在当前行上执行此请求。</p><p>这里的JSON本质上是一种用于表示授权规则的域语言。可以表达相当复杂的规则：</p><p>可以使用多个运算符(_gt、_lt、_in等)来代替_eq运算符。</p><p>作为规则执行的一部分，甚至可以查询与当前对象无关的表(稍后还会详细介绍)。</p><p>所有这些都记录在官方文件中。现在让我们看看如何将这些应用到现实世界中。</p><p>考虑一个简单的HRMS系统，角色为HR、Employee、Manager和Director。我们要实现以下授权规则：</p><p>一旦在Hasura中创建了上述模式和关系，我们就可以创建自定义角色HR、Employee和Manager。然后，我们需要在薪资表上为每个角色创建以下权限规则：</p><p>现在假设我们希望经理只能读取或更新他们的报告对象工资单(但不能读取或更新其他员工的工资单)。假设&#34；Employee&34；从Payroll到Employee(使用Employee_id)和&#34；manager&#34；从Employee到Employee(使用manager_id)的关系，我们需要将Payroll表中角色经理的选择和更新规则更改为：</p><p>上面的规则告诉Hasura获取与工资记录相关联的员工，并将他们的manager_id与当前用户id进行匹配。Hasura可以遍历任意嵌套的关系，使其成为一个强大的构造。此外，我们需要设置列更新权限，以便只能更新薪资字段：</p><p>让我们看一个更复杂的示例：Google Docs克隆，其中每个文档都有文档、用户和角色。每个文档都可以具有具有以下规则的所有者、编辑者和查看者：</p><p>在这种情况下，我们可以使用单个Hasura角色用户，并在模式中直接建模每个文档的角色。数据库模式和关系如下所示：</p><p>在Hasura中创建上述模式和关系后，我们可以在Documents表上为Hasura角色用户配置以下权限规则：</p><p>{&#34；_or&#34；：[{&#34；所有者&#34；：{&#34；user_id&#34；：{&#34；_eq&#34；：&#34；X-Hasura-User-ID&#34；}，{&#34；编辑者&#34；：{&#34；user_id&#34；：{&#34；_eq&#34；：&#34；X-Hasura-User。}，{&#34；查看器&#34；：{&#34；user_id&#34；：{&#34；_eq&#34；：&#34；X-Hasura-User-ID&#34；}]}。</p><p>此规则说明了_or运算符的用法。如果数组中的三个条件中的任何一个匹配，则将应用该规则。</p><p>任何用户都可以插入文档。但是，每当创建文档时，我们都需要确保Owners表也与(user_id，document_id)元组一起填充，以便选择、更新和删除不会失败。这可以通过设置Postgres事件触发器来完成：</p><p>注意：在此示例中，有两个基于角色的系统在运行：Hasura的内置基于角色的访问控制系统，以及使用上述数据库架构和权限规则实现的基于文档的基于角色的访问控制系统。就Hasura的系统而言，所有请求都是针对用户角色执行的。</p><p>在基于角色的分层访问控制系统中，角色被安排成层次结构，具有角色的用户将有权访问该角色或子角色有权访问的任何内容。</p><p>示例：考虑具有以下角色层次结构的组织：Employee&gt；Lead&&gt;Manager&gt；Director&gt；Department_Head。层次结构中级别较高的用户应该能够执行层次结构中级别较低的人可以执行的任何操作。例如，经理应该能够做领导或员工能做的任何事情。看待这一点的另一种方式是，经理被分配了多个角色[经理、领导、工程师]，如果这些角色中至少有一个角色有权访问资源，他们就可以访问该资源。</p><p>对于此示例，我们将再次使用单个Hasura角色用户，并直接对模式中的角色建模：</p><p>我们还假设有一个只有经理才有权访问的DOCUMENTS表。</p><p>为了将用户与层次结构中的所有适用角色进行匹配，我们需要递归遍历角色表以获取所有角色。虽然Hasura的DSL允许我们遍历关系，但我们不能递归地这样做。因此，我们必须想出一种方法来扁平化角色层次结构。假设我们魔术般地创建了以下视图：</p><p>FLATEED_USER_ROLES(USER_ID，ROLE_ID)：这将包含遍历角色层次结构并创建所有可能的(USER_ID，ROLE_ID)组合的结果。</p><p>{&#34；_EXISTS&#34；：{&#34；_TABLE&#34；：{&#34；TABLE&#34；：&#34；FLATEED_USER_ROLES&#34；，&#34；SCHEMA&#34；：&#34；PUBLIC&#34；}，&#34；_WHERE&#34；：{&#34；_AND&#34；：[{&#34；USER_ID&#34；：{&#34；USER_ID&#34；：{&#34；_eq&#34；：&#34；X-Hasura-User-ID&#34；}}，{&#34；Role_id&#34；：{&#34；_eq&#34；：&#34；经理&#34；}}]}}。</p><p>上面的规则说明了_EXISTS运算符的用法。_EXISTS允许我们编写查询与被访问行无关的表的规则。如果_WHERE子句中的条件至少产生一行，则规则成功。</p><p>在上面的查询中，我们创建了一个视图，该视图生成分层的USER_ROLES表的平面化版本。</p><p>练习：您将如何实现同样是分层的基于每个资源的基于角色的访问控制的场景？提示：不要使用上面的_EXISTS，而是遍历对象中的关系。</p><p>注意：此示例还显示了如何对一个用户可以拥有多个角色的场景进行建模。Hasura的内置基于角色的访问控制系统目前只允许针对单个角色执行请求。但是，通过直接在数据库中对角色建模，我们可以实现一个用户具有多个角色的场景。我们还在努力将多角色支持直接添加到Hasura。</p><p>基于属性的访问控制是关于能够基于资源的属性编写授权规则。</p><p>示例：假设一所大学有多个系，每个系都有文档和用户。我们希望用户能够阅读属于其部门的文档。本例中的架构类似于：</p><p>假设定义了从文档到部门的部门关系，以及定义了从部门到用户的用户关系，则DOCUMENTS表上的SELECT权限为：</p><p>在这篇文章中，我们研究了几个实际用例的授权规则的实现。在此过程中，我们学习了编写一些相当复杂的规则的语法。组织中分层角色下的示例使用视图来处理更复杂的场景。如果您想了解更多信息，请执行以下操作：</p><p>如果您正在使用Hasura并且需要授权方面的帮助，或者想要分享您已经实现的一些有趣的用例，请联系我们，或者发推文给我们@HasuraHQ！</p><p>Hasura是一个开源引擎，在新的或现有的Postgres数据库上为您提供实时的GraphQL API，内置支持缝合自定义GraphQL API并在数据库更改时触发WebHook。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://hasura.io/blog/hasura-authorization-system-through-examples/">https://hasura.io/blog/hasura-authorization-system-through-examples/</a></div><div class="story_tags page_narrow"></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>