<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>硬编码密码、未经验证的令牌和其他常见的JWT错误</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">硬编码密码、未经验证的令牌和其他常见的JWT错误</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-27 18:36:25</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/6/f391e1a2a131171137b982df3ec75d79.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>JWT(JSON Web Token)是一个开放标准(RFC7519)，它定义了一种在双方之间的JSON对象内提供信息的方法。本标准旨在帮助安全地传输信息，但任何标准或技术在使用不当时都不会保护您。</p><p>为了确定在Node.js中使用JWT时可能出错的地方，我对使用最流行的JWT库的NPM模块进行了安全检查。使用静态分析工具，我检查了2000个NPM模块的安全弱点和漏洞。这篇文章总结了我在研究过程中发现的一些常见错误，包括：</p><p>除了描述这些问题以便您可以避免它们之外，这篇文章还包括开放源码规则，使您可以更容易地手动审核代码库以检测它们，或者将这些漏洞包含在CI中，这样这些漏洞从一开始就不会合并到您的代码中。</p><p>最基本的错误是将硬编码的秘密用于JWT生成/验证。这使得攻击者能够在源代码(以及其中的JWT秘密)公开暴露或泄露的情况下伪造令牌。</p><p>这不仅引入了漏洞，还被认为是软件反模式。您应该将JWT机密与代码分开，例如，在单独的配置文件或环境变量中。</p><p>const jwt=REQUIRED(&#34；jsonwebToken&#34；)；const Secure=&#34；硬编码-SECRET-HERE&#34；；//😈类{静态签名(Obj){返回jwt.。sign(obj，ret，{})；}}。</p><p>值得一提的是，使用JWT的一种流行方式是在其他库中使用，例如通过Passport，这是一种流行的Node.js身份验证中间件。</p><p>var JwtStrategy=Required(&#39；Passport-Jwt&39；).Strategy，ExtractJwt=Required(&#39；Passport-Jwt&39；).ExtractJwt；var opts={SecretOrKey：&#39；Hard code-Secure-Here；//😈}Passport。use(new(opts，function(JWT_PARYLOAD，DONE){//code}))；</p><p>尽管这是一个已知且相当明显的问题，但在开发时使用硬编码的秘密，然后意外地将其留在代码库中的情况仍然很常见。幸运的是，使用SAST工具查找硬编码密码也非常容易，特别是使用Semgrep，它可以帮助查找规则非常简单的复杂代码模式。用于检测硬编码密码的规则：</p><p>几年前，允许令牌具有无算法是一个严重的漏洞。现在，大多数流行的JWT库在没有显式启用None算法的情况下都不允许使用None算法解码或验证令牌。与硬编码的秘密一样，在测试或调试后很容易在代码库中留下‘&#39；NONE&#39；`。</p><p>让JWT=REQUIRED(&#34；jsonwebToken&#34；)；let Secure=&#34；Some-Secret&#34；；JWT。验证(&#34；Token-here&#34；，Secret，{算法：[&#34；RS256&#34；，&#34；None&#34；]})；//😈&#39；None&#39；Allowed。</p><p>无论如何，如果您在处理代码后忘记删除它，使用Semgrep.Rules检测代码中允许的“None”算法也很容易捕捉到它：</p><p>有时开发人员依赖自己的令牌验证方法，而不是使用内置的API，或者完全省略验证，难怪这通常会给攻击者带来伪造令牌内信息的机会。</p><p>const JWT=Required(&#34；jsonwebToken&#34；)；const checkToken=(Token，fresh hToken，Key)=&gt；{if(JWT.。Verify(Refresh Token，Key)){//😈只有`renhToken`验证返回jwt。DECODE(TOKEN).param=JWT。decode(Fresh HToken).param；}返回FALSE；}；</p><p>注意：在上面的示例中只验证了fresh hToken，这给攻击者提供了操纵函数结果的机会。通过更改存储在令牌中的参数属性值，攻击者可以强制checkToken函数的结果为TRUE并通过验证。</p><p>最重要的是，在验证令牌(发布日期、ID等)之前，从令牌获取某些数据是非常典型的。然后将其用作验证上下文。通常情况下，它是无害的，但前提是这些数据不会进一步深入。如果未经验证的令牌中的信息被传递到代码的其他部分，则可能会引入漏洞。</p><p>//令牌验证逻辑const jwt=request(&#34；jsonwebToken&#34；)；函数checkToken(Token){const颁发者=jwt。DECODE(TOKEN).Issuer；IF(findIssuer(Issuer)&amp；&amp；JWT.。验证(标记，密钥){//此处的代码}否则{抛出新的(&#34；不是有效的标记&#34；)；}}//来自不同模块函数findIssuer(ISS)的数据库实用程序{//.。数据库。查找(ISS)；}。</p><p>(在上面的示例中，未经验证的颁发者值在验证令牌(https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A1-Injection).)之前传递给另一个函数。如果不小心使用，它可能会导致不同类型的注入漏洞，特别是当它位于代码库的不同部分时。)。</p><p>另外，不要忘记，即使令牌经过正确验证，其中存储的数据也应该被视为用户输入，并根据上下文进行验证和清理。</p><p>在将对象转换为JWT令牌时，如果没有显式地将其拆分成几个部分，很容易失去对对象内部内容的控制，从而泄露一些敏感信息。</p><p>在使用Mongoose、Sequelize等ORM库时，这是一个非常普遍的错误。ORM模型在创建时不包含任何敏感数据，但是当情况发生变化时，很容易忘记ORM对象也会传递给JWT令牌。</p><p>//Mongoose model const mongoose=Required(&#39；mongoose&#39；)，Schema=mongoose.Schema；const schema=new({name：string，password：string，admin：boolean})；const user=mongoose。model(&#39；LocalUser&#39；，schema)；//Express控制器路由器。POST(&#39；/登录&#39；，(请求，资源)=&gt；{用户。findOne({name：req.body.name}，function(err，user){var Token=JWT.。Sign(User，Key，{expiresIn：60*60*10})；//😈将User对象直接传递给JWT res。json({SUCCESS：TRUE，Message：&#39；享受您的Token！&#39；，Token：Token})；})；}。</p><p>这些是开发人员在Node.js项目中使用JWT时最常犯的错误。确保安全，不要忘记在代码库中自动执行安全扫描。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://r2c.dev/blog/2020/hardcoded-secrets-unverified-tokens-and-other-common-jwt-mistakes/">https://r2c.dev/blog/2020/hardcoded-secrets-unverified-tokens-and-other-common-jwt-mistakes/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/密码/">#密码</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/编码/">#编码</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/secrets/">#secrets</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/jwt/">#jwt</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1008233.html"><img src="http://img.diglog.com/img/2020/6/thumb_ae1b0d14a5e7c82573895249260a1316.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008233.html">Safari 14将允许你用脸或手指登录网站</a></div><span class="my_story_list_date">2020-6-26 1:10</span></div><div class="col-sm"><div><a target="_blank" href="/story/1008083.html"><img src="http://img.diglog.com/img/2020/6/thumb_136716afd1a6b9ec6e6a174c980cf5b9.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008083.html">
密码初创学校：密码令牌的法律和筹款意义</a></div><span class="my_story_list_date">2020-6-25 13:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007372.html"><img src="http://img.diglog.com/img/2020/6/thumb_a6604aac190d5f253fe7d8f25a8fbf4a.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007372.html">让他们粘贴密码(2017)</a></div><span class="my_story_list_date">2020-6-20 11:1</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007259.html"><img src="http://img.diglog.com/img/2020/6/thumb_221c361a9d2362dc17c8204d4ee69342.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007259.html">Pwned密码，版本6</a></div><span class="my_story_list_date">2020-6-19 22:9</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>