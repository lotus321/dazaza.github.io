<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>使用OSSEC和Suricata入侵检测系统实现简单的Web服务器保护</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">使用OSSEC和Suricata入侵检测系统实现简单的Web服务器保护</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-27 07:30:17</div><div class="page_narrow text-break page_content"><p>这个设置的想法是保护小系统，就像我们保护大系统一样。</p><p>此解决方案使用经过验证的堆栈来保护Web服务器免受现代威胁。使用OSSEC、Suricata和现代Linux系统的内置防火墙功能，可以构建维护成本低、性能影响相对较小的稳定威胁防护平台。</p><p>它是专门设计成简单的。这个想法是，它会让你保持“需要知道的基础”，否则就会保持沉默，做好自己的工作。</p><p>这些组件共同保护Web服务器免受黑客、机器人、垃圾邮件发送者和其他令人讨厌的网络攻击。</p><p>然而，这个系统有一些实质性的限制。但事实并非如此：</p><p>可能不会让您通过HIPAA/FIPS/PCI-DSS审核员-这将涉及更多。</p><p>在这篇文章中，我将使用RFC-5737指定的公有IPv4地址。这些将代表使用的三台主机：</p><p>这些IPv4地址是“假的”且不可路由。别用这些东西尝试任何奇怪的东西。</p><p>由于通知的主要方式将是旧式电子邮件，所以这是最值得关注的地方。</p><p>要发送监控电子邮件，我们需要将Mailgan设置为SMTP中继。这通过使用邮件中继的专用子域(Postfix服务器将连接到该子域)稍微简化了操作。它还可以防止服务器持有主电子邮件帐户的凭据。</p><p>Mailgan基本上是免费的，但它确实需要支付信息，以防止系统被滥用。</p><p>设置帐户后，将验证域‘example.com’，并将所需的TXT和MX记录添加到DNS区域。我将在此项目中使用“mail.example.com”，我的主电子邮件服务器位于根“example.com”域下。</p><p>设置完成后，向导将生成一组SMTP凭据。将这些保存到下一步。</p><p>在服务器上，使用Postfix包设置邮件中继。这将允许服务器向管理邮箱发送电子邮件，但它将无法接收或读取其自身假脱机之外的任何邮箱。</p><p>myNetworks=127.0.0.0/8，[：：1]/128 inet_interface=127.0.0.1 relayhost=[smtp.mailgan.org]：587 smtp_sasl_auth_enable=yes smtp_sasl_password_map=hash：/etc/postfix/sasl_passwd smtp_sasl_security_options=no匿名SMTP_TLS_Cafile=/etc/ssl/certs/Thawte_Primary_Root_。DEFER_UNAUTH_Destination ALIAS_MAPES=hash：/etc/aliases alias_database=hash：/etc/aliases smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key smtpd_use_tls=yes。</p><p>如果电子邮件在一两分钟内没有到达，请仔细检查配置并在系统日志中查找线索。</p><p>Suricata是我一直以来最喜欢的安全监控工具之一。它速度快、可伸缩，使用的资源少得惊人，并且可以创建高质量的网络警报。我之前在另一个自定义防火墙/IDS设备的项目中使用过它。在此项目中，它将仅用于生成警报摘要。</p><p>然后，可以在系统上安装软件包本身以及所有运行时依赖项。</p><p>安装后，要进行的最重要的配置更改是禁用eve.json日志输出。虽然这在构建SIEM时非常有用，但我们正在做一些简单得多的工作，因此写入每个到达服务器的数据包的磁盘空间使用量不是一个好主意。</p><p>则可以加载一组规则。在版本4和更高版本中，所有规则管理都是通过Suricata-update实用程序处理的。因此，可以下载并安装初始规则集(ET Open)。</p><p>OSSEC是一个基于主机的入侵检测系统，在该领域有着良好的记录。虽然它具有很强的可扩展性，可以将数百个节点连接到一台中央服务器，但对于此部署，我们将安装单个独立系统。</p><p>OSSEC的维护人员已经发布了一个易于安装的脚本。在设置APT存储库和密钥方面，它似乎工作得相当好。</p><p>安装程序包和依赖项后，停止该服务，直到可以完全配置它。</p><p>OSSEC的大多数配置部分对普通Linux用户是隐藏的，因此在本部分的其余部分中，我们必须以交互式root用户身份运行：</p><p>主配置文件位于/var/ossec/etc/ossec.conf，结构为XML。第一个要更改的部分是“global”部分中的电子邮件通知设置。值得注意的是，ossec本身并不直接发送电子邮件，而是将其传递给localhost上的本地Postfix中继服务器。</p><p>如果需要，您也可以将自己的IPv4地址列入白名单。如果您做了一些愚蠢的事情，这将防止被锁定在系统之外。</p><p>接下来，根据需要修改电子邮件警报阈值。默认级别是“7”--这确实给出了很多关于完整性更改的有用的通知，虽然有点垃圾。如果这不是我们想要的，可以增加。在我的例子中，我更喜欢在我的云服务器上设置无人值守升级，这样它们就可以保持最新的安全补丁。这可能会产生许多不必要的电子邮件警报，这些警报非常烦人。与所有与安全相关的事情一样，也有权衡之处。</p><p>主动响应是一个内置系统，它将采取行动阻止检测到的攻击。在基本的OSSEC安装中，它的配置是合理的-但是，一旦我们添加了网络警报，它就可以迅速开始阻止合法流量。因此，默认干预级别将从7增加到9。我还建议将“禁止时间”从默认的(30分钟)减少到5分钟，直到所有误报都能解决为止。</p><p>&lt；！--活动响应配置--&gt；&lt；active-response&gt；&lt；command&gt；host-Deny&lt；/command&gt；&lt；location&gt；local&lt；/location&gt；level&gt；9&lt；/level&gt；&lt；timeout&gt；300&lt；/timeout&gt；&lt；/active-Response。/command&gt；&lt；location&gt；local&lt；/location&gt；&lt；level&gt；9&lt；/level&gt；&lt；timeout&gt；300&lt；/timeout&gt；&lt；/Active-Response&gt；</p><p>最后，最重要的一块是指示OSSEC读取Suricata警报日志。这使监控系统能够全面了解操作系统行为和传入/传出网络活动。</p><p>可以在启动后检查日志文件/var/ossec/logs/ossec.log中的错误。如果成功，应该会在启动后一分钟内发送一封电子邮件。</p><p>OSSEC HID通知。2020 May 16 02：17：16接收者：my-Cool-server-&gt；ossec-monitor规则：502已触发(级别3)-&gt；&#34；Ossec服务器已启动。&#34；部分日志：ossec：ossec已启动。</p><p>不添加自定义规则，OSSEC对网络IDS警报的理解相当基本，只在第一次触发“新的”Suricata/Snort警报时生成8级警报。幸运的是，我们可以添加一些规则来帮助理解Suricata输出。请记住，Suricata警报的范围从1到3，其中1是最严重的，而ossec警报的范围从0到15，15是最严重的。</p><p>&lt；组名称=&#34；Snort-FAST，&#34；&gt；&lt；！--如果识别到1级威胁，则发出警报-&&gt；&lt；规则ID=&#34；300011&#34；级别=&#34；10&#34；&gt；类别&&gt;ID&lt；/类别&&gt;&lt；匹配&&gt;；[优先级：1]&lt；/匹配&/Description&gt；&lt；/规则&&gt;&lt；！--如果识别到多个1级威胁，则发出警报--&&gt;规则ID=&#34；300012&#34；规则ID=&#34；11&#34；频率=&#34；5&#34；时间范围=&#34；120&#34；忽略=&#34；90&#34；&gt；&lt；IF_MATCHED_SID&gT；300011&lt；/IF_MATCHED。SAME_SOURCE_IP/&&gt;&lt；描述&&gt;许多高严重性Suricata警报&lt；/描述&&gt;&lt；/规则&&gt;&lt；规则id=&#34；300013&#34；级别=&#34；12&#34；频率=&#34；10&#34；时间范围=&#34；120&#34；忽略=&#34；90&#34；&gt；&lt；IF_MATCHED。&lt；Same_Source_IP/&lt；说明&lt；几个严重程度很高的Suricata警报&lt；/说明&&gt;；/规则&&gt;规则id=&#34；300014&#34；级别=&#34；13&#34；频率=&#34；20&#34；时间范围=&#34；120&#34；忽略=&#34；90&#34；&gt；&lt。/IF_MATCHED_SID&&gt;&lt；Same_source_IP/&gt；&lt；description&gt；许多高严重性Suricata警报&lt；/Description&gt；&lt；/Rule&gt；&lt；规则ID=&#34；3000015&#34；Level=&#34；14&#34；频率=&#34；50&#34；TimeFrame=&#34；120&#34；忽略=&#34；90。300011&lt；/if_matching_sid&gt；&lt；Same_source_IP/&lt；&lt；description&gt；多个高严重性Suricata警报&lt；/description&gt；&lt；/RULE&&gt;；&lt；/GROUP&gt；</p><p>&lt；组名称=&#34；Snort-FAST，&#34；&gt；&lt；！--如果识别到2级威胁，则发出警报-&&gt；&lt；规则ID=&#34；300001&#34；级别=&#34；7&#34；&gt；类别&&gt;ID&lt；/类别&&gt;&lt；匹配&&gt;；[优先级：2]&lt；/匹配&/Description&gt；&lt；/Rule&&gt;；&lt；！--如果识别到多个2级威胁，则发出警报--&&gt;规则ID=&#34；300002&#34；规则ID=&#34；8&#34；频率=&#34；5&#34；时间范围=&#34；120&#34；忽略=&#34；90&#34；&gt；&lt；IF_MATCHED_SID&gT；300001&lt；/IF_MATCHED。SAME_SOURCE_IP/&&gt;&lt；描述&&gt;许多中等严重程度的Suricata警报&lt；/描述&&gt;&lt；/规则&&gt;&lt；规则id=&#34；300003&#34；级别=&#34；9&#34；频率=&#34；10&#34；时间范围=&#34；120&#34；忽略=&#34；90&#34；&gt；&lt；IF_MATCHED。&lt；Same_Source_IP/&lt；说明&lt；几个中等严重程度的Suricata警报&lt；/说明&&gt;；/规则&&gt;规则id=&#34；300004&#34；级别=&#34；10&#34；频率=&#34；20&#34；时间范围=&#34；120&#34；忽略=&#34；90&#34；&gt；&lt。/IF_MATCHED_SID&&gt;&lt；Same_source_IP/&gt；&lt；Description&gt；许多中等严重程度的Suricata警报&lt；/Description&&gt;&lt；/Rule&gt；&lt；规则ID=&#34；300005&#34；Level=&#34；11&#34；Frequency=&#34；50&#34；Timeframe=&#34；120&#34；Ignore=&#34；90(忽略规则=&#34；&#34；级别=&#34；11&#34；频率=&#34；50&#34；时间范围=&#34；120&#34；忽略=&#34；90。300001&lt；/if_matching_sid&gt；&lt；Same_source_IP/&lt；&lt；description&gt；多个中度严重Suricata警报&lt；/Description&gt；&lt；/RULE&&gt;；&lt；/GROUP&gt；</p><p>设置完成后，可以在系统上执行一些测试。最有可能创建警报的是简单地nmap系统：</p><p>一两秒钟内，Suricata日志文件中将生成许多警报。然后，OSSEC将拾取这些内容并将其添加到警报假脱机。接下来，将对这些警报进行聚合和计数，这将触发严重程度更高的事件。理想情况下，这将生成如下电子邮件警报：</p><p>OSSEC HIDS通知。2020-05-14 22：10：18接收来源：my-cool-server-&gt；/var/log/suricata/fast.logRule：300012已发射(11级)-&&gt;许多严重程度较高的Suricata警报&#34；SRCIP：192.0.2.241Dst IP：198.51.100.241：35004-&gt；198.51.100.241：35004-&gt；198.51.100.44：198.51.100.44：80.日志的部分：05/14/2020-22：10：17.391373[1：100.44：3]ET扫描可能的网络映射用户代理[**][**][分类：网络应用程序攻击][优先级：1]{tcp}192.0.2.241：192.51.100.241-&gt；198.51.100.44：80.。--通知结束。</p><p>如果你幸运的话，这也会产生积极的反应。当这种情况发生时，OSSEC将向iptables添加防火墙阻止，以阻止与“违规”端点进行任何通信。</p><p>在暴露在互联网上几天之后，很可能会有一两个机器人试图入侵你的服务器。因此，如果有一段时间，应该会有一两封这样的电子邮件：</p><p>OSSEC HID通知。2020-05-17 20：16：34接收者：my-cool-server-&gt；/var/log/suricata/fast.logRule：300011已发射(10级)-&&34；Suricata Level 1警报&#34；源IP：192.0.2.241Dst IP：198.51.100.44日志的部分：05/17/2020-20：16：33.926136[**][1：2029790：3]ET SCAN ELF/MIRAI变体用户代理(入站)[**][分类：尝试的管理员权限获取][优先级：1]{tcp}192.0.2.241：47586-&gt；198.51.100.44：80--通知结束。</p><p>由于它生成了高度严重的网络警报，因此立即阻止了入侵，并禁止了违规的IP。您可以在日志文件中找到以下内容：</p><p>在所有部件都设置好之后，这就变成了一个维护成本相当低的系统。当然，也会发生IDS/IPS阻塞某些合法流量的事件。但这是现代安全领域生活的一部分。</p><p>随着高调的黑客攻击和网络攻击越来越频繁，我们都有责任尽最大努力保护我们的服务器。</p><p>由Disqus提供支持的评论</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://nbailey.ca/post/security-monitoring-ossec-suricata/">https://nbailey.ca/post/security-monitoring-ossec-suricata/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/服务器/">#服务器</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/webserver/">#webserver</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/警报/">#警报</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1003680.html"><img src="http://img.diglog.com/img/2020/5/thumb_1fb6a69fd2d506e6dcdae7a97a49fff4.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003680.html">数以千计的企业系统被新的蓝色知更鸟恶意软件团伙感染</a></div><span class="my_story_list_date">2020-5-25 20:55</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003371.html"><img src="http://img.diglog.com/img/2020/5/thumb_e13e58e6d1ca26e930f7e97a50c07ffb.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003371.html">AWS中典型的100%无服务器架构是什么样子</a></div><span class="my_story_list_date">2020-5-23 14:13</span></div><div class="col-sm"><div><a target="_blank" href="/story/1001330.html"><img src="http://img.diglog.com/img/2020/5/thumb_3b52d88c0f7c602935a2c43fac9a7161.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1001330.html">异步GraphQL：Rust中功能最全的GraphQL服务器框架</a></div><span class="my_story_list_date">2020-5-9 5:53</span></div><div class="col-sm"><div><a target="_blank" href="/story/1001273.html"><img src="http://img.diglog.com/img/2020/5/thumb_fb2c06f705770a38d910e0c084291fc3.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1001273.html">如何用一封电子邮件使电子邮件服务器崩溃(2018)</a></div><span class="my_story_list_date">2020-5-8 22:34</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>