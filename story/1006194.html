<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>运行更少的测试来激发快乐</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">运行更少的测试来激发快乐</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-12 04:10:34</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/6/6e32d6e6f95f61e42d10d823c6799b54.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>开发人员编写测试以确保正确性，并允许安全地进行未来的更改。然而，随着功能数量的增加，测试的数量也在增加。考试是一把双刃剑。一方面，编写良好的测试捕获错误并维护程序的稳定性，但随着代码库的增长，大量测试会阻碍可伸缩性，因为它们需要很长时间才能运行，并增加间歇性测试失败的可能性。软件项目通常要求在合并到MASTER之前通过所有测试。这增加了所有开发人员的开销。间歇性的测试失败加剧了问题的恶化。间歇性失败的一些原因是数据库中的不稳定性HTTP连接/模拟随机生成器将状态泄露给其他测试：测试每次都会自己通过，但其他测试会根据顺序而失败。不幸的是，不能完全消除间歇性失败的测试，并且随着代码库的增长，发生间歇性失败的可能性也会增加。它们使已经很慢的测试套件变得更慢，因为现在您必须重试它们，直到它们通过为止。我并不是说不应该编写测试。质量保证、性能监控和通过及早捕获错误(而不是在生产中)来加速开发的好处大于坏处。不过，我们可以作出改善。因此，我的团队开始了使我们的持续集成(CI)更稳定、更快的旅程。我将分享动态分析系统来选择我们实现的测试，然后是我们探索过但决定不采用的其他方法。考试选择给我的生活带来了欢乐。我希望我能给你们带来同样的快乐。ShopifyTests的测试问题阻碍了这里的开发人员的工作效率。我们的单片式存储库的测试套件：每年有超过150,000个测试以20-30%的大小增长，在数百个码头容器上并行运行大约需要30-40分钟。每个拉请求都需要通过所有测试。开发人员要么等待测试，要么为上下文切换付出代价。在我们一年两次的调查中，构建稳定性和速度是一个反复出现的话题。所以我们的开发人员清楚地感觉到了这个问题。用测试解决这个问题关于优化代码的博客文章/文章/研究论文很多，不幸的是，关于测试的文章很少。事实上，我们了解到优化测试是不现实的，因为纯粹的数量和增长。我们还了解到，对于许多公司来说，这是一个未知的领域。随着我们研究的进展，很明显，正确的解决方案是只运行与代码更改相关的测试。对于充分利用语言灵活性的大型动态类型Ruby代码库来说，这是一个挑战。此外，Rails中的元编程以及代码库中影响应用程序行为的其他非Ruby文件(例如YAML、JSON和JavaScript)加剧了这一困难。什么是动态分析？动态分析本质上就是记录每个方法调用。我们运行每个测试并跟踪调用图中的所有文件。一旦有了调用图，我们就创建一个测试映射：对于每个文件，我们都会找到哪些测试在其调用图中包含该文件。通过查看哪些文件已被修改、添加、删除或重命名，我们可以查找需要运行的测试。您可以签出Rotcope和Tracepoint来记录Ruby应用程序的调用图。为什么要使用动态分析？Ruby是一种动态类型的语言，我们不能使用静态分析检索依赖图。因此，我们不知道代码的相应测试。在铁路1上运行Ruby动态分析的同时。它很慢，生成调用图是计算密集型的，而且我们不能对每一个PR都运行它。取而代之的是，我们对每个部署的委托运行动态分析。映射可能滞后于HEAD生成的映射滞后于主服务器的头部，因为它是异步运行的。要解决此问题，我们将运行至少满足以下条件之一的所有测试：根据当前分支的代码更改在当前分支上添加或修改上一次生成的映射的头部和当前分支的头映射测试之间添加或修改的测试3。存在无法跟踪的文件在调用图上存在无法跟踪的非Ruby文件，如YAML、JSON等。我们向Rails添加了自定义补丁，以跟踪其中一些补丁。例如，我们修补了I18n：：Backend类以跟踪YAML中的转换文件。对于尚未跟踪的文件更改，我们会运行每一个测试。元编程混淆调用路径我们在已知目录中添加了现有的元编程，并在文件路径上添加了全局规则以确定要运行哪些测试。我们不鼓励通过冰糕和其他链接进行新的元编程。一些失败的测试将不会被捕获动态分析生成的映射可能会与最新的主文件过期，有时失败的测试不会被选中并合并到主文件中。为了绕过这个问题，我们运行完整的测试套件e</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://engineering.shopify.com/blogs/engineering/spark-joy-by-running-fewer-tests">https://engineering.shopify.com/blogs/engineering/spark-joy-by-running-fewer-tests</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/测试/">#测试</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/joy/">#joy</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1005677.html"><img src="http://img.diglog.com/img/2020/6/thumb_046bb039a85c02a260ee0165e8eae169.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005677.html">我们对西部数据可怕的SMR Red Drive进行了测试</a></div><span class="my_story_list_date">2020-6-8 18:48</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005480.html"><img src="http://img.diglog.com/img/2020/6/thumb_08f0dd6791223510718f97e3fcd2cede.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005480.html">一种新的人工智能眼科考试减少了74%的错误</a></div><span class="my_story_list_date">2020-6-7 3:40</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004758.html"><img src="http://img.diglog.com/img/2020/6/thumb_c57ff7163517e348ab3d81e7dece1198.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004758.html">MPWTest：通过超越Xunit模型来减少测试摩擦</a></div><span class="my_story_list_date">2020-6-2 7:14</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004325.html"><img src="http://img.diglog.com/img/2020/5/thumb_2c2cd7da89ba329a2b3d6191d0a22b63.gif" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004325.html">SpaceX的星际飞船SN4运载火箭原型在发动机静态点火试验后爆炸</a></div><span class="my_story_list_date">2020-5-30 5:35</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>