<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>逆向工程Snapchat(第二部分)：对Undeobfuscatable进行去模糊处理</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">逆向工程Snapchat(第二部分)：对Undeobfuscatable进行去模糊处理</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-22 09:38:06</div><div class="page_narrow text-break page_content"><p>许多黑客新闻用户建议使用仿真来生成令牌，将整个事情视为一个黑匣子。正如我在评论中提到的，这个解决方案的问题是有太多真实的设备依赖。X-Snapchat-Client-Auth-Token不是随机胡言乱语。它包含很多关于设备的加密信息。即使您使用Corellium，我也只能说它工作的机会微乎其微。除了扭转它，我看不到其他选择。</p><p>首先，所有这些怪物是如何实现的？当您使用clang编译hello.c时，clang只是前端，llvm才是真正的代码；这意味着clang获取C源代码并将其转换为中间表示(IR)1，然后llvm解释该IR，优化并将其编译为机器码。这个系统的优点是后端仍然与语言无关，您只需为每种语言编写一个与LLVM-IR兼容的前端，其余的留给llvm。现在我们感兴趣的是优化，也就是优化过程。llvm对IR进行操作以生成更高效的代码，这些代码在汇编语言中看起来可能与您预期的略有不同，这就是产生混淆的原因；我们可以随心所欲地更改代码，只要我们保持语义，而不是实际优化代码。这就是O-LLVM2在编译器级别的工作方式，因为没有人能像那样维护源代码。(O-LLVM背后的团队现在被Snap3收购了)如果我们理解混淆，难道我们不能反其道而行之，生成类似于原始程序集的东西吗？正如一位Hackernews用户4所阐述的那样，模糊处理大多是有损的；您可以随意去模糊(许多很酷的库5允许您这样做)，但是直接接触二进制文件要好得多。</p><p>“Evan Spiegel讨厌这个把戏！”：或者，如何绕过断点检查。</p><p>这可能会结束我的Snapchat逆转职业生涯(或者实际上是整个帖子)。这个二进制文件的最大障碍之一是FUKUP_DEBUGING。因此，您将无法进行任何类型的动态分析(在我看来，这是在这个二进制文件中进行的唯一方法)。而且，您不能修补FUKUP_DEBUGING以返回正确的PATH_KEY，从而使其执行正确，而不是无限循环，因为有反篡改检查来阻止您以修改后的二进制文件与服务器通信。但是首先，您如何才能获得正确的path_key呢？根据定义，您必须设置一个断点，这样您才能在第一时间进入FUKUP_DEBUGING。是死锁吗？让我们来看看它的运行情况：在这里，我们在返回令牌的函数中，这是调用FUKUP_DEBUGING的块，我知道这是因为当我调试它时，紧随其后的块是一个无限循环。</p><p>mov x8，#0x4458movk x8，#0x1e6，LSL#16movk x8，#0x1，LSL#32movk x8，#0x0，LSL#48mov x9，#0x4714movk x9，#0x1e6，LSL#16movk x9，#0x1，LSL#32movk x9，#0x0，LSL#48add x1，x1FUKUP_DEBUGING调用adrp x8，0x109e5b000ldr w8，[x8，#0x6a8]EOR w8，w8，w0；返回path_keycmp x8，#0xborr w9，wzr，#0x6csel x8，x9，x8，Hildrx8，[x28，x8，lsl#0x3]br x8。</p><p>如果您像我一样聪明，并且在禁用所有断点之后，使用(Lldb)ni而不是单步执行跳过funkup_debuting，您将得到一个无限循环，因为您刚刚设置了另一个断点。这是因为跳过实质上是下一条指令地址处的断点。虽然单步执行有自己的小ptrace命令(Ptrace_SINGLESTEP)6，或者换句话说，它在CPU级别执行，但没有代码修补。</p><p>FUKUP_DEBUGING的弱点是它自己不检查断点。这就是为什么您可以在其中无害地设置断点的原因。在那里，未来的Snap反向工程师在修补了这个之后面临着新的挑战。</p><p>现在，我们已经为一个函数绕过了一个断点检查。并非令牌生成中的每个函数都是断点检查的。但是现在，对于使用上述方法绕过的每个检查，您可以使用正确的路径键添加注释。因此，在未来，这将是一个问题：</p><p>我们跳过FUKUP_DEBUGING并动态修补返回值。我们的速度有点慢，因为我们必须对每个打补丁的函数执行此操作，但现在我们至少可以进行一些真正的调试。</p><p>下面是令牌在非常高的级别上发生的情况。我们有联合函数gen_Token，它调用set_Token_params，这是一个调用许多其他函数的庞大联合函数。然后，令牌被加密并从gen_Token返回。要获得这样的信息，您必须花一些时间进行二进制运算，并进行有根据的猜测，直到您有了一个大致的总体情况，然后您可以选择一些具体的东西，或者采用自下而上的方法来使其简明扼要。让我们来看一个如何反转特定令牌参数的示例。</p><p>在二进制文件的关键区域设置书签将为您节省大量时间，并让您头疼不已。例如，我在写入令牌参数的位置有书签，就在令牌被加密之前，等等。这样，我只需知道某个参数在令牌结构中的偏移量，就可以开始处理该参数，因为这是我所知道的最接近其生成位置的跟踪。但是，您首先是如何找到这些锚地址的呢？</p><p>如果您让我只给您一个词来解决您一半以上的Snap二进制问题，我会告诉您：观察点。例如，您不知道从哪里开始，但是您知道gen_Token返回令牌的指针，所以这是您的领先位置。然后在gen_Token返回之前跟踪它，您会发现该指针在gen_Token返回之前实际上是由另一个函数写入的，比如等效的C代码：</p><p>现在，在调用real_deal之前，您在TOKEN_OUT上设置了一个观察点，禁用所有断点，以便FUKUP_DEBUGING满意，然后继续执行，然后观察点将在写入/读取过程中停止该进程，将您带到代码的一个可能的临界点，您可以将其用作锚点。这是我用Snap二进制获得的第二张A。</p><p>(Lldb)w s e-w写入--$x0(Lldb)c.。现在，一旦访问了$x0处的地址，并且您有了锚地址，它就会停止。</p><p>观察点是不错的，但是寄存器呢？你不能在这些上面设置观察点，或者理论上你可以，但那是另一次了。那么，如果您感兴趣的值在寄存器中，那又如何呢？答案是执行跟踪和支持regex的文本编辑器。</p><p>假设我们在set_Token_params中，并且我们知道我们感兴趣的值在x2中：</p><p>因为这是块的开始，没有cfg，所以我们不知道x2是从哪里来的。</p><p>我所做的是使用Frida的Stalker 7从SET_TOKEN_PARAMS附近的一个点生成一个执行跟踪，我知道这个点不是由FUKUP_DEBUGING管理的；因为Frida修补指令以挂钩到函数，这将触发断点检查。现在我有了一个连续的行刑轨迹。然后，我使用一个很好的旧文本编辑器来查找上面的块，并搜索它之前的点，即写入x2的位置和数据源所在的位置。</p><p>一旦您发现某个参数是由函数gen_param1生成的，我就别无选择，只能将其反转为其高级源代码等效项。我认为C(哈哈)最适合这一点，因为您可以准确地将数据结构/类型从汇编转换为C。而且，尽管C离CPU很近，但您仍然需要了解结构对齐是如何工作的，对某些值及其类型进行合理的猜测，并跟踪所有堆栈偏移。在处理这个二进制代码的时候，我梦到了汇编指令，没有狗屎。</p><p>MBA表达式是这个二进制代码中最棘手的事情。关于MBA的最新研究表明，有两种有效的方法可以简化MBA的表达方式。让我们解释一下，然后给出一个二进制代码的例子。</p><p>在此方法9中，您将整个表达式视为一个黑盒“Oracle”，为其提供输入，观察输出，并尝试生成一个模拟该行为的函数。这样做最大的问题是，它对于复杂的表达式8来说是不切实际的。</p><p>在此方法8中，所有简化规则都是硬编码的，例如，您有一个规则：(x|y)-y+(~x&amp；y)==x^。然后，您尝试递归地将规则与表达式匹配，然后使用SMT解算器来证明原始表达式与简化色调相同。这样做的问题是，规则不像布尔/代数简化那样通用，因此它无法处理硬编码之外的表达式。</p><p>第一步是从二进制文件中提取表达式，我们可以使用符号执行10。这基本上是一种执行二进制文件的方式，我们不给变量赋值，只给符号赋值。非常适合这一点的是令人惊叹的Triton 11框架。提取表达式后，对于合成，您仍然可以使用Triton 12，而对于重写规则，QuarkSlab提供了SSPAM 13，它仅是Python 2。</p><p>此示例涉及120多个指令块，其输入是来自堆栈的两个值，其输出位于4个寄存器中。最棘手的输出在x27中，所以我们将使用它。首先，我们需要提取表达式。我们使用Triton.symbizeMemory对块的输入进行符号化，然后在模拟块之后，使用Triton.getSymbolicRegister(x27).regAst().unroll()，获得寄存器中的完整表达式，准备打印到：</p><p>(0x431e33362537db49|(~(0xbac03a4c7e26a10c^((0xbac03a4c7e26a10c&amp；(~(Bss_Val1)&amp；0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)|(bss_val1&amp；(~(0xbac03a4c7e26a10c)&amp；0xffffffffffffffffff。0xffffffffffffffffffff))|(bss_val1&amp；(~(0xbac03a4c7e26a10c)&amp；0xffffffffffffffffffffffffffffffffffffffffffffff))&amp；0xffffffffffffffffffffffffffff))&amp；0xffffffffffffffff)&amp；(~(0xc92460b4173d8。0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)(~(0xc92460。0xffffffffffffffff)|(bss_val1&amp；(~(0xbac03a4c7e26a10c)&amp；0xffffffffffffffffffffffffffffffff))&amp；0xffffffffffffffffffff)|(~(0x431e33362537db4a|(~(Bss_Val1)&amp；0。0xffffffffffffffff)|0x253a41858a5c76d6)-(0x431e33362537db49|(~(0xbac03a4c7e26a10c^((0xbac03a4c7e26a10c&amp；(~(Bss_Val1)&amp；0xffffffffffffffffffff)|(bss_val1&amp。(~(Bss_Val1)&amp；0xffffffffffffffffffffffff)|(bss_val1&amp；(~(0xbac03a4c7e26a10c)&amp；0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)&amp；0xffffffffffffffffffff)&amp；(~(。0xffffffffffffffffffffffffffff)-(~(Bss_Val1)&amp；0xffffffffffffffffffffffffffffffffffffff)&amp；0xffffffffffffffffffffffffffff))|(0x431e33362537db4a|(~(Bss_Val1)&amp；0xffffffffffffff))-(~(Bss_Val1)&。0xffffffffffffffffff)|(0x431e33362537db49|(~(0xbac03a4c7e26a10c^((0xbac03a4c7e26a10c&amp；(~(Bss_Val1)&amp；0xffffffffffffffffffffffffffffffffffffffffffffffffffff)|(bss_val1&amp；(~(0xbac03a4c7e26xbac03a4c7e26。0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff)。</p><p>真正的表达式没有那么可怕，因为Triton添加了位掩码。让我们看看SSPAM有什么要说的：</p><p>$sspam&#34；`cat x27_exprs`&#34；(4836359357488159561L|(~(13456819786791428364L^((13456819786791428364L&amp；(~bss_val1))|(bss_val1&amp；4989924286918123251L)。3952928246324163886L)^((14493815827385387729L&amp；(~(-(~bss_val1))+(4836359357488159562L|(~bss_val1)|(-(~bss_val1)+(4836359357488159562L|(~bss_val1)&amp；395。4989924286918123251L)|(~((-(~bss_val1))+(4836359357488159562L|(~bss_val1)^2682528569860323030L)。</p><p>那不太好。因此，SSPAM，我所知道的唯一存在的MBA重写规则的工具，并没有给出一个有意义的简化。所以我想让我们尝试一些合成，我使用Python的eval将不同的输入插入到这个表达式中，看看输出中的位有什么反应(自己试一下，很有趣)。最后，我合成的表达式是：</p><p>我看不出它会变得比这更简单，但是它与模糊的表达式相同吗？我们来问一下Z3：</p><p>令牌生成不只是迷惑。能够在这个级别使用二进制文件只是成功的一半。我不会的</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://hot3eed.github.io/2020/06/22/snap_p2_deobfuscation.html">https://hot3eed.github.io/2020/06/22/snap_p2_deobfuscation.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/逆向工程/">#逆向工程</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/工程/">#工程</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1007476.html"><img src="http://img.diglog.com/img/2020/6/thumb_70ab386d0e3f93d8c25534c61920dbfc.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007476.html">两款Game Boy音频放大器芯片的逆向工程与比较</a></div><span class="my_story_list_date">2020-6-21 6:27</span></div><div class="col-sm"><div><a target="_blank" href="/story/1006954.html"><img src="http://img.diglog.com/img/2020/6/thumb_c0678717f3a086b77f51503c5326fb9e.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1006954.html">天气控件逆向工程和自动化</a></div><span class="my_story_list_date">2020-6-17 23:21</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005820.html"><img src="http://img.diglog.com/img/2020/6/thumb_c0daa6466c8fc56511aad0fc28dea291.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005820.html">如何对卫视智能卡进行逆向工程(2008)</a></div><span class="my_story_list_date">2020-6-9 15:30</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003065.html"><img src="http://img.diglog.com/img/2020/5/thumb_3335d7569ea15a677831fb162fd1eb78.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003065.html">逆向工程任天堂Switch App REST API</a></div><span class="my_story_list_date">2020-5-21 9:36</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>