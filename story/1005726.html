<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>统计反思与NIX</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">统计反思与NIX</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-09 00:57:02</div><div class="page_narrow text-break page_content"><p>这篇文章描述了如何使用nixpkgs、niv和lori为可重现的R工作流设置透明的自动设置。整篇文章中使用的解释例子之一是建立反思包，并列举理查德·麦克雷思(Richard McElreath)优秀的第二版“统计反思”中的一些例子。</p><p>正如在前面的帖子1中详细描述的那样，我已经设置了NIX来处理非cran包。如果这一节的其余部分不清楚，请回过头来参考前面的帖子。</p><p>#shell.nix{pkgs？import&lt；nixpkgs&gt；{}}：with pkgs；let my-r-pkgs=rWrapper。覆盖{Packages=with rPackages；[ggplot2 tidyverse tidybayes tidybayes.。重新思考(buildRPackage{Name=&#34；resiking&#34；；src=fetchFromGitHub{Owner=&#34；rmcelreath&#34；；repo=&#34；rev=&#34；d0978c7f8b6329b94efa2014658d750ae12b1fa2&#34；；sha256=&#34；1qip6x3f6j9lmcmck6sjrj50a5azqfl6rfhp4fdj7ddabpb8n0z0&#34；；}；PropagatedBuildInput=[尾巴质量mvtnorm loo form rstan dagitty]；})；}；在mkShell{buildInput=。[打开卷曲的git glibcLocales OpenSSL]；inputsFrom=[my-r-pkgs]；shellHook=&#39；&#39；mkdir-p&#34；$(Pwd)/_libs&#34；export R_Libs_user=&#34；$(Pwd)/_libs&#34；&#39；&#39；；git_SSL_CAINFO=&#34；locale_archive=stdenv。利布。optionalString stdenv.。isLinux&#34；${glibcLocales}/lib/locale/locale-archive&#34；；}。</p><p>不同于npm、pipeenv、potile、conda和Friends，我的系统不会因为每次在不同项目中使用相同的包而下载和设置而变得臃肿。</p><p>然而，虽然这是从链接到RStudio和mysystem包管理器迈出的重要一步，但是这个工作流如何可重现可能还不是很明显。诚然，我已经以一种很好的功能方式定义了我的包；但是其他人可能有他们正在跟踪的不同的上行通道，因此会有不同的包。事实上，我唯一能确定的包就是我从Github构建的R包，因为这些包都绑定到一个散列上。最后，为每个项目描述的设置都非常繁琐，而且目前还不清楚如何利用像direnv这样的奇妙工具来解决这个问题。</p><p>精明的读者会注意到，我提到过R包是可重现的，因为它们与散列绑定在一起，并且可能会合理地争辩说，整个Nix生态系统首先是关于散列的。一旦我们意识到这一点，剩下的就相对简单了3。</p><p>Niv基本上跟踪所有软件包的安装通道。设置非常简单。</p><p>让Sources=import./nix/Soures.nix；pkgs=导入源。nixpkgs{}；stdenv=pkgs。stdenv；my-r-pkgs=pkgs。rWrapper。用Pkgs覆盖{Packages=。rPackages；[ggplot2 tidyverse tidybayes]；}；单位为pkgs。mkShell{buildInput=with pkgs；[git glibcLocales OpenSSL，打开卷曲wget my-r-pkgs]；shellHook=&#39；&#39；mkdir-p&#34；$(Pwd)/_libs&#34；export R_Libs_user=&#34；$(Pwd)/_libs&#34；&#39；&#39；；git_SSL_CAINFO。cacert}/etc/ssl/certs/ca-bundle.crt&#34；；locale_archive=stdenv。利布。optionalString stdenv.。是Linux&#34；${pkgs。glibcLocales}/lib/locale/locale-archive&#34；；}</p><p>我们可以手动检查和编辑这些源代码，但当我们需要更新这些源代码时，简单地再次使用Niv要方便得多。</p><p>在这个阶段，我们有一组可重现的软件包可供使用。然而，这仍然是相当恼人的，不得不经历编写nx-shell的麻烦，并且在我们改变事情的时候等待它重新构建。</p><p>在过去，我对迪伦夫的钦佩是非常明确的(特别是对蟒蛇诗)。然而，尽管direnv确实允许我们在项目中包含任意的bash逻辑，但是如果有一些可以默认为nix的东西就好了。谢天谢地，TweagIO的人们开发了Lorri来挠痒。</p><p>我们可以并且应该检查Lorri希望我们使用direnv文件加载的环境：</p><p>这本身并不是太具描述性的，所以我们应该首先自己运行。</p><p>EVALUATION_ROOT=&#34；$HOME/.cache/lorri/gc_roots/407bd4df60fbda6e3a656c39f81c03c2/gc_root/shell_gc_root&#34；watch_file&#34；/run/user/1000/lorri/daemon.socket&#34；watch_file&#34；$EVALUATION_ROOT&#34；#！/usr/bin/env bash#^shebang未使用，因为此文件是源文件，但存在于编辑器#集成中。注意：Direnv保证它*将*使用bash进行解析。Function Punt(){：}#Move&#34；OrigPreHook&#34；&#34；preHook&#34；&#34；$@&#34；；Move(){srcvarname=$1#示例：varname可能包含字符串&#34；OrigPATH&#34；#删除源变量名称Shift destvarname=$1#示例：destvarname可能包含字符串&#34；path&#34；#删除目标变量名称Shift#。.SOME-VALUE.&#34；export&#34；${@？}&#34；；#将$Original设置为变量$srcvarname的内容#表示eval&#34；$destvarname=\&#34；${！srcvarname}\&#34；&#34；#将目标变量名称标记为已导出，以便direnv拾取它#(shellcheck：我们确实要导出destvarname！的内容)#shellcheck Disable=SC2163。#从上面移除导出，即：export OrigPATH.。unset&#34；$srcvarname&#34；}函数pretiend(){varname=$1#示例：varname可能包含字符串&#34；path&#34；#删除varname移位分隔符=$1#示例：分隔符通常是字符串&#34；：&#34；#删除分隔符参数，因此剩余的参数#是要导出Shift的参数#将$Original设置为变量$varname#引用Original=&#34；$。#有效接受新变量的内容导出(#34；${@？}&#34；；#将$varname的变量重新设置为varname#引用的内容，以及当前(在导出时更新的)内容。#但是，除非${Original}以值eval&#34；$varname=${！varname}${Original：+${Separator}${Original}}&#34；}函数append(){varname=$1#示例：varname可能包含字符串&#34；path&#34；#删除varname移位分隔符=$1#示例：分隔符通常是字符串&#34；：&#34；#删除分隔符参数，因此剩余的参数#是要导出Shift的参数#将$Original设置为变量$varname的内容#引用原始=&#34；${！varname：-}&#34；#有效接受新变量的内容export&#34；${@？}&#34；；#将$varname的变量重新设置为varname#引用的内容，加上当前(导出时更新的)内容。#但是，除非${Original}以值eval&#34；$varname=${Original：+${Original}${Separator}}${varname}&#34；}varmap(){if[-f&#34；$EVALUATION_ROOT/varmap-v1&#34；]；THEN#捕获正在设置的变量的名称IFS=&#34；=&#34；Read-r-a cur_varname&lt；&，否则请排除${parator}；THEN#捕获正在设置的变量的名称IFS=&#34；=&#34；READ-r-a cur_varname&lt；&。&#34；$1&#34；#在IFS=&#39；&#39；和`read`分隔符为&#39；&#39；的情况下，我们实现了#拆分\0字节，同时还保留了前导#空格：##bash-3.2$printf&#39；&lt；-前导空格\0bar\0baz\0&#39；\#|(While IFS=&#39；&#39；read-d$&#39；\0&#39；&#34；；完成)#&gt；&lt；-前导空格&lt；#&gt；bar&lt；#&gt；baz&lt；`而IFS=&#39；&#39；read-r-d&&amp；&amp；IFS=&#39；&amp；&amp；IFS=&#39；&39；map_Variable\&amp；&amp；IFS=&#39；如果[&#34；$MAP_VARIABLE&#34；==&#34；${CUR_varname[0]}&#34；]；则如果[&#34；$MAP_INSTRUCTION&#34；==&#34；APPEND&#34；]；则附加&#34；$MAP_VARIABLE&#34；&#34；$MAP_SECTOR&#34；&#34；$@&#34；返回FI完成&lt；&#34；$EVALUATION_ROOT/varmap-v1&#34；FI EXPORT&#34；${@？}&#34；}函数DECLARE(){IF[&#34；$1&#34；==&#34；-x&#34；]；然后SHIFT；FI#某些变量需要特殊处理。##-Punt：根本不要设置变量#-Prepend</p><p>正如承诺的那样，我们将首先测试设置以确保一切正常。现在也是尝试tidybayes的好时机。重新思考套餐。为了使用它，我们需要以某种方式定义重新思考包，以便我们可以将其传递给buildInput以用于tidybay.reink。我们将修改新的shell.nix，如下所示：</p><p>#shell.nix let Sources=import./nix/Soures.nix；pkgs=导入源。nixpkgs{}；stdenv=pkgs。重新思考=用pkgs。rPackages；buildRPackage{name=&#34；resiking&#34；；src=pkgs。fetchFromGitHub{Owner=&#34；rmcelreath&#34；；repo=&#34；；rev=&#34；d0978c7f8b6329b94efa2014658d750ae12b1fa2&#34；；sha256=&#34；1qip6x3f6j9lmcmck6sjrj50a5azqfl6rfhp4fdj7ddabpb8n0z0&#34；；}；pagatedBuildInput=[尾部质量mvtnorm loo form rstan dagitty]；}；tidybayes_reink=with pkgs。rPackages；buildRPackage{name=&#34；tidybayes.reessing&#34；；src=pkgs。fetchFromGitHub{Owner=&#34；mjskay&#34；；repo=&#34；tidybayes.resiking&#34；；rev=&#34；df903c88f4f4320795a47c616eef24a690b433a4&#34；；sha256=&#34；1jl3189zdddmwm07z1mk58hcahirqrwx211ms0i1rzbx5y4zak0c&#34；；}；pagatedBuildInput=[dplyr Tibble rlang mass tidybayes reessing rstan]；}；rEnv=pkgs。rWrapper。用Pkgs覆盖{Packages=。rPackages；[ggplot2 tidyverse tidybayes DevTools model r curlot ggrepel RColorBrewer purrr forcats rstan reessing tidybayes_reink]；}；以pkgs为单位。mkShell{buildInput=with pkgs；[git glibcLocales其中]；inputsFrom=[rEnv]；shellHook=&#39；&#39；mkdir-p&#34；$(Pwd)/_libs&#34；export R_Libs_user=&#34；$(Pwd)/_libs&#34；&#39；&#39；git_SSL_CAINFO=&#34。cacert}/etc/ssl/certs/ca-bundle.crt&#34；；locale_archive=stdenv。利布。optionalString stdenv.。是Linux&#34；${pkgs。glibcLocales}/lib/locale/locale-archive&#34；；}。</p><p>这里需要注意的主要内容是，我们需要派生WeCreate的输出，也就是说，我们需要使用inputsFrom而不是buildInput作为rEnv。</p><p>库(Magrittr)库(Dplyr)库(Purrr)库(Forcats)库(Tidyr)库(Delyr)库(Tidybayes)库(tidybayes.resiking)库(Ggplot2)库(Ventlot)库(Rstan)库(Reink)库(Ggrepel)库(RColorBrewer)heme_set(heme_tidybayes())rstan_options(auto_write=true)选项(mc.co.。，&#34；B&#34；，&#34；C&#34；，&#34；D&#34；，&#34；E&#34；)，n)，响应=rNorm(n*5，c(0，1，2，1，-1)，0.5))mtcar_lean=mtcars%&gt；变异百分比(cyl=factor(Cyl))m_cyl=ulam(ist(cyl~dordlogit(phi，cutpoint)，phi&lt；-b_mpg*mpg，b_mpg~Student_t(3，0，10)，cutpoint~Student_t(3，0，10))，data=mtars_lean，Chains=4，Cores=Parallel：：DetectCores()，ITER=2000)。%Swing_Draw(cutpoint[cyl])#定义最后一个切割点LAST_Cutpoint=Tibble(.raw=1：max(切割点$.raw)，cyl=&#34；8&#34；，cutpoint=inf)切割点=BIND_ROWS(切割点，LAST_Cutpoint)%&gt；%#定义上一个切割点(cutpoint_{j-1})group_by(.raw)%&gt；%arrange(Cyl)%&gt；%mudiate(prev_cutpoint=LAG(cutpoint，默认值=-inf))fitted_cyl_pros=mtars_clee%&gt；%data_grid(mpg=seq_range(mpg，n=101))%&gt；%add_fit_tracts(M_Cyl)%&gt；%INNER_JOIN(cutpoints，by=&#34；.raw&#34；)%&gt；%mugiate(`P(cyl|mpg)`=#此部分为logit^-1(cutpoint_j-beta*x)-logit^-1(cutpoint_{j-1}-beta*x)plogis(cutpoint-.value)-plogis(prev_cutpoint-.value))data_lot=mtcar_cle%&gt；%gglot(aes(x=mpg，y=cyl，color=cyl))+geom。，name=&#34；cyl&#34；)fit_lot=fit_cyl_pros%&gt；%gglot(aes(x=mpg，y=`P(cyl|mpg)`，color=cyl))+stat_lineribbon(AES(Fill=cyl)，alpha=1/5)+scale_color_brewer(调色板=&#34；深色2&34；)+scale_ill_brewer(调色板=&。../image/rethinking.png&#34；)PLOT_GRID(nol=1，Align=&#34；v&#34；，Data_Plot，Fit_Plot)dev.off。</p><p>这篇文章实际上更多的是对前一篇文章的探索性跟进，并不是真正孤立地工作。话又说回来，在这一点上，一切似乎都进行得很好。R和NIX最终成为了一种真正可行的组合，可以在阳光下进行任何分析。工作流程的某些部分仍然有点不稳定，但随着时间的推移可能会自行解决。</p><p>我的动机被列出来了，我</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://rgoswami.me/posts/rethinking-r-nix/">https://rgoswami.me/posts/rethinking-r-nix/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/反思/">#反思</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/cyl/">#cyl</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>