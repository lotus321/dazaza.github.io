<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>构建安全的DNS基础设施，如SecureDNS.eu</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">构建安全的DNS基础设施，如SecureDNS.eu</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-02 17:47:56</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/dae318bfa79d8da0abef6c71ee2da593.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>在我的LinkedIn上可以看到，SecureDNS将于2020年4月30日关闭。许多人问我，他们是否可以购买SecureDNS，或者让我帮助他们建立一个类似的。这篇技术文章是为那些人写的。为了让它有意义，最好也检查一下我的Github SecureDNS存储库。</p><p>作为前端负载均衡器/反向代理，它使用HaProxy。HaProxy处理TLS部分，并将SNI路由到正确的服务。</p><p>ICS将/Bind9命名为DNS服务器。这是整个基础设施的核心，因为它提供来自所有其他服务的所有配对和请求(包括TLS上的DNS，其中Haproxy执行TLS部分，并命名为实际解析)。</p><p>dns over HTTPS服务器的m13253。它通过HTTPS提供DNS服务，并使用名为上游的服务。</p><p>nginx作为Web服务器，用于托管https://securedns.eu，和测试页面，如https://test.securedns.eu和https://ads-test.securedns.eu，用于检查用户是否使用SecureDNS作为提供商。</p><p>并非所有组件或配置的选项都会详细介绍，因为有些组件或配置的选项是直截了当的，或者只是最佳实践。如果您确实想知道，请检查RFC。</p><p>HaProxy是一个具有许多可配置功能的TCP/HTTP负载均衡器。此负载均衡器的唯一缺点是不支持UDP。这对于TLS上的DNS或HTTPS上的DNS应该不是问题，但是对于Quic上的DNS(Doq)或DNSCcrypt会有问题。</p><p>这个负载均衡器非常棒，因为它支持SNI路由。优点是您可以在同一端口上托管多个服务，并使用基于TLS中SNI扩展的路由。这确保了例如可以通过TLS服务DNS、通过HTTPS服务DNS以及在端口443上服务Web服务器！</p><p>以下部分包含haproxy.conf的内容。它分为以下几个部分：</p><p>全局守护进程用户haproxy group haproxy maxconn 55000外部-check tune.ssl.default-dh-param2048tune.ssl.cachesize 30000 tune.ssl.life600ssl-default-bind-options no-sslv3 nbproc 1 nbthread 4 cpu-map auto：1/1-4 0-3 log/dev/log local0通知默认超时http-request 10s超时队列30s超时检查3s超时连接5000ms超时客户端。</p><p>MAXCONN已设置为55000，高于默认值，以便能够处理更多连接。另外，将tune.ssl.cachesize和tune.ssl.lifetime设置为减少TLS握手带来的CPU开销。</p><p>由于此服务器有4个逻辑核心，我们希望使用多线程。因此，它将nbproc设置为1，以确保1个主进程，将nbthread设置为4，以确保4个工作线程。接下来，通过将CPU-MAP设置为AUTO：1/1-4 0-3，将每个线程分配给1个逻辑核心。</p><p>接下来，我使用log来确保通知消息被发送到systemd-Journal(因为Journal侦听/dev/log)。这对于跟踪在线和离线后端非常有用。</p><p>最后，我设置了EXTERNAL-CHECK参数，以启用使用自定义运行状况检查来验证后端是在线还是离线的功能。默认情况下，在后端使用参数检查时，HaProxy将进行TCP握手，以验证服务是否正在监听后端节点。通过使用此功能，您可以使用带有退出代码的Bash脚本进行运行状况检查。</p><p>默认部分包含前端和后端的所有默认值。优点在于，如果您将它们添加到Default，则只需添加一次，而不是在前端或后端部分本身中注明它们。</p><p>前端前端部分是面向公共互联网的配置，也是用户连接的位置。这些前端显然与后端部分有关系。</p><p>端口443/TLS：为Web服务器提供HTTPS服务，并为HTTPS上的DNS提供服务(如果您愿意，也可以将其用于TLS上的DNS)。</p><p>前端http bind：80 v4v6 tfo模式http maxconn 100重定向方案https code 301 if！{ssl_fc}acl securedns.eu hdr(Host)-i securedns.eu acl test.securedns.eu hdr(Host)-i test.securedns.eu acl ads-test.securedns.eu HDR(Host)-i ads-test.securedns.eu use_backend http-securedns.eu if securedns.eu。如果ads-test.securedns.eu default_backend http-securedns.eu前端https绑定.。</p><p>TFO：使用TCP Fast Open(设置某种cookie以在再次连接时启用更快的握手)。</p><p>crt：设置证书(请注意，1个文件必须包含证书、CA链和私钥。因此，如果您使用的是LetsEncrypt，则需要将它们组合在一起)。您可以在该行上使用多个CRT语句，让HaProxy为不同域提供多个证书。</p><p>我们使用mode参数将前端设置为HTTP或TCP代理。请记住，如果将其设置为HTTP，并且流量不是HTTP，则不会进行路由。使用HTTP的优点是使负载均衡器更了解流量，其中一些优化可以用于HTTP流量(例如，为报头转发</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://medium.com/@ricklahaye/building-a-secure-dns-infrastructure-like-securedns-eu-350182d028dd">https://medium.com/@ricklahaye/building-a-secure-dns-infrastructure-like-securedns-eu-350182d028dd</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/安全/">#安全</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/secure/">#secure</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/dns/">#dns</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>