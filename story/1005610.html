<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>全球数据局部性-原因和方式</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">全球数据局部性-原因和方式</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-08 03:09:58</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/6/a14ff2b07d1345fc33fd40e59ed9ea2d.jpg" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>#DEFINE FULY_SETINGING_DEFINE(_PROJECT，_NAME，_TYPE，_DEF，_DESC)\/*FastPath优化，参见Folly_Settings_Define_LOCAL_FUNC__中的说明。\将所有这些都聚合到单个部分中，以获得更好的TLB\和缓存局部性。*/\__attribute__((__section__(&#34；.folly.settings.cache&#34；)\std：：atomic&lt；folly：：settings：：detail：：SettingCore&lt；_Type&gt；*&gt；\FLOLY_SETTINGS_CACHE__##_PROJECT##_##_NAME；</p><p>将所有这些内容聚合到单个部分中，以实现更好的TLB和缓存局部性。</p><p>TLB代表转换后备缓冲器。当CPU需要加载存储在RAM中的某个值时，它只有虚拟内存的地址，需要将其转换为物理地址。只有到那时，计算机才知道物理48条地址线的哪个子集(假设x86-64架构)需要设置为高电压，其余的设置为低电压。</p><p>虚拟内存分为多个页面。虚拟地址中的高位表示页面ID。低位表示页面内特定字节的偏移量。TLB内置在存储空间有限的硬件中。典型的TLB具有4Ki个条目。TLB中的每个条目是从物理存储器的页ID到帧ID的映射。对于给定的虚拟地址，如果存在TLB条目，它将找到帧ID并获得物理地址。所有这些步骤都在硬件中完成。TLB只是存储在RAM中的页表的高速缓存，而不是像TLB那样的专用硬件存储。在TLB未命中时，CPU将遍历页表以填充TLB并重新启动进程。页表是进程特定的，每个进程在RAM中都有自己的页表。因此，有一个特殊的寄存器CR3，它存储负责CPU上当前运行进程的页表地址。CPU可以在没有操作系统参与的情况下进行页面遍历，这就是页表结构是特定于体系结构的原因。只有当出现页面错误时，操作系统才会介入，并且可以将数据交换到RAM或暂停程序。请注意，TLB不必是特定于进程的。通常在上下文切换时，TLB会被刷新，因此它只有当前运行进程的查找数据。但在较新的架构中也有类似PCID的解决方案。</p><p>x86具有两级页表结构。虚拟地址的第一部分标识第一级块(通用页面目录)。虚拟地址的第二部分标识目录内的内部页表条目。因为页表驻留在RAM中，所以页表查找具有访问RAM的所有开销。它需要在x86上进行两次RAM访问，与TLB命中相比，这需要多一个数量级的CPU周期。</p><p>当CPU从RAM加载例如uint64_t时，它从不只读取8个字节。最小的块，即公共CPU读取，将是64字节，即一条CPU高速缓存线。因此，CPU将从64的倍数地址开始读取64字节，该地址包含您感兴趣的数据。这意味着1)您希望将频繁读取的数据放在一起，物理上也要靠近虚拟地址空间中的数据；2)如果数据可以放入一条高速缓存线中，则希望避免数据跨越两条高速缓存线。这就是您看到例如__ATTRIBUTE__((aligned(16)用于结构的原因。</p><p>现在我们知道什么是TLB了。以及我们为什么要减少TLB未命中(因为页表查找速度慢了10倍)并提高高速缓存局部性。但是，我们如何才能编写具有较少TLB未命中的程序呢？对于堆和堆栈中的数据，通常的良好实践适用，例如避免追逐指针(也称为不使用链表，对齐结构以避免高速缓存线未命中)。但是，通常位于.text和.bss部分中的全局变量又如何呢？</p><p>这是变量的GCC属性。因此，所有声明了该属性的变量都将在最终可执行文件的同一节&#34；.folly.settings.cache&#34；中创建。因此，一旦加载到RAM中，它们在虚拟地址空间中的物理位置会更近。</p><p>objdump-D.Section--demangle--Section=.test.mySection-hSections：idx名称大小vma LMA文件关闭ALGN 21.test.mySection 00000008 00000000002b22e8 00000000002b22e8 000b22e8**3目录，ALLOC，LOAD，DATA.test.mySection：00000000002b22e8&lt；Section_data&gt；：.。</p><p>因此，链接器创建了一个名为&#34；.test.mySection&#34；的新节，它的大小正好是8个字节，用来保存我在程序中定义的uint64_t。当程序启动时，该部分被复制到RAM。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://blog.the-pans.com/cache-locality/">https://blog.the-pans.com/cache-locality/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/数据/">#数据</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/data/">#data</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/tlb/">#tlb</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1005408.html"><img src="http://img.diglog.com/img/2020/6/thumb_276d593ca089e26a3581647e6f177894.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005408.html">eBay正在对其网站的访问者进行端口扫描</a></div><span class="my_story_list_date">2020-6-6 14:15</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005370.html"><img src="http://img.diglog.com/img/2020/6/thumb_f057d335e11fc2a0bd2c09b880196a3d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005370.html">随着世界的发展，回顾信号是如何工作的</a></div><span class="my_story_list_date">2020-6-6 6:56</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005362.html"><img src="http://img.diglog.com/img/2020/6/thumb_09612c2916fb568274c9415700ba7ca5.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005362.html">IBM发布用于iOS和MacOS的完全同态加密工具包</a></div><span class="my_story_list_date">2020-6-6 6:18</span></div><div class="col-sm"><div><a target="_blank" href="/story/1005312.html"><img src="http://img.diglog.com/img/2020/6/thumb_5b1618b2f1202086830effa2851db63f.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1005312.html">政府最终公布了NHS与Palantir、学院和大型科技公司的合同</a></div><span class="my_story_list_date">2020-6-6 0:31</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>