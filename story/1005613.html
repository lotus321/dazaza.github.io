<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>TLS 1.3会话恢复在没有主密钥的情况下工作，允许MITM</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">TLS 1.3会话恢复在没有主密钥的情况下工作，允许MITM</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-08 03:26:56</div><div class="page_narrow text-break page_content"><p>GNUTLS服务器无需访问由GNUTLS_SESSION_TICKET_KEY_GENERATE()生成的密钥，即可使用彼此签发的票证。这允许没有有效凭据的MITM服务器恢复与客户端的会话，该客户端首先与具有有效凭据的服务器建立初始连接。此问题适用于TLS 1.3，当使用TLS 1.2恢复如预期失败时。</p><p></p><p>因为票证可以在不知道主密钥的情况下用于恢复，所以我假设(但还没有经过测试)它也可以用于早期数据的被动解密。</p><p></p><p>我首先在Ubuntu版本3.6.13-2ubuntu1中注意到了这个问题，并使用52e78f1e的master版本重现了这个问题。</p><p></p><p></p><p>连接到服务器并存储恢复数据：openssl s_client-connect localhost：5556-Cafile AUTHORITY/x509.pem-VERIFY_RETURN_ERROR-SESS_OUT session.cache</p><p></p><p></p><p>在同一地址端口使用伪造凭据启动服务器(假设真正的攻击者仅在客户端要求恢复时才重定向连接)：GNUTLS-SERV--x509keyfile=rogueca/mitm/Secret.key--x509certfile=rogueca/mitm/x509.pem。</p><p></p><p>使用存储的恢复数据重新连接：openssl s_client-connect localhost：5556-Cafile AUTHORITY/x509.pem-Verify_Return_Error-Sess_in session.cache。</p><p></p><p>我使用OpenSSL s_client重现了这个问题，因为GNUTLS-CLI缺乏跨调用存储恢复数据的方法，但是使用GNUTLS的应用程序也可以重现这种效果，因为GNUTLS缓存会话数据的时间足够长，可以更改服务器。在mod_GNUTLS中为代理连接实现会话恢复时，我注意到了这个问题。</p><p>这些证书只是我的测试PKI中的证书，如果有帮助，我可以邮寄它们。重要的是，步骤1中的服务器具有客户端信任的CA颁发的证书，而步骤4中的服务器具有客户端未知的CA颁发的证书。</p><p></p><p></p><p>伪造的服务器能够恢复会话，客户端不会检测到攻击。</p><p></p><p></p><p>会话恢复应该失败，从而导致完全握手，除非第二台服务器具有有效的凭据，否则必须失败。如果使用相同的证书而不是伪造的证书重新启动服务器，则完全握手成功将是预期的结果。</p><p>GNUTLS服务器无需访问`gnutls_SESSION_TICKET_KEY_GENERATE()`生成的密钥，即可使用彼此签发的票证。这允许没有有效凭据的MITM服务器恢复与客户端的会话，该客户端首先与具有有效凭据的服务器建立初始连接。此问题适用于TLS 1.3，当使用TLS 1.2恢复失败时，正如预期的那样。因为票证可以在不知道主密钥的情况下用于恢复，所以我假设(但尚未测试)票证也可以用于被动解密早期数据。我首先注意到Ubuntu版本3.6.13-2ubuntu1存在这个问题，并使用52e78f1e3a95a6d9e4f1f9a72f的`master‘版本复制了它。使用有效凭据启动服务器：`gnutls-serv--x509keyfile=Authority/server/Secret.key--x509certfile=Authority/server/x509.pem`2.连接到服务器并存储恢复数据：`openssl s_client-connect localhost：5556-CAFILE AUTHORITY/x509.pem-Verify_Return_Error-Sess_out session.cache`3.停止在步骤1.4中启动的服务器。在同一地址端口使用伪造凭据启动服务器(假设真正的攻击者仅在客户端请求恢复时才重定向连接)：`gnutls-serv--x509keyfile=rogueca/mitm/Secret.key--x509certfile=rogueca/mitm/x509.pem`5.使用存储的恢复数据重新连接：`openssl s_client-connect localhost：5556-Cafile Authority/x505.pem`5.使用存储的恢复数据重新连接：`openssl s_client-connect localhost：5556-Cafile Authority/x50。我使用`openssl s_client`来重现该问题，因为`gnutls-cli`缺乏跨调用存储恢复数据的方式，但是使用GNUTLS的应用程序也可以重现该效果，因为GNUTLS缓存会话数据的时间足够长，可以更改服务器。在mod_gnutls中为代理连接实现会话恢复时，我注意到了这个问题。证书只是我测试的PKI中的证书，如果有帮助，我可以发布它们。重要的是，步骤1中的服务器具有客户端信任的CA颁发的证书，而步骤4中的服务器具有客户端未知的CA颁发的证书。##实际结果伪造的服务器能够恢复会话，客户端检测不到攻击。##预期的结果会话恢复应该失败，从而导致完全握手，除非第二台服务器具有有效的凭据，否则握手必须失败。如果使用相同的证书而不是伪造的证书重新启动服务器，则完全握手成功将是预期的结果。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://gitlab.com/gnutls/gnutls/-/issues/1011">https://gitlab.com/gnutls/gnutls/-/issues/1011</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/允许/">#允许</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/allowing/">#allowing</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/服务器/">#服务器</a></button></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>