<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Rust和WebAssembly中的一款多人棋盘游戏</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Rust和WebAssembly中的一款多人棋盘游戏</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-27 16:06:14</div><div class="page_narrow text-break page_content"><p>Pont是Mindware Games的棋类游戏Qwirkle的在线实现，它是为我的父母写的，这样他们就可以在新冠肺炎呆在家里的时代和朋友和家人一起玩。</p><p>游戏被分成几个房间，用三个字的代码(上图中的喜怒无常的形状)来标识。在每个房间里，游戏分发棋子，执行游戏规则，并提供一个本地聊天窗口。</p><p>不同寻常的是，这是一个基于网络的多人游戏，没有任何Javascript：客户端和服务器都是用Rust编写的，它被编译成WebAssembly在浏览器上运行。(有一个Javascript填充程序来加载WebAssembly模块，但我不需要自己编写它)。</p><p>请记住，我不是一名Web开发人员，因此对于Web应用程序来说，这可能是一个奇怪的局外人架构。以下是该系统的外观：</p><p>系统对证书使用了let的加密：客户端和服务器之间的静态资产和WebSocket通信都是加密的。游戏服务器不能与Nginx代理安全通信，但如果有人在服务器上观看，我就会遇到更大的问题。</p><p>WASM捆绑包和PONT-SERVER可执行文件都是用Rust编写并在PONT存储库中管理的，它们都依赖于PONT-COMMON，它定义了游戏的基本类型和逻辑(例如，这样客户端和服务器都可以检查移动是否合法)。</p><p>客户端和服务器通过WebSocket进行通信，消息在PONT-COMMON中被强类型化为枚举，使用Serde序列化，然后打包成二进制WebSocket消息作为二进制WebSocket消息发送。</p><p>这两个大国之间正在进行一场非常礼貌的冷战(不相容？)。运行时，包只能在其中一个中工作</p><p>Futures、std：：Future和Futures_util之间的一般混淆(Google搜索将使您进入文档的随机版本，这一事实加剧了这一情况)。</p><p>我最终使用了Smol运行时，因为它的依赖性相对较少，而且我意识到它不会试图拥有整个异步世界(不像Tokio和Async-STD)。</p><p>跨过这些障碍后，服务器架构相对简单，一组独立的任务异步运行，通过WebSocket与外部通信，内部通过无限的MPSC队列进行通信。</p><p>这里是一个服务器运行一个游戏(有两个玩家)的示例，外加一个刚刚连接的新客户端。每个矩形表示一个异步任务：</p><p>每个客户端连接一个异步任务，它在WebSocket连接和应用程序的内部队列之间传递消息。</p><p>这些任务每个都映射到一个Smol：：Task。(作为一个小优化，第一个玩家的任务同时处理玩家通信和运行房间，这就是为什么它们在上图中都是蓝色的原因)。</p><p>服务器编译成5MB的静态二进制文件。整个系统托管在Digital Ocean提供的最小虚拟机上，这是一台每月5美元的机器。我期待着不可避免的黑客新闻DDOS，在那里我可以看到它的可扩展性！</p><p>客户端是2000行无框架的兴奋，它使用状态机模式来表示游戏的流程，接受来自服务器的消息，并相应地更新状态：例如，顶层状态从连接到创建或加入到玩。</p><p>游戏板被表示为一个SVG；其他一切都是标准的HTML元素。实际上，整个UI都是在index.htmland中按需预构建的。</p><p>客户有点精雕细琢：棋子在棋盘上移动时会有动画效果，还有一个可选的色盲模式，它会添加角落标记来指示颜色。</p><p>我使用直接的DOM操作(从web-sys机箱)来控制系统。这个练习让我领略了虚拟DOM的用处，但我不想引入框架的复杂性。(Svelte是否有Rust+wasm版本？)。</p><p>对于部署，我使用wasm-pack，并从与其他静态资产相同的服务器上提供生成的wasm blob。</p><p>客户端面临的主要挑战(当然)是处理跨浏览器兼容性：特别是Safari，它支持的功能较少，而且对触摸事件的处理也很时髦。</p><p>客户端仍然有点混乱，动画、UI输入和服务器事件都在争先恐后地破坏系统的不变量。例如，在动画运行时拖动板可能会使系统进入无效状态，这是一个令人讨厌的错误。</p><p>这并不令人惊讶：有状态UI很难，这解释了声明式方法的流行。在这一点上，客户端的功能是完整的，并且还没有完全崩溃，所以我不倾向于进行任何戏剧性的重构。</p><p>Rust作为一种语言仍然很棒，尽管有一些小问题。我已经在上面讨论了异步生态系统，我没有再深入讨论这一点。在客户端，WebAssembly经常存在阻抗不匹配的问题：例如，使用Rust闭包作为回调需要隐晦的样板文件。</p><p>尽管如此，所有的部分都就位了，进行更改的速度非常快，而且我相信编译器会检查我没有破坏任何东西。</p><p>我特别喜欢WebSockets、Serde和bincode的组合：让客户端和服务器都处理强类型的事件流，这让事情更容易推理。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="http://www.mattkeeter.com/projects/pont/">http://www.mattkeeter.com/projects/pont/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/棋盘/">#棋盘</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/board/">#board</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1008371.html"><img src="http://img.diglog.com/img/2020/6/thumb_428da4b9b894b0cac5341d0bcd26b5cd.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1008371.html">3k、60fps、130ms：用铁锈实现</a></div><span class="my_story_list_date">2020-6-26 15:42</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007857.html"><img src="http://img.diglog.com/img/2020/6/thumb_9df49708f082d8f59c6e5f6eb0332ff5.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007857.html">Facebook在德国数据收集反垄断案中败诉</a></div><span class="my_story_list_date">2020-6-24 4:20</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007731.html"><img src="http://img.diglog.com/img/2020/6/thumb_73370c1fc49f85c287db59d59c90f277.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007731.html">受挫项目：使用Selenium自动将数据输入PeopleSoft</a></div><span class="my_story_list_date">2020-6-23 7:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007627.html"><img src="http://img.diglog.com/img/2020/6/thumb_18a8af18d4312ae59b37a266c79db1ba.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007627.html">铁锈并发：消息传递错误的原型</a></div><span class="my_story_list_date">2020-6-22 19:52</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>