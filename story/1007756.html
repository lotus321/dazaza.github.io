<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>高性能防锈的廉价诀窍</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">高性能防锈的廉价诀窍</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-23 12:01:09</div><div class="page_narrow text-break page_content"><p>那么，您正在编写Rust，但是它还不够快？即使您使用的是Cargo Build--Release？以下是一些可以提高Rust项目运行时速度的小事情--实际上不需要更改任何代码！</p><p>请记住，以下建议并不能取代实际的性能分析和优化！我也认为不用说，检测其中是否有任何帮助的唯一方法是拥有代表您的应用程序在实际使用中的行为的基准测试。</p><p>首先，让我们在进行货物构建-发布时启用一些更多的优化。交易非常简单：我们启用了一些使构建发布构建变得更慢的功能，但作为奖励，我们可以获得更彻底的优化。</p><p>我们将下面介绍的标志添加到主Cargo.toml文件中，即最顶层的清单文件，以防您使用货物工作区。如果您还没有名为profile.release的节，请添加它：</p><p>我们要做的第一件事是启用链接时间优化(LTO)，这是一种全程序或模块间优化，因为它在将二进制文件的不同部分链接在一起时作为最后一步运行。您可以认为它允许更好地跨依赖边界进行内联(但它当然要比这复杂得多)。</p><p>Ruust可以使用多种链接器风格，我们想要的是“跨所有板条箱优化”，也就是“胖”。要设置这一点，请在您的个人资料中添加LTO标志：</p><p>接下来是一个类似的主题。为了加快编译速度，Rust尝试将板条箱拆分成小块，并尽可能并行编译尽可能多的块。缺点是编译器在这些块中优化代码的机会较少。因此，让我们告诉它在每个板条箱中执行一个块：</p><p>默认情况下，Rust希望构建一个可以在目标体系结构的尽可能多的机器上运行的二进制文件。但是，您可能实际上有一个非常新的CPU，具有很酷的新功能！</p><p>作为“铁锈标志”，即环境变量RUSTFLAGS或目标的铁锈标志字段。</p><p>现在我们进入一些更不安全的选项。还记得Rust在默认情况下如何使用堆栈展开(在最常见的平台上)吗？这会以性能为代价！让我们跳过堆栈跟踪和捕获异常的能力，以减少代码大小和更好地使用高速缓存：</p><p>请注意，一些库可能依赖于展开，如果您启用此功能，将会发生可怕的爆炸！</p><p>许多Rust程序做的一件事就是分配内存。他们不仅自己做这件事，而且实际上使用一个(外部)库来做这件事：分配器。当前的Rust二进制程序默认使用默认的系统分配器，以前它们自己的分配器包含在标准库中。(这种变化导致了更小的二进制文件和更好的可调试性，这让一些人相当高兴)。</p><p>不过，有时您系统的分配器不是最佳选择。别担心，我们可以更改它！我建议同时尝试jemalloc和mimalloc。</p><p>jemalloc是Rust以前附带的分配器，Rust编译器至今仍在使用它自己。它的重点是减少内存碎片并支持高并发。它也是FreeBSD上的默认分配器。如果您对此感兴趣，让我们试一试！</p><p>另一个有趣的替代分配器是mimalloc.它是由微软开发的，占用的空间相当小，并且在自由列表方面有一些创新的想法。</p><p>它还具有可配置的安全功能(请查看其Cargo.toml)。这意味着我们可以关闭它们以获得更高的性能！将mimalloc板条箱添加为依赖项，如下所示：</p><p>这是LLVM的一个很好的功能，但是我从来没有用过。请看一下文档。</p><p>现在，您需要实际调整代码并修复所有的clone()调用。不幸的是，这是另一个帖子的主题！(在您等待我再写一年的时候，您可以阅读有关奶牛的内容！)。</p><p>编辑：人们不断询问关于如何优化Rust代码的实际提示。幸运的是，我骗到了他们，他们有一些很好的材料供我链接：</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://deterministic.space/high-performance-rust.html">https://deterministic.space/high-performance-rust.html</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/rust/">#rust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/性能/">#性能</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/防锈/">#防锈</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/tricks/">#tricks</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1007731.html"><img src="http://img.diglog.com/img/2020/6/thumb_73370c1fc49f85c287db59d59c90f277.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007731.html">受挫项目：使用Selenium自动将数据输入PeopleSoft</a></div><span class="my_story_list_date">2020-6-23 7:12</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007627.html"><img src="http://img.diglog.com/img/2020/6/thumb_18a8af18d4312ae59b37a266c79db1ba.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007627.html">铁锈并发：消息传递错误的原型</a></div><span class="my_story_list_date">2020-6-22 19:52</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007556.html"><img src="http://img.diglog.com/img/2020/6/thumb_57c62bad6fdacfcf1cebc3ae7430414c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007556.html">ZeroTrustOps：大规模保护</a></div><span class="my_story_list_date">2020-6-22 3:25</span></div><div class="col-sm"><div><a target="_blank" href="/story/1007474.html"><img src="http://img.diglog.com/img/2020/6/thumb_ae56ac60f1850e693cdd7f3754a017ea.jpeg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1007474.html">使用Rust/AWS/Terraform构建VehicleRoutingProblem Solver API的PoC</a></div><span class="my_story_list_date">2020-6-21 6:9</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>