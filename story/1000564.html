<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>创建健壮、可重用的链接检查器</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">创建健壮、可重用的链接检查器</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-04 15:18:04</div><div class="page_narrow text-break page_content"><p>我最成功的Rust项目之一是一个名为mdbook-linkcheck的无与伦比的小程序，下载量超过68842次。这是一个用于mdbook的链接检查器，该工具支持Rust社区中的大量文档，包括Rust Programming Language和Rustc Dev Book。</p><p>作为一个例子，我最近在Chalk的文档中发现了几个断开的链接。当该工具在您的标记中检测到断开的链接时，它将发出错误消息，指示您链接被定义的位置，并解释问题所在。</p><p>这个工具已经存在了一段时间了，并且运行得很好，所以当我前几天修复一个bug时，我决定是时候将核心逻辑提取到一个独立的库中，供其他人使用了。</p><p>本文中编写的代码可在GitHub上获得，并在crates.io上发布。您可以随意浏览和窃取代码或灵感。</p><p>如果您觉得这很有用或发现了错误，请在博客的问题跟踪器上让我知道！</p><p>当你开始建图书馆的时候，想想图书馆想要解决什么问题是很好的。这样，您就知道哪些功能属于该库，更重要的是，知道哪些不属于该库。</p><p>链接检查器机箱的主要目标是查找文档中的链接，并检查它们是否指向有效的内容。这里似乎有两个概念：</p><p>scanner-某种可以使用文本并返回找到的链接流的函数。</p><p>验证器-可以接受一批链接并告诉你它们是否有效的东西。</p><p>出于诊断目的，我们还想知道每个链接在源文档中出现的位置。因此，链接不只是一个字符串，还需要拖动它的跨度。</p><p>Codesan机箱包含许多管理源代码和发出诊断信息的强大工具，所以我想我会非常依赖它。</p><p>从长远来看，包括大多数流行格式的扫描仪会很好，但是为了便于管理，我现在将其限制为纯文本和降价。我想HTML也会是一个很好的补充，因为它可以让人们检查他们的网站，但我会把这留作稍后的练习。</p><p>验证Web链接应该相当容易，我们可以向适当的网站发送GET请求，我们的Web客户端(可能是reqwest)会让我们知道是否有死链接。</p><p>我想我应该从纯文本开始，因为这是最简单的。我们想要创建一种迭代器，它可以生成所有类似于URL的文本片段。</p><p>最初我以为这只是一个编写正则表达式并从regexrate映射匹配迭代器的情况，但结果发现URL并非易事。</p><p>在谷歌上搜索了大约10分钟，浏览了几十个StackOverflow问题后，我没有找到一个表达式，它可以匹配我预期的所有URL类型，同时也避免了标点符号，如句号或当链接在括号中时，以及检测到的链接没有方案(例如，/readme.md而不是file:/README.md).。</p><p>有些人在遇到问题时会想：“我知道，我会用通俗的表达方式。现在他们有两个问题。”</p><p>对我来说幸运的是，这个问题已经解决了，可以在crates.io上找到Linkify板条箱！</p><p>纵观源代码，他们似乎已经编写了很多手动代码来考虑URL如何嵌入文本正文。这主要包括扫描特定的“触发器字符”(对于URL，@对于电子邮件地址)，然后回溯以找到项目的开头。还有很多测试来确保只检测到所需的文本为匹配。</p><p>//src/scanner/Platext.rs使用Crate：：codesan：：span；使用Linkify：：{LinkFinder，LinkKind}；pub FN纯文本(src：&amp；str)-&gt；Impl Iterator&lt；Item=(&amp；str，Span)&gt；+&#39；_{LinkFinder：：New().种(&amp；[LinkKind：：url]).link(Src).map(|link|{(link.as_str()，span：：new(link.start()as u32，link.end()as u32)，)}。</p><p>//src/scanner/Platext.rs#[cfg(Test)]mod test{使用SUPER：：*；#[TEST]fn detect_urls_in_ome_text(){let src=&#34；hello http://localhost/world。这是file://some/text.&#34；；let应该_be=vec！[(&#34；http://localhost/&#34；，Span：：New(6，23))，(&#34；file://some/text&#34；，span：：New(39，55))，]；let Get：vec&lt；_&gt；=明文(Src).Collect()；assert_eq！(得到，应该是)；}}。</p><p>为了解析markdown，我的首选库是Pull-Down-cmark.这将公开一个基于迭代器的API，从而产生“段落标记开始”、“内联代码结束”、“水平标尺”等事件。</p><p>此API级别相当低，如果您想要创建文档的某种语义模型(例如，DOM)，则需要自己做大量工作，但如果您只想像我们一样浏览文档并提取特定片段，</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="http://adventures.michaelfbryan.com/posts/linkchecker/">http://adventures.michaelfbryan.com/posts/linkchecker/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/链接/">#链接</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/robust/">#robust</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/link/">#link</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/technology_web2_141308.html"><img src="http://img.diglog.com/img/2009/4/thumb_58f8a33e6a8348c389cbcc4c3e62f19c.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/technology_web2_141308.html">长话短链：通过链接分享文字、图片、代码等</a></div><span class="my_story_list_date">2009-4-20 6:44</span></div><div class="col-sm"><div><a target="_blank" href="/story/technology_google_125686.html"><img src="http://img.diglog.com/img/2009/2/thumb_168cd36f7e6e4fe7bb9a94a4d18eea38.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/technology_google_125686.html">[图]谷歌日本花钱买链接被惩罚 官方致歉</a></div><span class="my_story_list_date">2009-2-19 9:46</span></div><div class="col-sm"><div><a target="_blank" href="/story/technology_web2_114476.html"><img src="http://img.diglog.com/img/2008/12/thumb_684dcd80b39c4937934043618929e5d3.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/technology_web2_114476.html">ShareTabs：一个简单的链接分享工具 - 鲜甜IT.Net</a></div><span class="my_story_list_date">2008-12-24 9:41</span></div><div class="col-sm"><div><a target="_blank" href="/story/technology_web2_76650.html"><img src="http://img.diglog.com/img/2008/7/thumb_79f891fa493144dab4e619ad92c56868.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/technology_web2_76650.html">TinyPaste：以链接的方式分享文字</a></div><span class="my_story_list_date">2008-7-7 9:9</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>