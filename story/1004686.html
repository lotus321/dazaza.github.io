<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>今天我了解到：如何在Windows Server 2019上使用Keypair登录启用SSH</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">今天我了解到：如何在Windows Server 2019上使用Keypair登录启用SSH</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-06-02 00:56:55</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/6/c3416f715c16a6ba25e7d3e767ce91d5.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>TL；DR-在将内容自动部署到Windows Server 2019时，Windows远程管理(Winrm)可能是首选解决方案，远程桌面(.rdp)可用于手动登录和摆弄。但是您也可以使用SSH，这对于Linux本地操作员来说可能更方便(或者至少感觉更方便)。</p><p>问题是：在Windows Server 2019上启用和配置带有密钥对访问的SSH的端到端说明很少。本教程汇集了最近几个博客的内容，展示了如何做到这一点。</p><p>此外，它还展示了如何编写脚本以便在发布时注入到基于云的Windows Server 2019虚拟机中，从而使这些虚拟机从一开始就可以通过SSH访问。这样就不需要执行以下操作：</p><p>获取并记录管理员密码(在AWS上，具有讽刺意味的是，这需要在“连接”对话框中出示您的私钥，以便解密您的密码)。</p><p>…。在进行所需的更改之前，这样您就再也不需要这样做了。</p><p>我为什么要弄清楚这件事？很高兴你这么问。在过去的几周里，为了准备Docker Enterprise Barracuda的发布，我们已经部署了很多使用每日构建和“Beta Bits”(和Bob)的演示集群。Barracuda中的一个关键特性反映了Kubernetes 1.19引入的功能，它能够使用Windows Server工作节点(既可以是普通的，也可以是配备了GPU的！)。在不同的集群中。</p><p>问题是：因为我使用的BITS还没有完全成熟，我们的标准集群部署工具(在本例中，我使用的是docker集群)还没有扩展到完全可以做我需要做的所有事情。具体地说，我可以在几分钟内使用Windows工作节点部署Docker Enterprise Barracuda(并且Docker Enterprise本身可以自动将这些节点配置为Kubernetes工作节点并实现GPU插件)。但随后我必须登录这些节点才能安装支持GPU访问的NVIDIA驱动程序和服务。</p><p>这(引用xkcd专栏的话)破坏了我的面向Linux的工作流。每次部署新集群时，我都必须离开Linux操作虚拟机，浏览到Windows桌面上的EC2，找到我在GPU实例上部署的全新Windows节点，解密并存储它们的gobbledegook密码，下载.rdp文件，然后重复导航.rdp登录以访问和重新配置实例。</p><p>SSH-(使用密钥对)从一开始就会让这件事变得更容易。在谷歌上搜索了一会儿之后，我发现了这一点。当然，让它变得更容易的是自动安装GPU驱动程序，我们现在就会这么做。在撰写本文时，BITS还在四处飞来飞去，所以它是一个移动的目标。</p><p>同时，下面介绍如何在Windows Server 2019上启用SSH以进行密钥对访问。</p><p>SSH密钥对(私钥和公钥：id_rsa和id_rsa.pub)。您的云服务可能已经让您生成了一个或多个这样的内容，并已下载。如果您需要一个新的密钥，您可以按照本DigitalOcean教程的要求，使用ssh-keygen从Linux命令行生成它。</p><p>管理凭据和一种登录方式(也许是.rdp？)。并以管理员身份打开PowerShell。</p><p>根据需要，访问安全组管理，以便您可以添加一个为SSH开放端口22的入站规则(可能只启用从您的IP地址登录，或者只启用来自私有子网IP的连接，通过您的子网内的VPN或跳箱启用SSH登录)。</p><p>这里是食谱，(我发誓)在标准的Amazon EC2 Windows Server 2019 Full AMI上，它(我发誓)在2020年5月6日对我有效。</p><p>进入PowerShell提示符后，从安装OpenSSH服务器开始。(许多食谱还建议安装OpenSSH客户端，但我们在这里不会这样做。)。</p><p>完成这些步骤后，您应该能够使用SSH和密码登录到您的Windows Server 2019计算机，如下所示。以管理员身份登录：</p><p>如果您在AWS上运行，则需要使用您的私钥从EC2控制台的连接对话框中解密密码。</p><p>现在，就像Linux一样，我们需要将公钥写入服务器上的已知地址，以便sshd可以将其与我们的SSH客户端在登录时提供的私钥相匹配。默认情况下，sshd希望在名为的文件中看到管理员组成员密钥(即您，管理员。</p><p>作为Linux用户，您可能会考虑使用echo&lt；keytext&gt；filename来执行此操作。但在PowerShell上，这不是一个好主意，因为像“&gt；”这样的操作符使用OpenSSH(Sshd)无法读取的16位Unicode编码。请参阅这篇关于Windows和PowerShell字符编码规范以及PowerShell核心最新更新的精彩StackOverflow帖子。</p><p>如果您已经犯了这个错误(相信我，我先试了一下ECHO)，您会注意到一个可接受编码的RSA公钥文件大约有400个字节长，而Unicode(不可读)版本大约是800个字节。只需取消“扩展混合”，获取一个新密钥副本，并将其粘贴到脚本中，如下所示，该脚本使用Set-Content Commandlet(默认情况下输出ANSI)。高级用户、非美国用户和其他可能使用全局配置为使用Unicode(例如)的基于云的Windows服务器和PowerShell环境的用户可能仍需要在此处设置显式编码。</p><p>在Windows中，我们可以通过以下方式手动完成此操作：右键单击文件，选择属性，单击安全选项卡，按标记为禁用继承的按钮，手动删除除管理员和管理员之外的用户，并确保管理员和管理员都具有完全控制权限。</p><p>$acl=Get-acl C：\ProgramData\ssh\administrators_authorized_keys#获取访问控制列表$acl.SetAccessRuleProtection($TRUE，$FALSE)#消除继承$acl.Access|%{$acl.RemoveAccessRule($_)}#删除所有用户和权限$AdminatorRule=新建-Object#为管理员system.security.accesscontrol.filesystemaccessrule(&#34；Administrator&#34；，&#34；FullControl&#34；，&#34；Allow&#34；构建完全控制规则。)$acl.SetAccessRule($administatorRule)$administatorsRule=新-管理员的对象号同上(system.security.accesscontrol.filesystemaccessrule(&#34；Administrators&#34；，&#34；FullControl&34；，&#34；Allow&#34；)$acl.SetAccessRule($administatorsRule)(Get-Item&#39；C：\ProgramData\ssh\administrators_authorized_keys&#39；).SetAccessControl($acl)。</p><p>最后一行将修改后的ACL强加回文件。使用SetAccessControl避免了set-acl中的一个小错误，这似乎也造成了一些痛苦。</p><p>作为最后一步，我们可以(可选)将管理员的默认登录shell设置为PowerShell，而不是老式的命令shell。</p><p>此时，您应该能够使用您的私钥从任何SSH登录到您的Windows Server 2019机器(如顶部所示)，并最终进入PowerShell。如果您想使用PuTTY，您可能需要使用PuttyGen将您的私钥转换为RSA格式，如本食谱中所述。</p><p>如果您使用的是基于云的Windows Server VM，则当您启动新计算机时，此脚本(在大多数情况下)也可以作为用户数据脚本运行。例如，在AWS EC2中，当从EC2控制台启动新实例时，您只需选择以下脚本(以及所需的&lt；Powershell&&gt;&lt；/Powershell&&gt;；标记)并将其直接放入EC2 WebUI，或将其复制到由AWS CLI运行实例命令调用的文件中即可。</p><p>&lt；Powershell&&gt;Add-WindowsCapability-Online-Name OpenSSH.Server~0.0.1.0 Set-Service-Name sshd-StartupType‘Automatic’Start-Service sshd$key=&#34；&lt；在此处粘贴公钥&gt；&#34；$Key|Set-Content C：\ProgramData\ssh\administrators_authorized_keys$acl=Get-acl C：\ProgramData\ssh\administrators_authorized_keys$acl.SetAccessRuleProtection($True，$False)$acl.Access|%{$acl.RemoveAccessRule($_)}#剥离所有内容$AdminatorRule=新对象规则&#34；完全控制&#34；，&#34；允许&#34；)$acl.SetAccessRule($AdminatorRule)$AdminatorsRule=新对象规则。Administrators&#34；，&#34；完全控制&#34；，&#34；允许&#34；)$acl.SetAccessRule($AdminatorsRule)(Get-Item&#39；C：\ProgramData\ssh\administrators_authorized_keys&#39；).SetAccessControl($acl)New-ItemProperty-Path&#34；HKLM：\SOFTWARE\OpenSSH&34；-Name DefaultShell-Value&#34；C：\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&#34；-PropertyType String-Force Restart-service sshd&lt；/Powershell&gt；</p><p>让实例启动，您应该能够通过SSH和您的私钥从您的终端直接登录到它。</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://www.mirantis.com/blog/today-i-learned-how-to-enable-ssh-with-keypair-login-on-windows-server-2019/">https://www.mirantis.com/blog/today-i-learned-how-to-enable-ssh-with-keypair-login-on-windows-server-2019/</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/了解/">#了解</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/learned/">#learned</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1004613.html"><img src="http://img.diglog.com/img/2020/6/thumb_a5ce040108f606b498af773bb48f8c94.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004613.html">微软从竞争对手AppGet复制了新的Windows Package Manager，声称开发人员</a></div><span class="my_story_list_date">2020-6-1 11:32</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004375.html"><img src="http://img.diglog.com/img/2020/5/thumb_d5ac22b6724f715986d70f6c316f3742.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004375.html">为什么Windows使您的BIOS时钟保持在本地时间？</a></div><span class="my_story_list_date">2020-5-30 15:49</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004235.html"><img src="http://img.diglog.com/img/2020/5/thumb_4b7d9ecba1881eda1176c27aaa7da297.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004235.html">Windows/ARM64下VSCode的内幕构建</a></div><span class="my_story_list_date">2020-5-29 21:22</span></div><div class="col-sm"><div><a target="_blank" href="/story/1004192.html"><img src="http://img.diglog.com/img/2020/5/thumb_9ba0a0bdd754737729998585710c3a1d.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1004192.html">两个似乎没有人谈论的神秘的网络字体错误(2018)</a></div><span class="my_story_list_date">2020-5-29 10:35</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>