<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Dbanay/Smalltalk-“by the Blue book”C++Implementation of Smalltalk-80</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script data-ad-client="ca-pub-6067137220025946" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1 class="page_narrow">Dbanay/Smalltalk-“by the Blue book”C++Implementation of Smalltalk-80</h1><div class="row"><div class="col-lg-12 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time page_narrow">2020-05-25 21:40:46</div><div class="story_img_container"><img src="http://img.diglog.com/img/2020/5/ac90d32b417868cfe0d109c0677b8187.png" class="img-fluid my_story_img" onerror="this.style.display='none'"></div><div class="page_narrow text-break page_content"><p>欢迎使用在OS X、Windows和Linux上运行的Smalltalk-80系统的蓝皮书C++实现的My&#34；by the Bluebook&#34；C++。自从第一次在1981年8月的Byte杂志上读到关于Smalltalk的内容以来，我一直对它很感兴趣。那时，我们所有的都是运行速度很慢的8位计算机，4K内存的运行速度还不够快，不足以做任何有用的事情。当我通读这篇文章时，我惊呆了--这是一种未来主义的外星人技术，肯定超出了我的能力范围。1988年，在华盛顿大学就读期间，我接触到了两件令人难忘的技术：第一件是史蒂夫·乔布斯的NeXTcube，另一件是Tektronix(4400？)。运行Smalltalk-80的工作站。这两个都曾经是，现在仍然是令人惊叹的。我在NeXTcube的后代--MacBook Pro笔记本电脑上实现这个Smalltalk是再合适不过的了。</p><p>90年代末，我发现我在施乐帕洛帕克的英雄们重新组建了乐队，并释放了Squeak。我很高兴终于有了一个很好的系统来玩。但是，我并不在意外观和感觉，错过了我在Tektronix系统上体验到的极简主义。我还有一本蓝皮书和绿皮书，总是幻想着自己实现，但我无法访问使用的移植工具包。几年前，当我找到马里奥·沃尔奇科(Mario Wolczko)的网站http://www.wolczko.com/st80/时，情况发生了变化。他有施乐Release 2虚拟映像(从磁带上)，还有操作手册和蓝皮书中的手写Smalltalk源！他也有他的实现，这是用ANSI C之前编写的，但是，尽管花了很多小时，我还是无法运行任何东西。然后我开始考虑自己实现。</p><p>我知道这不是一件容易的事，因为书中无疑会有错误。我也知道C++喜欢从零开始索引数组，而Smalltalk从1开始，所以肯定会有差分错误(有)。SmallTalk的运算符优先级与C/C++不同，因此我也对此保持警惕(值得称赞的是，除了少数例外，表达式中使用了括号，这不是问题)。然后是引用计数，所以可能也会有引用计数错误(有)，最后内存是一堆16位字，所以您可能会意外地存储/获取错误的东西，而不会意识到这一点。最重要的是，Alto是大端系统，所以我必须决定如何处理(我按照Xerox指南的建议字节交换了虚拟映像--他们的指导很可靠，但他们忽略了字节交换浮点的需要)。</p><p>我从2019年12月下旬开始做这项工作，但几个月后才真正专注于这件事，直到科罗娜病毒来袭，我决定将自己隔离，以免将病毒传播给其他人。然后我认真地做了这件事。施乐移植工具包包括参考跟踪文件，您可以将其与您的系统进行比较。当我经过Trace2时，我感觉到一种难以置信的匆忙。在那之后，系统运行了一段时间，内存用完了。我不知道发生了什么(这是在我让展品正常工作之前)。为了获得可见性，我使用show：和error：选择器以及在堆栈上压入的看起来很大的字符串截取并记录了消息发送。果不其然，如果SmallTalk调试器能做到这一点，就会显示一个回溯字符串。但是，当屏幕被绘制成我可以转储到.pbm文件的形式时，我能够计算出我在哪里搞砸了，然后又感觉到了另一种快感，然后看看！之后，我使用SDL实现了对Smalltalk的主机图形支持，并实现了输入原语，这样我就有了一个可以正常工作的鼠标和键盘。我终于能够真正使用这个系统了。在这一点上，系统帮助我找到了其他问题！图形化的Smalltalk检查器和调试器真的帮我完成了繁重的任务，为我节省了无数个小时。该系统的弹性令人惊叹。</p><p>但是.。因为没有可用的文件系统支持(系统映像使用Alto文件系统类)，所以我只能在源浏览器中看到反编译的代码(这仍然非常有用，您可以对其进行编辑--只是它没有显示您实际使用的临时名称，您的注释也会丢失)。嗯，我必须决定该怎么做。我是否应该尝试模仿Alto文件系统？我决定不这样做，并遵循Tektronix在绿皮书中使用的方法--我将FileDirectory、File和Page子类化，并创建了PosiFileDirectory、PosiFile和PosiPage。我启动了VSCode并为它们编写了一个实现，我可以将其复制并粘贴到我的Smalltalk中(我添加了一种将剪贴板中的字符粘贴到输入队列中的方法)。实现这些之后，我对它们进行了测试，满意之后，我使用Smalltalk-80和Smalltalk-80的文件流创建了SourceFiles数组。</p><p>按照书来构建东西的好处是，有书记录了如何使用系统以及它是如何工作的！</p><p>您需要安装SDL 2.0.12或更高版本。您可以从http://libsdl.org.下载。选择开发库.dmg并安装。然后，进入OSX文件夹并键入make。然后，您应该能够执行以下操作：</p><p>请参阅下面的命令行选项部分了解这意味着什么。如果您愿意，可以打开一个Xcode项目。</p><p>我已经包含了SDL 2.0.12头文件/二进制文件，所以您需要做的就是在WINDOWS目录中打开项目并点击Run。</p><p>您需要安装SDL 2.0.12或更高版本。您可以转到http://libsdl.org下载并自己构建它，也可以使用包管理器安装它。</p><p>然后，cd进入该项目的Linux子目录并键入make。然后，您应该能够执行以下操作：</p><p>Smalltalk应用程序的行为可以通过每个模块的头文件中的#Define设置进行自定义。</p><p>对象Memory#定义确定要使用的垃圾收集方案(蓝皮书中描述的所有方法都可用)。</p><p>这本书描述了一个简单但消耗堆栈空间的递归标记算法。如果定义了此符号，则使用该算法。如果不是，则使用更复杂、更智能的指针反转方法。</p><p>GC_MARK_SWEEP和GC_REF_COUNT标志不是互斥的。如果两者都已定义(并且它们都已定义)，则将执行正常的引用计数，仅在内存耗尽或对象表已满时才执行完全垃圾回收。SmallTalk-80生成许多循环引用(例如，通过临时字段的MethodContext引用，通过发送者字段反向引用上下文的BlockContext)。Mark and Sweep Only方法将导致许多频繁的收集，因为在系统运行时，对象表将快速填充MethodContext和其他频繁分配的对象。因此，一些Smalltalk实现会回收上下文。</p><p>提供解释器#定义是为了允许包含/排除可选的原语以及一些有用的调试方法。如果未实现可选原语，则改为执行Smalltalk回退。这可能会对性能产生重大影响。</p><p>在Windows下运行时，我遇到了两个问题。首先，如果按住鼠标左键(例如，重新构建窗口时)，鼠标光标不会可靠地改变。第二个问题是，鼠标光标在高分辨率显示器上非常小，即使设置了系统缩放选项来补偿也是如此。出于这些原因，我添加了让应用程序呈现鼠标光标而不是操作系统的选项。可以定义SOFTWARE_MOUSE_CURSOR来执行此操作。如果它是Windows版本，我会有条件地设置它。它可以在其他平台上工作，但没有必要，因为它们在没有它的情况下可以正常运行。</p><p>Smalltalk应用程序接受许多参数。唯一必需的参数是-directory path，它指定可以找到快照映像的目录。以下是完整的名单：</p><p>指定包含快照图像以及Smalltalk-80.source和Smalltalk-80.change文件的目录。目录中的任何其他文件都可以使用正常的文件/目录访问方法从Smalltalk-80访问。</p><p>打开垂直同步以使帧速率与监视器刷新率同步。这可以消除屏幕撕裂和其他伪像，但代价是一些输入延迟。</p><p>如果不使用vsync，则可以在向GPU呈现下一帧之后指定延迟。这对于降低CPU使用率，同时仍然享受不使用vsync的好处非常有用</p><p>指定显示应加倍。对有远见的人或在非常高分辨率的显示器上运行的人很有帮助</p></div><div class="text-break sotry_link page_narrow"><a target="_blank" href="https://github.com/dbanay/Smalltalk">https://github.com/dbanay/Smalltalk</a></div><div class="story_tags page_narrow"><button type="button" class="btn btn-light my_tag"><a href="/tag/c++/">#c++</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/smalltalk/">#smalltalk</a></button></div></div><div class="shadow p-3 mb-5 bg-white rounded clearfix"><div class="container"><div class="row"><div class="col-sm"><div><a target="_blank" href="/story/1003557.html"><img src="http://img.diglog.com/img/2020/5/thumb_4d16095418a953c639be9666b70f5aac.jpg" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003557.html">用C++实现简单的协作线程</a></div><span class="my_story_list_date">2020-5-25 3:21</span></div><div class="col-sm"><div><a target="_blank" href="/story/1003482.html"><img src="http://img.diglog.com/img/2020/5/thumb_9cdf90156fcca1968e600440970c119f.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1003482.html">铬项目发现70%的安全缺陷是内存安全问题</a></div><span class="my_story_list_date">2020-5-24 12:26</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002790.html"><img src="http://img.diglog.com/img/2020/5/thumb_2f10de854733cdd09c639d0c7dbca922.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002790.html">将C++中的anyref支持添加到WebAssembly编译器</a></div><span class="my_story_list_date">2020-5-19 22:54</span></div><div class="col-sm"><div><a target="_blank" href="/story/1002283.html"><img src="http://img.diglog.com/img/2020/5/thumb_7245042964f260fe836d3ec31d4336d9.png" class="img-fluid" onerror="this.style.display='none'"></a></div><div class="item_title"><a target="_blank" href="/story/1002283.html">Tiny Differentiable Simulator是一个仅包含头文件的C++物理库</a></div><span class="my_story_list_date">2020-5-16 3:35</span></div></div></div></div><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/app/">#app</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/病毒/">#病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/冠状病毒/">#冠状病毒</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/程序/">#程序</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div></body></html>