<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>关于Vulkan的前缀SUM</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1>关于Vulkan的前缀SUM</h1><div class="row"><div class="col-lg-8 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time">2020-05-02 17:57:47</div><p>如今，在GPU上运行计算工作负载主要有两种方式。一个是CUDA，它有一个非常棒的生态系统，包括高度调优的库，但(实际上)与NVIDIA硬件捆绑在一起。另一种是主要用于游戏的图形API，它们在各种各样的硬件上运行，但在历史上提供的能力比CUDA小得多。此外，那个空间的计算工具也很糟糕。从历史上看，使用OpenCL也做了很多计算，但是它的未来是阴云密布的，因为它已经被正式.。</p><p>Vulkan在其原始功能方面一直在快速追赶，最近的扩展支持更高级的GPU计算功能，如子组、指针和内存模型。它是否已经到了可以运行严重计算工作负载的地步？</p><p>在这篇博客文章中，我们对在最近的Vulkan上实现前缀SUM进行了一些初步的探索。我有一个粗略的实现初稿，它表明Vulkan对于一个足够坚持不懈的实现者来说可能是一个可行的平台。</p><p>正如Hacker News用户Flffything在我的GPU计算演讲品味HN线程中指出的那样，前缀总和是评估GPU计算语言和运行时的一个很好的基准。</p><p>首先，它本身是有用的。我在font-rs中使用它来集成精确面积计算的片段，以得出字体呈现的总面积覆盖率。它还被用作更多操作中的原语，包括GPU端动态分配和压缩。</p><p>第二，这很简单。顺序版本可以仅用几行代码来表示：</p><p>def prefix_sum(A)：a：s+=x结果中x的def prefix_sum(A)：s=0 result=[]。追加返回结果。</p><p>对于三个人来说，在GPU上高效实现是具有挑战性的，但也是可能的。上面的代码具有严格的顺序依赖关系，但是因为加法是关联的，所以可以利用大量的并行性，这方面的文献可以追溯到几十年前。即便如此，在GPU上高效地利用这种并行性需要调用之间的通信(更常见的GPU术语中的“线程”)，并且需要仔细注意内存层次结构。</p><p>前缀SUM的泛化称为“扫描”，适用于任何关联操作，而不仅仅是加法。它甚至不必是可交换的；示例包括正则表达式和IIR过滤。更准确地说，可以使用任何么半群、具有标识元素的结构以及关联操作进行扫描；标识元素是扫描的“独占”变体所必需的，因为它是输出的第一个元素。</p><p>最先进的技术是解耦的回顾。我不打算在这里总结算法，但建议您阅读这篇论文。结果令人印象深刻-对于大型数据集，他们报告达到了memcpy的速度，这意味着不可能再有进一步的加速。</p><p>这项工作是对NVIDIA的GPU Gems3中的CUDA并行前缀求和(SCAN)的改进。产品级的开源实现是CUB。另一个设计为更易于访问但并未优化的实现是现代GPU扫描。</p><p>我自己的实现在很大程度上是一种研究质量的概念证明。它作为Piet-gpupository的前缀分支存在。基本上，我想确定是否有可能使用Vulkan计算内核来实现与memcpy性能近在咫尺的性能。它是解耦回顾论文的一个相当简单的实现，并没有实现所有的技巧。例如，回顾是完全按顺序进行的；我没有按照建议将回顾并行化。</p><p>这个实现已经够粗糙的了，我还不想做仔细的性能评估，但初步结果是令人鼓舞的：在GTX 1080上计算64-32位无符号整数的前缀和需要2.05ms的GPU时间，速度为312亿个元素/秒。由于每个元素涉及读取和写入4个字节，这对应于大约262GiB/s的原始内存带宽。理论内存带宽列出为320 GB/s，因此很明显代码能够.。</p><p>“现代C++”的成就之一是C++11内存模型。在过去，C和C++中的无锁编程模式的机制是Volatil限定符和各种非标准的障碍内部函数。人们从操作上对此进行了推论--Volatile的主要功能是禁用某些优化，而屏障内部函数会编译成内存围栏指令，这通常会导致硬件刷新缓存。</p><p>今天，大多数无锁爱好者认为那个时代是野蛮的。为了多线程的目的，从来没有清楚地定义易失性的语义(尽管人们还是使用它，因为它看起来很有用)，并且屏障指令具有特定于硬件的令人不安的属性。因为x86有“总存储顺序”，所以发布安全通常不需要屏障指令。然而，同样的代码在，</p><div class="sotry_link"><a target="_blank" href="https://raphlinus.github.io/gpu/2020/04/30/prefix-sum.html">https://raphlinus.github.io/gpu/2020/04/30/prefix-sum.html</a></div><div class="story_tags"><button type="button" class="btn btn-light my_tag"><a href="/tag/hardware/">#hardware</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/实现/">#实现</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/gpu/">#gpu</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/subgroup/">#subgroup</a></button></div></div></div><div class="col-lg-4 col-0"><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/百度/">#百度</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搜索/">#搜索</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/科学/">#科学</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/flash/">#flash</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/人像/">#人像</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/互联网/">#互联网</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/动物/">#动物</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/logo/">#logo</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/在线/">#在线</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/twitter/">#twitter</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/浏览器/">#浏览器</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/电影/">#电影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搜索引擎/">#搜索引擎</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/雷人/">#雷人</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/腾讯/">#腾讯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/日本/">#日本</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搞笑/">#搞笑</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/css/">#css</a></button></div></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div><script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script></body></html>