<!doctype html><html lang="zh-hans"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>RISC-V中的冒险</title><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><link rel="stylesheet" href="/img/css.css?random="><link data-rh="true" rel="icon" href="/img/favicon.ico"/><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?03c1a0f31299b4a2fbb83c34d6beaac9";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script></head><body><div id="my_header"><div class="container"><nav class="navbar navbar-expand-lg"><a class="navbar-brand" href="/"><img alt="diglog" src="/img/logo.v1.gif" class="rounded-sm"></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNavAltMarkup"><div class="navbar-nav"></div></div></nav></div></div><div class="container"><div id="my_content"><h1>RISC-V中的冒险</h1><div class="row"><div class="col-lg-8 col-12"><div class="my_story_list_item shadow p-3 mb-5 bg-white rounded"><div class="story_page_pub_time">2020-05-02 17:55:25</div><p>最近，我厌倦了每天在工作中埋头苦干。我已经决定尝试一些低级的东西，我听过很多人谈论这个叫做RISC-V的新的伟大的架构，我一直喜欢低级的东西，所以我决定尝试一下它。</p><p>顾名思义，RISC-V是一种RISC架构，它只有几条指令，并且被设计成可扩展的。您可以使用基本实现做任何事情，但是由于它非常有限，大多数实现都使用扩展来添加附加功能(如整数乘法)。可以在此处找到分机列表。这使得ISA非常容易实现和为其实现软件。</p><p>在这篇文章中，我将解释从汇编语言到c语言需要什么，并打印一条hello world消息。</p><p>当RISC-V CPU启动时，其所有HART(硬件线程)从地址0x80000000开始执行代码。理论上，我们只需写入UART地址就可以将内容显示在屏幕上，但是由于我不喜欢编写大量的汇编，所以让我们先跳到C，然后显示我们的消息。要跳转到C，我们需要设置堆栈并停放除一个之外的所有HART。为每个HART和PARKS不需要的HART设置堆栈的整个汇编代码如下所示：</p><p>.equSTACK_SIZE，1024.global_start_start：#Setup Stacks Per HART csrr t0，mhartid#读取当前HART ID slli t0，t0，10#将HART ID左移1024la sp，stacks+STACK_SIZE#将初始堆栈指针#设置到堆栈空间的末尾add sp，sp，t0#将当前HART堆栈指针#移动到其在堆栈空间中的位置#具有ID！=0 csrr a0的公园Harts，我们不在HART 0上#我们停HART j回车#跳到cpark：WFI j…。</p><p>在liker脚本中，我们告诉链接器将_start符号放在0x80000000，Enter符号是我们在C中的入口点。</p><p>太棒了！我们用C语言，因为我们将使用QEMU来运行代码，获得IO的最简单的方法是使用UART，这是一个相当大的标准，我可以写一整篇关于它的文章，但是现在我们只需要知道，根据QEMU的源代码，它的内存映射在地址0x10000000，写入它会让事情出现在屏幕上。</p><p>UART有一些寄存器来控制它，目前我们只关心位于距UART基地址偏移0x05处的线路状态寄存器(或LSR)(寄存器的完整列表可以在这里找到)。LSR可以告诉我们是否可以将数据写入UART缓冲区，这个寄存器的可能值在这里。</p><p>static int putchar(Uint8_T Ch){static uint8_t thr=0x00；static uint8_t lsr=0x05；static uint8_t lsr_ri=0x40；while((UART[lsr]&amp；lsr_ri)==0)；return UART[thr]=ch；}。</p><p>UART变量被全局定义为易失性变量，因此编译器不会试图将其优化出来。</p><p>因为这段代码只写一个字符，所以我们需要创建一个帮助器函数来写整行。</p><p>现在我们可以调用看跌期权，希望我们能在屏幕上看到一些东西：</p><p>tyfinf unsign char uint8_t；static volatiluint8_t*uart=(void*)0x10000000；static int putchar(Char Ch){static uint8_t thr=0x00；static uint8_t lsr=0x05；static uint8_t lsr_ri=0x40；while((UART[lsr]&amp；lsr_ri)==0)；返回UART[thr]=。putchar(&#39；\n&#39；)；}void enter(){put(&#34；Hello RISC-V&#34；)；}。</p><p>我们可以使用GCC riscv64-UNKNOWN-ELF-GCC-MARCH=rv32imac-mabi=ilp32-T default.lds-o out-nostdlib-fno-builtin start.s main.c编译它。s start.s是我们的汇编源，main.c是我们的c代码。</p><p>这应该会产生一个名为out的文件，该文件可以使用qemu运行：qemu-system-riscv32-noraphic-smp 4-Machine virt-bios non-kernel out。</p><p>这可能不是很多，但对于编写整个内核来说，这是一个很好的开始。在未来，我将很乐意介绍如下内容：中断内存管理、非特权ISA。</p><div class="sotry_link"><a target="_blank" href="https://matrix89.github.io/writes/writes/experiments-in-riscv/">https://matrix89.github.io/writes/writes/experiments-in-riscv/</a></div><div class="story_tags"><button type="button" class="btn btn-light my_tag"><a href="/tag/start/">#start</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/hart/">#hart</a></button><button type="button" class="btn btn-light my_tag"><a href="/tag/uart/">#uart</a></button></div></div></div><div class="col-lg-4 col-0"><div class="my_movie_list_item shadow p-3 mb-5 bg-white rounded"><button type="button" class="btn btn-link my_tag"><a href="/tag/web2.0/">#web2.0</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/google/">#google</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/设计/">#设计</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/创意/">#创意</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/摄影/">#摄影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/图片/">#图片</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/游戏/">#游戏</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/手机/">#手机</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/视频/">#视频</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/广告/">#广告</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/iphone/">#iphone</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/网站/">#网站</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/软件/">#软件</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/下载/">#下载</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/免费/">#免费</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/windows/">#windows</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/微软/">#微软</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/blog/">#blog</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/苹果/">#苹果</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/博客/">#博客</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/firefox/">#firefox</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/音乐/">#音乐</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/恶搞/">#恶搞</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/qq/">#qq</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/wordpress/">#wordpress</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/艺术/">#艺术</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/百度/">#百度</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搜索/">#搜索</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/谷歌/">#谷歌</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/分享/">#分享</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/工具/">#工具</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/web/">#web</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/apple/">#apple</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/科学/">#科学</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/flash/">#flash</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/人像/">#人像</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/互联网/">#互联网</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/动物/">#动物</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/logo/">#logo</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/在线/">#在线</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/twitter/">#twitter</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/浏览器/">#浏览器</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/linux/">#linux</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/电影/">#电影</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搜索引擎/">#搜索引擎</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/雷人/">#雷人</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/腾讯/">#腾讯</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/日本/">#日本</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/搞笑/">#搞笑</a></button><button type="button" class="btn btn-link my_tag"><a href="/tag/css/">#css</a></button></div></div></div></div><div id="my_footer"><div class=""><a href="/tags/">tags</a> <a href="/users/">users</a></div>&copy; 2020 diglog.com </div></div><script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script></body></html>